<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>sdmTMB Sardine eggs Bay of biscay</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="sdmTMB_sardine_BoB_files/libs/clipboard/clipboard.min.js"></script>
<script src="sdmTMB_sardine_BoB_files/libs/quarto-html/quarto.js"></script>
<script src="sdmTMB_sardine_BoB_files/libs/quarto-html/popper.min.js"></script>
<script src="sdmTMB_sardine_BoB_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="sdmTMB_sardine_BoB_files/libs/quarto-html/anchor.min.js"></script>
<link href="sdmTMB_sardine_BoB_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="sdmTMB_sardine_BoB_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="sdmTMB_sardine_BoB_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="sdmTMB_sardine_BoB_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="sdmTMB_sardine_BoB_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#load-libraries-and-data" id="toc-load-libraries-and-data" class="nav-link active" data-scroll-target="#load-libraries-and-data">Load libraries and data</a>
  <ul>
  <li><a href="#a-quick-map-of-your-row-data" id="toc-a-quick-map-of-your-row-data" class="nav-link" data-scroll-target="#a-quick-map-of-your-row-data">A quick map of your row data</a></li>
  <li><a href="#a-quick-map-of-your-final-data" id="toc-a-quick-map-of-your-final-data" class="nav-link" data-scroll-target="#a-quick-map-of-your-final-data">A quick map of your final data</a></li>
  </ul></li>
  <li><a href="#prepare-grid-for-prediction" id="toc-prepare-grid-for-prediction" class="nav-link" data-scroll-target="#prepare-grid-for-prediction">Prepare grid for prediction</a></li>
  <li><a href="#create-the-mesh" id="toc-create-the-mesh" class="nav-link" data-scroll-target="#create-the-mesh">Create the mesh</a></li>
  <li><a href="#model-1-m1-spatial-model-non-spatio-temporal-term" id="toc-model-1-m1-spatial-model-non-spatio-temporal-term" class="nav-link" data-scroll-target="#model-1-m1-spatial-model-non-spatio-temporal-term">MODEL 1 (m<sub>1</sub>) : Spatial model (non spatio-temporal term)</a>
  <ul>
  <li><a href="#fit-the-model" id="toc-fit-the-model" class="nav-link" data-scroll-target="#fit-the-model">Fit the model</a></li>
  <li><a href="#results-of-the-fit" id="toc-results-of-the-fit" class="nav-link" data-scroll-target="#results-of-the-fit">Results of the fit</a>
  <ul class="collapse">
  <li><a href="#confidence-intervals-of-fixed-effects" id="toc-confidence-intervals-of-fixed-effects" class="nav-link" data-scroll-target="#confidence-intervals-of-fixed-effects">Confidence intervals of fixed effects</a></li>
  <li><a href="#confidence-intervals-of-random-effect-and-variance-parameters" id="toc-confidence-intervals-of-random-effect-and-variance-parameters" class="nav-link" data-scroll-target="#confidence-intervals-of-random-effect-and-variance-parameters">Confidence intervals of random effect and variance parameters</a></li>
  </ul></li>
  <li><a href="#diagnostics" id="toc-diagnostics" class="nav-link" data-scroll-target="#diagnostics">Diagnostics</a></li>
  <li><a href="#prediction" id="toc-prediction" class="nav-link" data-scroll-target="#prediction">Prediction</a>
  <ul class="collapse">
  <li><a href="#full-fixed-and-random-effects-model-m1-prediction" id="toc-full-fixed-and-random-effects-model-m1-prediction" class="nav-link" data-scroll-target="#full-fixed-and-random-effects-model-m1-prediction">Full (fixed and random effects) model m<sub>1</sub> prediction</a></li>
  <li><a href="#fixed-effect-in-the-of-prediction-model-m1" id="toc-fixed-effect-in-the-of-prediction-model-m1" class="nav-link" data-scroll-target="#fixed-effect-in-the-of-prediction-model-m1">Fixed effect in the of prediction model m<sub>1</sub></a></li>
  <li><a href="#random-effect-in-the-prediction-of-model-m1" id="toc-random-effect-in-the-prediction-of-model-m1" class="nav-link" data-scroll-target="#random-effect-in-the-prediction-of-model-m1">Random effect in the prediction of model m<sub>1</sub></a></li>
  </ul></li>
  </ul></li>
  <li><a href="#model-2-m2-spatiotemporal-model" id="toc-model-2-m2-spatiotemporal-model" class="nav-link" data-scroll-target="#model-2-m2-spatiotemporal-model">MODEL 2 (m<sub>2</sub>) : Spatiotemporal model</a>
  <ul>
  <li><a href="#fit-the-model-1" id="toc-fit-the-model-1" class="nav-link" data-scroll-target="#fit-the-model-1">Fit the model</a></li>
  <li><a href="#results-of-the-fit-1" id="toc-results-of-the-fit-1" class="nav-link" data-scroll-target="#results-of-the-fit-1">Results of the fit</a>
  <ul class="collapse">
  <li><a href="#confidence-intervals-of-fixed-effects-1" id="toc-confidence-intervals-of-fixed-effects-1" class="nav-link" data-scroll-target="#confidence-intervals-of-fixed-effects-1">Confidence intervals of fixed effects</a></li>
  <li><a href="#confidence-intervals-of-random-effects-and-variance-parameters" id="toc-confidence-intervals-of-random-effects-and-variance-parameters" class="nav-link" data-scroll-target="#confidence-intervals-of-random-effects-and-variance-parameters">Confidence intervals of random effects and variance parameters</a></li>
  </ul></li>
  <li><a href="#diagnostics-1" id="toc-diagnostics-1" class="nav-link" data-scroll-target="#diagnostics-1">Diagnostics</a></li>
  <li><a href="#prediction-1" id="toc-prediction-1" class="nav-link" data-scroll-target="#prediction-1">Prediction</a>
  <ul class="collapse">
  <li><a href="#full-fixed-and-random-effects-model-m2-prediction" id="toc-full-fixed-and-random-effects-model-m2-prediction" class="nav-link" data-scroll-target="#full-fixed-and-random-effects-model-m2-prediction">Full (fixed and random effects) model m<sub>2</sub> prediction</a></li>
  <li><a href="#fixed-effect-in-the-prediction-of-model-m2" id="toc-fixed-effect-in-the-prediction-of-model-m2" class="nav-link" data-scroll-target="#fixed-effect-in-the-prediction-of-model-m2">Fixed effect in the prediction of model m<sub>2</sub></a></li>
  <li><a href="#random-effects-in-the-prediction-of-model-m2" id="toc-random-effects-in-the-prediction-of-model-m2" class="nav-link" data-scroll-target="#random-effects-in-the-prediction-of-model-m2">Random effects in the prediction of model m<sub>2</sub></a></li>
  </ul></li>
  </ul></li>
  <li><a href="#model-3-m3-spatiotemporal-model-with-covariates." id="toc-model-3-m3-spatiotemporal-model-with-covariates." class="nav-link" data-scroll-target="#model-3-m3-spatiotemporal-model-with-covariates.">MODEL 3 (m<sub>3</sub>) : Spatiotemporal model with covariates.</a>
  <ul>
  <li><a href="#prepare-the-data" id="toc-prepare-the-data" class="nav-link" data-scroll-target="#prepare-the-data">Prepare the data</a></li>
  <li><a href="#create-the-mesh-1" id="toc-create-the-mesh-1" class="nav-link" data-scroll-target="#create-the-mesh-1">Create the mesh</a></li>
  <li><a href="#create-the-prediction-grid" id="toc-create-the-prediction-grid" class="nav-link" data-scroll-target="#create-the-prediction-grid">Create the prediction grid</a>
  <ul class="collapse">
  <li><a href="#model-temp-mtemp-spatio-temoral-model-for-temperature" id="toc-model-temp-mtemp-spatio-temoral-model-for-temperature" class="nav-link" data-scroll-target="#model-temp-mtemp-spatio-temoral-model-for-temperature"><strong>MODEL Temp (m~temp) : Spatio-temoral model for temperature</strong></a></li>
  </ul></li>
  <li><a href="#fit-the-model-m3" id="toc-fit-the-model-m3" class="nav-link" data-scroll-target="#fit-the-model-m3">Fit the model m<sub>3</sub></a></li>
  <li><a href="#results-of-the-fit-3" id="toc-results-of-the-fit-3" class="nav-link" data-scroll-target="#results-of-the-fit-3">Results of the fit</a>
  <ul class="collapse">
  <li><a href="#confidence-intervals-of-fixed-effects-3" id="toc-confidence-intervals-of-fixed-effects-3" class="nav-link" data-scroll-target="#confidence-intervals-of-fixed-effects-3">Confidence intervals of fixed effects</a></li>
  <li><a href="#confidence-intervals-of-random-effects-and-variance-parameters-2" id="toc-confidence-intervals-of-random-effects-and-variance-parameters-2" class="nav-link" data-scroll-target="#confidence-intervals-of-random-effects-and-variance-parameters-2">Confidence intervals of random effects and variance parameters</a></li>
  </ul></li>
  <li><a href="#diagnostics-3" id="toc-diagnostics-3" class="nav-link" data-scroll-target="#diagnostics-3">Diagnostics</a></li>
  <li><a href="#prediction-3" id="toc-prediction-3" class="nav-link" data-scroll-target="#prediction-3">Prediction</a>
  <ul class="collapse">
  <li><a href="#full-fixed-and-random-effects-model-m3-prediction" id="toc-full-fixed-and-random-effects-model-m3-prediction" class="nav-link" data-scroll-target="#full-fixed-and-random-effects-model-m3-prediction">Full (fixed and random effects) model m<sub>3</sub> prediction</a></li>
  <li><a href="#fixed-effects-in-the-prediction-of-model-m3" id="toc-fixed-effects-in-the-prediction-of-model-m3" class="nav-link" data-scroll-target="#fixed-effects-in-the-prediction-of-model-m3">Fixed effects in the prediction of model m<sub>3</sub></a></li>
  <li><a href="#random-effects-in-the-prediction-of-model-m3---here-spatial-spatiotemporal-random-effects" id="toc-random-effects-in-the-prediction-of-model-m3---here-spatial-spatiotemporal-random-effects" class="nav-link" data-scroll-target="#random-effects-in-the-prediction-of-model-m3---here-spatial-spatiotemporal-random-effects">Random effects in the prediction of model m<sub>3</sub> - here spatial &amp; spatiotemporal random effects</a></li>
  <li><a href="#visualize-the-effect-of-the-smoothed-covariate-temperature." id="toc-visualize-the-effect-of-the-smoothed-covariate-temperature." class="nav-link" data-scroll-target="#visualize-the-effect-of-the-smoothed-covariate-temperature.">Visualize the effect of the smoothed covariate Temperature.</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#prepare-more-covariates-for-more-models-." id="toc-prepare-more-covariates-for-more-models-." class="nav-link" data-scroll-target="#prepare-more-covariates-for-more-models-.">Prepare more covariates for more models ….</a>
  <ul>
  <li><a href="#model-prof-prof-model-spatio-temporel-de-covariables" id="toc-model-prof-prof-model-spatio-temporel-de-covariables" class="nav-link" data-scroll-target="#model-prof-prof-model-spatio-temporel-de-covariables">MODEL prof (Prof) : Model spatio-temporel de Covariables</a>
  <ul class="collapse">
  <li><a href="#prepare-covariable" id="toc-prepare-covariable" class="nav-link" data-scroll-target="#prepare-covariable">Prepare covariable</a></li>
  <li><a href="#create-the-mesh-2" id="toc-create-the-mesh-2" class="nav-link" data-scroll-target="#create-the-mesh-2">Create the mesh</a></li>
  <li><a href="#fit-the-model-3" id="toc-fit-the-model-3" class="nav-link" data-scroll-target="#fit-the-model-3">Fit the model</a></li>
  <li><a href="#results-of-the-fit-4" id="toc-results-of-the-fit-4" class="nav-link" data-scroll-target="#results-of-the-fit-4">Results of the fit</a></li>
  <li><a href="#diagnostics-4" id="toc-diagnostics-4" class="nav-link" data-scroll-target="#diagnostics-4">Diagnostics</a></li>
  <li><a href="#prediction-4" id="toc-prediction-4" class="nav-link" data-scroll-target="#prediction-4">Prediction</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">sdmTMB Sardine eggs Bay of biscay</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="load-libraries-and-data" class="level3">
<h3 class="anchored" data-anchor-id="load-libraries-and-data">Load libraries and data</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>variable<span class="ot">=</span><span class="st">'Sp10m3'</span>; species<span class="ot">=</span><span class="st">'Sardine'</span>; ccolor<span class="ot">=</span><span class="st">'blue'</span>;maxvalue<span class="ot">=</span><span class="dv">200</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>listyears<span class="ot">=</span><span class="fu">c</span>(<span class="dv">2000</span><span class="sc">:</span><span class="dv">2019</span>,<span class="dv">2021</span><span class="sc">:</span><span class="dv">2024</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>file.data<span class="ot">=</span><span class="st">'DataEggs/Cufes_spring_ifremer.txt'</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>data.eggs<span class="ot">=</span><span class="fu">read.table</span>(<span class="at">file=</span>file.data,<span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,<span class="at">header=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="a-quick-map-of-your-row-data" class="level4">
<h4 class="anchored" data-anchor-id="a-quick-map-of-your-row-data">A quick map of your row data</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data.eggs_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(data.eggs, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Long"</span>, <span class="st">"Lat"</span>), <span class="at">crs =</span> <span class="st">"WGS84"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>plot_eggs <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> data.eggs_sf) <span class="sc">+</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">color =</span> Sp10m3), <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Year) <span class="sc">+</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>, <span class="at">na.value =</span> <span class="st">"grey80"</span>,   <span class="at">name =</span> <span class="fu">expression</span>(<span class="st">"Log(Eggs/10m³)</span><span class="sc">\n</span><span class="st"> grays are zero"</span>)) <span class="sc">+</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtitle</span>(<span class="st">"Total Sardine eggs"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>plot_eggs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Those are the row data of eggs from PELGAS survey for years 2000-2024 (1 year -2020- gap). Eggs are collected using CUFES at 5m depth, every 3nmi (5.556Km) at transects with inter-transect distance of 12nmi (22.22Km).</p>
<p>Sp10m3 &amp; Ee10m3: total eggs <strong>density</strong> (no eggs/ 10m <sup>3</sup> ) for sardine and anchovy respectively.</p>
<p>Sp1,2,3 &amp; Ee1,2,3: the <strong>number</strong> of eggs or sardine and anchovy respectively for specific stages.</p>
<p>Group1: no embryo, egg stages (1-3)</p>
<p>Group2: early embryo, egg stages (4-6)</p>
<p>Group3: late embryo, egg stages (7-11).</p>
<p>Sonde(depth), Ventvrai, Dirventvrm, Tempsbe Salinite, chlorophyl,</p>
<p><em>We have to think:</em></p>
<ul>
<li><p><em>The vertical distribution of eggs</em></p></li>
<li><p><em>Eggs cohorts (Total eggs, group1, aging and Po) <span class="citation" data-cites="petitgas2009">[@petitgas2009]</span></em> at least remove the effect of temperature by standardizing with stage duration time (Renger et al 1985)</p></li>
</ul>
<section id="we-removed-data-at-the-north-of-48n" class="level6">
<h6 class="anchored" data-anchor-id="we-removed-data-at-the-north-of-48n">We removed data at the north of 48°N</h6>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data.eggs<span class="ot">&lt;-</span> data.eggs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Lat <span class="sc">&lt;</span> <span class="dv">48</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(Sp10m3)<span class="sc">==</span>F) <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Year=</span><span class="fu">as.factor</span>(Year), <span class="at">time=</span><span class="fu">as.integer</span>(Year))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>data.eggs <span class="ot">&lt;-</span> <span class="fu">add_utm_columns</span>(data.eggs, <span class="fu">c</span>(<span class="st">"Long"</span>, <span class="st">"Lat"</span>), <span class="at">ll_crs =</span> <span class="dv">4326</span>, <span class="at">units =</span> <span class="st">"km"</span>)   <span class="co">#Project coordinates to Km</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Proceeding with UTM zone 30N; CRS = 32630.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Visit https://epsg.io/32630 to verify.</code></pre>
</div>
</div>
</section>
</section>
<section id="a-quick-map-of-your-final-data" class="level4">
<h4 class="anchored" data-anchor-id="a-quick-map-of-your-final-data">A quick map of your final data</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>data.eggs_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(data.eggs, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Long"</span>, <span class="st">"Lat"</span>), <span class="at">crs =</span> <span class="st">"WGS84"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>plot_eggs <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> data.eggs_sf) <span class="sc">+</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">color =</span> Sp10m3), <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Year) <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>, <span class="at">na.value =</span> <span class="st">"grey80"</span>,   <span class="at">name =</span> <span class="fu">expression</span>(<span class="st">"Log(Eggs/10m³)</span><span class="sc">\n</span><span class="st"> grays are zero"</span>)) <span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtitle</span>(<span class="st">"Total Sardine eggs"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>plot_eggs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="prepare-grid-for-prediction" class="level3">
<h3 class="anchored" data-anchor-id="prepare-grid-for-prediction">Prepare grid for prediction</h3>
<p>We are going to need another grid in which we will predict the eggs abundance using the final model.<br>
The prediction grid has to be replicated for the years included in the study; it also needs to have all the covariates that were used in the model. To have these variables in the spatial resolution of the prediction grid instead of an classic interpolation here we use same approach as<span class="citation" data-cites="lindmark2023">[@lindmark2023]</span> .</p>
<p>Based on than approach you built a simple spatio-temporal model for each covariate (ex. m_temperature: μ<sub>s,t</sub>= β<sub>t</sub>+ ω<sub>s</sub> +ε<sub>s,t</sub>) of your final model and you use that model (m_temperature) to predict the variable (here temperature) in the resolution of the prediction grid. You repeat that process for all your covariates.</p>
<p>So, finaly you will you have the final prediction grid, which has information of all the fixed covariates included in your final model in the spatial resolution of the prediction grid.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Insert the grid</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>projection_grid <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"./DataEggs/user_region.rds"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>projection_grid_UTM <span class="ot">&lt;-</span> <span class="fu">add_utm_columns</span>(projection_grid, <span class="fu">c</span>(<span class="st">"Lon"</span>, <span class="st">"Lat"</span>), <span class="at">ll_crs =</span> <span class="dv">4326</span>, <span class="at">units =</span> <span class="st">"km"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Detected UTM zone 30N; CRS = 32630.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Visit https://epsg.io/32630 to verify.</code></pre>
</div>
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(projection_grid_UTM<span class="sc">$</span>X,projection_grid_UTM<span class="sc">$</span>Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Replicate the grid across year</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>grid_yrs <span class="ot">&lt;-</span> <span class="fu">replicate_df</span>(projection_grid_UTM, <span class="fu">c</span>(<span class="st">"Year"</span>), <span class="fu">as.factor</span>(<span class="fu">unique</span>(data.eggs<span class="sc">$</span>Year))) <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time=</span><span class="fu">as.integer</span>(Year))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="create-the-mesh" class="level3">
<h3 class="anchored" data-anchor-id="create-the-mesh">Create the mesh</h3>
<p>In these kinds of models, the spatial (ω<sub>s</sub>) and the spatiotemporal (ε<sub>s,t</sub>) variations (and potentially any spatial varying coefficient) are modeled as Gaussian Random Fields (GRF), where the random effects describing the spatial patterns are assumed to be drawn from a multivariate normal distribution MVNormal (0,Σ). Estimating this covariance matrix (Σ) is computational demanding, so the SPDE approach is used to approximate the Gaussian random fields.</p>
<p>For the SPDE approximation approach you need another grid called the <strong>mesh</strong> which is a triangulated mesh with Knots. These Knots are used to approximate the spatial variability in your data and because the number of Knots &lt;&lt; number of data points the computation of the covariance is easier. The Matern correlation is used as a covariance function to account for spatial autocorrelation.</p>
<p><em>Maybe more discussion in how you contract the mesh (ex. who many Knots you need)</em></p>
<p>So, so far we have three grids with different spatial resolution :</p>
<ul>
<li><p>The data grid (your sampling points, those data are used to estimate fixed parameres)</p></li>
<li><p>The mesh (for the Gaussian Random Fields approximation)</p></li>
<li><p>The prediction grid ( for predictions using your final model).</p>
<p>So the mesh is:</p></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>mesh <span class="ot">&lt;-</span> <span class="fu">make_mesh</span>(data.eggs, <span class="at">xy_cols =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), <span class="at">cutoff =</span> <span class="dv">30</span>)  <span class="co"># cutoff: minimum distance between knots before a new mesh vertex is added- units as in your dataset</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mesh)                                                     </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-1-m1-spatial-model-non-spatio-temporal-term" class="level2">
<h2 class="anchored" data-anchor-id="model-1-m1-spatial-model-non-spatio-temporal-term">MODEL 1 (m<sub>1</sub>) : Spatial model (non spatio-temporal term)</h2>
<p>The first model (m<sub>1</sub>) follows that formula:</p>
<p>μ<sub>s,t</sub>= exp(β<sub>t</sub>+ ω<sub>s</sub>),</p>
<p>μ<sub>s,t</sub>= log(y<sub>s,t</sub> ),</p>
<p>y<sub>s,t</sub> ~ Tweedie (μ<sub>s,t</sub> ,p, φ) , ω~ MVNormal (0,Σ<sub>ω</sub>)</p>
<p>where the modeled egg density (μ<sub>s,t</sub>) follows the Tweedie distribution with a log link function, as egg density is positive, continuous and contains zeros.</p>
<p>y<sub>s,t</sub> represents eggs density (no of eggs/10m<sup>2</sup>) at space (s) and time(t), μ is the mean density at time and space and p, φ represent power and dispersion parameters of the Tweedie distribution, respectively.</p>
<p>β<sub>t</sub> are the fixed effects for factor(Year), they represent the average temporal variation</p>
<p>ω<sub>s</sub> is the spatial random effect, drawn from a GRF with covarianvce matrix Σ<sub>ω</sub> using Maretn correlation function. It represents the average spatial pattern (nich effect) and it also accounts for spatial variation that is not accounted for by our fixed effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting biomass density but are not accounted for in the model.</p>
<section id="fit-the-model" class="level3">
<h3 class="anchored" data-anchor-id="fit-the-model">Fit the model</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fit_m1 <span class="ot">&lt;-</span> <span class="fu">sdmTMB</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  Sp10m3 <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Year,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data.eggs,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mesh =</span> mesh,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">tweedie</span>(<span class="at">link =</span> <span class="st">"log"</span>),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatial =</span> <span class="st">"on"</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="results-of-the-fit" class="level3">
<h3 class="anchored" data-anchor-id="results-of-the-fit">Results of the fit</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>fit_m1  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Spatial model fit by ML ['sdmTMB']
Formula: Sp10m3 ~ 0 + Year
Mesh: mesh (isotropic covariance)
Data: data.eggs
Family: tweedie(link = 'log')
 
         coef.est coef.se
Year2000     2.73    1.52
Year2001     1.07    1.52
Year2002     1.41    1.52
Year2003    -0.07    1.52
Year2004     1.49    1.52
Year2005     1.86    1.52
Year2006     1.45    1.52
Year2007     0.62    1.52
Year2008     1.15    1.52
Year2009     1.23    1.52
Year2010     1.16    1.52
Year2011     1.46    1.52
Year2012     1.15    1.52
Year2013     1.20    1.52
Year2014     1.27    1.52
Year2015     0.43    1.52
Year2016     0.66    1.52
Year2017     0.56    1.52
Year2018     0.48    1.52
Year2019     0.44    1.52
Year2021     0.37    1.52
Year2022     0.68    1.52
Year2023     0.17    1.52
Year2024    -0.31    1.52

Dispersion parameter: 9.49
Tweedie p: 1.66
Matérn range: 174.89
Spatial SD: 3.36
ML criterion at convergence: 48187.087

See ?tidy.sdmTMB to extract these values as a data frame.</code></pre>
</div>
</div>
<section id="confidence-intervals-of-fixed-effects" class="level4">
<h4 class="anchored" data-anchor-id="confidence-intervals-of-fixed-effects">Confidence intervals of fixed effects</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fix_effects<span class="ot">&lt;-</span> <span class="fu">tidy</span>(fit_m1, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>fix_effects</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24 × 5
   term     estimate std.error conf.low conf.high
   &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Year2000   2.73        1.52   -0.247      5.70
 2 Year2001   1.07        1.52   -1.91       4.04
 3 Year2002   1.41        1.52   -1.56       4.39
 4 Year2003  -0.0683      1.52   -3.05       2.91
 5 Year2004   1.49        1.52   -1.49       4.46
 6 Year2005   1.86        1.52   -1.11       4.84
 7 Year2006   1.45        1.52   -1.53       4.42
 8 Year2007   0.618       1.52   -2.36       3.60
 9 Year2008   1.15        1.52   -1.83       4.12
10 Year2009   1.23        1.52   -1.74       4.21
# ℹ 14 more rows</code></pre>
</div>
</div>
</section>
<section id="confidence-intervals-of-random-effect-and-variance-parameters" class="level4">
<h4 class="anchored" data-anchor-id="confidence-intervals-of-random-effect-and-variance-parameters">Confidence intervals of random effect and variance parameters</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>random_effects<span class="ot">&lt;-</span> <span class="fu">tidy</span>(fit_m1, <span class="at">effects =</span> <span class="st">"ran_pars"</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>random_effects</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 5
  term      estimate std.error conf.low conf.high
  &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 range       175.    43.4       108.      285.  
2 phi           9.49   0.0991      9.29      9.68
3 sigma_O       3.36   0.618       2.34      4.81
4 tweedie_p     1.66   0.00321     1.66      1.67</code></pre>
</div>
</div>
<p>Other than the effect of the spatial random field you have: :</p>
<ul>
<li><p>Matérn range: the distance at witch you have no correlation - similar to the variogram range</p></li>
<li><p>phi (φ) &amp; tweedie_p (p): the dispersion parameter and the power of the Tweedie distribution, respectively.</p></li>
</ul>
<section id="plot-the-all-the-effects" class="level5">
<h5 class="anchored" data-anchor-id="plot-the-all-the-effects">Plot the all the effects</h5>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> fix_effects, <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> term, <span class="at">col =</span> term)) <span class="sc">+</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data =</span> fix_effects, <span class="fu">aes</span>(<span class="at">y =</span> term, <span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high, <span class="at">color =</span> term), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span>  </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> random_effects <span class="sc">%&gt;%</span> <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"sigma_O"</span>), <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> term)) <span class="sc">+</span>  </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data =</span> random_effects <span class="sc">%&gt;%</span> <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"sigma_O"</span>), <span class="fu">aes</span>(<span class="at">y =</span> term, <span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span>  </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>( <span class="at">title =</span> <span class="fu">expression</span>(<span class="st">"Mean and 95% confidence intervals of the fixed &amp; random effects,"</span> <span class="sc">~</span> m[<span class="dv">1</span>]),       </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="fu">expression</span>(mu[s<span class="sc">~</span>t] <span class="sc">~</span> <span class="st">"="</span> <span class="sc">~</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s]))) <span class="sc">+</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can see that the effect of spatial term is the most “important” one. Space is the more influential parameter in egg distribution in this model.</p>
</section>
</section>
</section>
<section id="diagnostics" class="level3">
<h3 class="anchored" data-anchor-id="diagnostics">Diagnostics</h3>
<p>What do you check?</p>
<p>Residuals?</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sanity</span>(fit_m1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Non-linear minimizer suggests successful convergence</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Hessian matrix is positive definite</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No extreme or very small eigenvalues detected</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No gradients with respect to fixed effects are &gt;= 0.001</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No fixed-effect standard errors are NA</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No standard errors look unreasonably large</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No sigma parameters are &lt; 0.01</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No sigma parameters are &gt; 100</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range parameter doesn't look unreasonably large</code></pre>
</div>
</div>
</section>
<section id="prediction" class="level3">
<h3 class="anchored" data-anchor-id="prediction">Prediction</h3>
<p>You now perform a prediction in you prediction grid using the fitted model m<sub>1</sub>. When you visualize your prediction in a map you can visualize your final prediction your model (eg. the estimated number of eggs) or you can visualize separately each part of the decomposition (the effect of the fixed covariates and the effect of the random fields (ω<sub>s</sub>, ε<sub>s,t</sub>) and see what is going on.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Predict in the prediction grid that has been created above</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>p_m1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_m1, <span class="at">newdata =</span> grid_yrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="full-fixed-and-random-effects-model-m1-prediction" class="level4">
<h4 class="anchored" data-anchor-id="full-fixed-and-random-effects-model-m1-prediction">Full (fixed and random effects) model m<sub>1</sub> prediction</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>plot_m1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m1, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(est))) <span class="sc">+</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Year)) <span class="sc">+</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (fixed effects +  random effects) based on full m1"</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The estimated density of eggs "</span> <span class="sc">*</span> <span class="fu">log</span>(mu[st]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s])))</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>plot_m1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fixed-effect-in-the-of-prediction-model-m1" class="level4">
<h4 class="anchored" data-anchor-id="fixed-effect-in-the-of-prediction-model-m1">Fixed effect in the of prediction model m<sub>1</sub></h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>plot_m1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m1, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(est_non_rf))) <span class="sc">+</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Year)) <span class="sc">+</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (fixed effects only) based on full m1"</span>,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The effect of time in the estimated variable "</span> <span class="sc">*</span> (beta[t]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s])))</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>plot_m1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="random-effect-in-the-prediction-of-model-m1" class="level4">
<h4 class="anchored" data-anchor-id="random-effect-in-the-prediction-of-model-m1">Random effect in the prediction of model m<sub>1</sub></h4>
<p>Here spatial random effect only</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>plot_m1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m1, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(omega_s))) <span class="sc">+</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (random effects only) based on full m1"</span>,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The effect of space in the estimated variable "</span> <span class="sc">*</span> (omega[s]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s])))</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>plot_m1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>For the ω<sub>s</sub> we have only one map because the spatial effect is stable across time. This is the mean spatial effect estimated from your data and it also represents the mean spatial distribution. If you want to see if or how the spatial effect changes in time then you need a spatiotemporal random effect (see m<sub>2</sub>).</p>
<p>This spatial random effect represents variance in space (but consistence through time) coming from the data that are not accounted by the fixed effects. In this model compared to m<sub>1</sub> the spatial random effect is less influential because a part of the variability is now explained by the spatiotemporal effect term.</p>
</section>
</section>
</section>
<section id="model-2-m2-spatiotemporal-model" class="level2">
<h2 class="anchored" data-anchor-id="model-2-m2-spatiotemporal-model">MODEL 2 (m<sub>2</sub>) : Spatiotemporal model</h2>
<p>The 2<sup>nd</sup> model (m<sub>2</sub>) follows that formula:</p>
<p>μ<sub>s,t</sub>= exp(β<sub>t</sub>+ ω<sub>s</sub> + ε<sub>s,t</sub>),</p>
<p>μ<sub>s,t</sub>= log(y<sub>s,t</sub> ),</p>
<p>y<sub>s,t</sub> ~ Tweedie (μ<sub>s,t</sub> ,p, φ) , ω~ MVNormal (0,Σ<sub>ω</sub>) , ε<sub>t</sub> ~ MVNormal (0,Σ<sub>t</sub>)</p>
<p>where the modeled egg density (μ<sub>s,t</sub>) follows the Tweedie distribution with a log link function, as egg density is positive, continuous and contains zeros.</p>
<p>y<sub>s,t</sub> represents eggs density (no of eggs/10m<sup>2</sup>) at space (s) and time(t), μ is the mean density at time and space and p, φ represent power and dispersion parameters of the Tweedie distribution, respectively.</p>
<p>β<sub>t</sub> are the fixed effects for factor(Year), they represent the average temporal variation</p>
<p>ω<sub>s</sub> is the spatial random effect, drawn from a GRF with covarianvce matrix Σ<sub>ω</sub> using Maretn correlation function. It represents the average spatial pattern (nich effect) and it also accounts for spatial variation that is not accounted for by our fixed effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting biomass density but are not accounted for in the model.</p>
<p>ε<sub>s,t</sub> represents the spatiotemporal random effect, drawn from a GRF with covarianvce matrix Σ<sub>ε</sub>. They represents how the average spatial pattern change through year so they also for spatial variation that is not accounted for by our fixed effects and the spatial random effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting our study variable but are not accounted for in the model.</p>
<p>In this model Spatiotemporal random fields are considered independent and identically distributed each single year (spatiotemporal = “IID”) and Maretn correlation function to accounts for spatial autocorrelation.</p>
<p><em>Are there other options for spatiotemporal fields:</em></p>
<ul>
<li><p><em>“AR1”: first-order autoregressive (each random filed is correlated to the one of the previous year )</em></p></li>
<li><p><em>“RW”: random walk (each random filed starts fro where it was last year plus a completely independent deviation)</em></p></li>
</ul>
<section id="fit-the-model-1" class="level3">
<h3 class="anchored" data-anchor-id="fit-the-model-1">Fit the model</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>fit_m2 <span class="ot">&lt;-</span> <span class="fu">sdmTMB</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  Sp10m3 <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Year,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data.eggs,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mesh =</span> mesh,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">tweedie</span>(<span class="at">link =</span> <span class="st">"log"</span>),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatial =</span> <span class="st">"on"</span>,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatiotemporal =</span> <span class="st">"IID"</span>,   </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="st">"time"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="results-of-the-fit-1" class="level3">
<h3 class="anchored" data-anchor-id="results-of-the-fit-1">Results of the fit</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>fit_m2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Spatiotemporal model fit by ML ['sdmTMB']
Formula: Sp10m3 ~ 0 + Year
Mesh: mesh (isotropic covariance)
Time column: time
Data: data.eggs
Family: tweedie(link = 'log')
 
         coef.est coef.se
Year2000     1.95    0.98
Year2001    -0.36    0.96
Year2002     0.36    0.99
Year2003    -1.73    0.99
Year2004     1.07    0.95
Year2005     0.91    1.03
Year2006     0.75    1.03
Year2007     0.12    1.00
Year2008    -0.93    0.99
Year2009    -0.68    0.97
Year2010    -0.56    0.97
Year2011     0.09    0.94
Year2012    -0.12    0.95
Year2013    -0.37    0.97
Year2014    -0.59    0.97
Year2015    -1.40    0.97
Year2016    -0.88    0.98
Year2017    -0.44    0.96
Year2018    -0.98    0.97
Year2019    -1.84    0.98
Year2021    -2.74    1.01
Year2022    -1.66    0.99
Year2023    -1.90    0.99
Year2024    -1.68    0.98

Dispersion parameter: 5.61
Tweedie p: 1.57
Matérn range: 80.58
Spatial SD: 2.96
Spatiotemporal IID SD: 2.62
ML criterion at convergence: 43945.674

See ?tidy.sdmTMB to extract these values as a data frame.</code></pre>
</div>
</div>
<section id="confidence-intervals-of-fixed-effects-1" class="level4">
<h4 class="anchored" data-anchor-id="confidence-intervals-of-fixed-effects-1">Confidence intervals of fixed effects</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>fix_effects<span class="ot">&lt;-</span> <span class="fu">tidy</span>(fit_m2, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>fix_effects</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24 × 5
   term     estimate std.error conf.low conf.high
   &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Year2000    1.95      0.979   0.0326     3.87 
 2 Year2001   -0.360     0.959  -2.24       1.52 
 3 Year2002    0.361     0.986  -1.57       2.29 
 4 Year2003   -1.73      0.986  -3.66       0.202
 5 Year2004    1.07      0.947  -0.785      2.93 
 6 Year2005    0.906     1.03   -1.11       2.92 
 7 Year2006    0.750     1.03   -1.26       2.76 
 8 Year2007    0.119     1.00   -1.84       2.08 
 9 Year2008   -0.933     0.989  -2.87       1.01 
10 Year2009   -0.683     0.969  -2.58       1.22 
# ℹ 14 more rows</code></pre>
</div>
</div>
</section>
<section id="confidence-intervals-of-random-effects-and-variance-parameters" class="level4">
<h4 class="anchored" data-anchor-id="confidence-intervals-of-random-effects-and-variance-parameters">Confidence intervals of random effects and variance parameters</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>random_effects<span class="ot">&lt;-</span> <span class="fu">tidy</span>(fit_m2, <span class="at">effects =</span> <span class="st">"ran_pars"</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>random_effects</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 5
  term      estimate std.error conf.low conf.high
  &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 range        80.6    5.64       70.3      92.4 
2 phi           5.61   0.0655      5.48      5.74
3 sigma_O       2.96   0.308       2.42      3.63
4 sigma_E       2.62   0.0758      2.48      2.78
5 tweedie_p     1.57   0.00342     1.56      1.57</code></pre>
</div>
</div>
<p>Other than the effect of the spatial random (sigma_O) and the spatiotemporal random field (sigma_E) field you have: :</p>
<ul>
<li><p>Matérn range: the distance at witch you have no correlation - similar to the variogram range</p></li>
<li><p>phi (φ) &amp; tweedie_p (p): the dispersion parameter and the power of the Tweedie distribution, respectively.</p></li>
</ul>
<section id="plot-the-all-the-effects-1" class="level5">
<h5 class="anchored" data-anchor-id="plot-the-all-the-effects-1">Plot the all the effects</h5>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> fix_effects, <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> term, <span class="at">col =</span> term)) <span class="sc">+</span> </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data =</span> fix_effects, <span class="fu">aes</span>(<span class="at">y =</span> term, <span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high, <span class="at">color =</span> term), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span>  </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> random_effects <span class="sc">%&gt;%</span> <span class="fu">filter</span>(term <span class="sc">==</span> <span class="fu">c</span>(<span class="st">"sigma_O"</span>,<span class="st">"sigma_E"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> term)) <span class="sc">+</span>  </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data =</span> random_effects <span class="sc">%&gt;%</span> <span class="fu">filter</span>(term <span class="sc">==</span> <span class="fu">c</span>(<span class="st">"sigma_O"</span>,<span class="st">"sigma_E"</span>)), <span class="fu">aes</span>(<span class="at">y =</span> term, <span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span>  </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>( <span class="at">title =</span> <span class="fu">expression</span>(<span class="st">"Mean and 95% confidence intervals of the fixed &amp; random effects,"</span> <span class="sc">~</span> m[<span class="dv">2</span>]),       </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="fu">expression</span>(mu[s<span class="sc">~</span>t] <span class="sc">~</span> <span class="st">"="</span> <span class="sc">~</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s] <span class="sc">+</span>epsilon[st]))) <span class="sc">+</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can see that the effect of spatial term is steal the most “important” one. But a lot of is effect is now explained by the spatiotemporal effect.</p>
</section>
</section>
</section>
<section id="diagnostics-1" class="level3">
<h3 class="anchored" data-anchor-id="diagnostics-1">Diagnostics</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sanity</span>(fit_m2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Non-linear minimizer suggests successful convergence</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Hessian matrix is positive definite</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No extreme or very small eigenvalues detected</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No gradients with respect to fixed effects are &gt;= 0.001</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No fixed-effect standard errors are NA</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No standard errors look unreasonably large</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No sigma parameters are &lt; 0.01</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No sigma parameters are &gt; 100</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range parameter doesn't look unreasonably large</code></pre>
</div>
</div>
</section>
<section id="prediction-1" class="level3">
<h3 class="anchored" data-anchor-id="prediction-1">Prediction</h3>
<p>You can steel predict in the same grid as m<sub>1</sub> as no more covariates have been added to the model.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>p_m2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_m2, <span class="at">newdata =</span> grid_yrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="full-fixed-and-random-effects-model-m2-prediction" class="level4">
<h4 class="anchored" data-anchor-id="full-fixed-and-random-effects-model-m2-prediction">Full (fixed and random effects) model m<sub>2</sub> prediction</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>plot_m2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m2, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(est))) <span class="sc">+</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Year)) <span class="sc">+</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (fixed effects +  random effects) based on full m2"</span>,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The estimated density of eggs "</span> <span class="sc">*</span> <span class="fu">log</span>(mu[st]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s]<span class="sc">+</span> epsilon[st])))</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>plot_m2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fixed-effect-in-the-prediction-of-model-m2" class="level4">
<h4 class="anchored" data-anchor-id="fixed-effect-in-the-prediction-of-model-m2">Fixed effect in the prediction of model m<sub>2</sub></h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>plot_m2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m2, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(est_non_rf))) <span class="sc">+</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Year)) <span class="sc">+</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (fixed effects only) based on full m2"</span>,</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The effect of time in the estimated variable "</span> <span class="sc">*</span> (beta[t]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s]<span class="sc">+</span> epsilon[st])))</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>plot_m2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="random-effects-in-the-prediction-of-model-m2" class="level4">
<h4 class="anchored" data-anchor-id="random-effects-in-the-prediction-of-model-m2">Random effects in the prediction of model m<sub>2</sub></h4>
<p>Here spatial &amp; spatiotemporal random effects</p>
<section id="plot-the-spatial-random-effect" class="level5">
<h5 class="anchored" data-anchor-id="plot-the-spatial-random-effect">Plot the spatial random effect</h5>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>plot_m2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m2, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(omega_s))) <span class="sc">+</span> </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (spatial random effect) based on full m2"</span>,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The effect of space in the estimated variable "</span> <span class="sc">*</span> (omega[s]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s] <span class="sc">+</span> epsilon[st])))</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>plot_m2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="plot-the-spatotemporal-random-effect" class="level5">
<h5 class="anchored" data-anchor-id="plot-the-spatotemporal-random-effect">Plot the spatotemporal random effect</h5>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>plot_m2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m2, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(epsilon_st))) <span class="sc">+</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Year)) <span class="sc">+</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (spatiotemporal random effect) based on full m2"</span>,</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The effect of space through time in the estimated variable "</span> <span class="sc">*</span> (epsilon[st]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s] <span class="sc">+</span> epsilon[st])))</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>plot_m2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The spatiptempral random effect represent deviation from the fixed effect predictions and the spatial random effect deviations. These represent changes in the spatial paternal through time that are forced by parameters not accounted for in the model.</p>
</section>
</section>
</section>
</section>
<section id="model-3-m3-spatiotemporal-model-with-covariates." class="level2">
<h2 class="anchored" data-anchor-id="model-3-m3-spatiotemporal-model-with-covariates.">MODEL 3 (m<sub>3</sub>) : Spatiotemporal model with covariates.</h2>
<p>Now letts add a variable.</p>
<p>The 3<sup>nd</sup> model (m<sub>3</sub>) will be a spatiotemporal model with Temperature as a covariate :</p>
<p>μ<sub>s,t</sub>= exp(X<sub>s,t</sub>β+β<sub>t</sub>+ ω<sub>s</sub> + ε<sub>s,t</sub>),</p>
<p>μ<sub>s,t</sub>= log(y<sub>s,t</sub> ),</p>
<p>y<sub>s,t</sub> ~ Tweedie (μ<sub>s,t</sub> ,p, φ) , ω~ MVNormal (0,Σ<sub>ω</sub>) , ε<sub>t</sub> ~ MVNormal (0,Σ<sub>t</sub>)</p>
<p>where the modeled egg density (μ<sub>s,t</sub>) follows the Tweedie distribution with a log link function, as egg density is positive, continuous and contains zeros.</p>
<p>y<sub>s,t</sub> represent eggs density (no of eggs/10m<sup>2</sup>) at space (s) and time(t), μ is the mean density at time and space and p, φ represent power and dispersion parameters of the Tweedie distribution, respectively.</p>
<p>X<sub>s,t,</sub> is the design matrix with covariates temperature and year as factor. Temperature is modeled with a smooth function.</p>
<p>β is a vector with the fixed effect coefficients (here only temperature)</p>
<p>β<sub>t</sub> are the fixed effects for factor(Year), they represent the average temporal variation</p>
<p>ω<sub>s</sub> is the spatial random effect, drawn from a GRF with covarianvce matrix Σ<sub>ω</sub> using Maretn correlation function. It represents the average spatial pattern (nich effect) and it also accounts for spatial variation that is not accounted for by our fixed effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting biomass density but are not accounted for in the model.</p>
<p>ε<sub>s,t</sub> represents the spatiotemporal random effect, drawn from a GRF with covarianvce matrix Σ<sub>ε</sub>. They represents how the average spatial pattern change through year so they also for spatial variation that is not accounted for by our fixed effects and the spatial random effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting our study variable but are not accounted for in the model.</p>
<p>In this model Spatiotemporal random fields are considered independent and identically distributed each single year (spatiotemporal = “IID”) and Maretn correlation function to accounts for spatial autocorrelation.</p>
<p>To fit the new model we need to</p>
<ul>
<li><p>Check the data are ok (mainly covariates)</p></li>
<li><p>Create new mesh based on the new data sets (some data points are removed)</p></li>
<li><p>Create a new prediction grid containing all the covariates (the <span class="citation" data-cites="lindmark2023">[@lindmark2023]</span> approach is used, see intro)</p></li>
</ul>
<section id="prepare-the-data" class="level3">
<h3 class="anchored" data-anchor-id="prepare-the-data">Prepare the data</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data.eggs<span class="sc">$</span>Tempsbe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
-300.00   13.75   14.53   13.97   15.48   69.71      18 </code></pre>
</div>
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(data.eggs<span class="sc">$</span>Tempsbe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>data.temp<span class="ot">=</span>data.eggs[data.eggs<span class="sc">$</span>Tempsbe<span class="sc">&gt;=</span><span class="dv">0</span> <span class="sc">&amp;</span> data.eggs<span class="sc">$</span>Tempsbe<span class="sc">&lt;</span><span class="dv">30</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(data.eggs<span class="sc">$</span>Tempsbe),]</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(data.temp<span class="sc">$</span>Tempsbe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-30-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="create-the-mesh-1" class="level3">
<h3 class="anchored" data-anchor-id="create-the-mesh-1">Create the mesh</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>mesh <span class="ot">&lt;-</span> <span class="fu">make_mesh</span>(data.temp, <span class="at">xy_cols =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), <span class="at">cutoff =</span> <span class="dv">30</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mesh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="create-the-prediction-grid" class="level3">
<h3 class="anchored" data-anchor-id="create-the-prediction-grid">Create the prediction grid</h3>
<p>We first fit a spatiotemporal model (m<sub>temp</sub>) for temperature and then we predict temperature in the prediction grid that we already have. The results of this prediction will be the new prediction grid for the m<sub>3</sub>.</p>
<section id="model-temp-mtemp-spatio-temoral-model-for-temperature" class="level4">
<h4 class="anchored" data-anchor-id="model-temp-mtemp-spatio-temoral-model-for-temperature"><strong>MODEL Temp (m~temp) : Spatio-temoral model for temperature</strong></h4>
<p>The temperature model (m<sub>temp</sub>) follows that formula:</p>
<p>μ<sub>s,t</sub>= exp(β<sub>t</sub>+ ω<sub>s</sub> + ε<sub>s,t</sub>),</p>
<p>μ<sub>s,t</sub>= y<sub>s,t</sub> ,</p>
<p>y<sub>s,t</sub> ~ Normal (μ<sub>s,t</sub> σ<sup>2</sup>) , ω~ MVNormal (0,Σ<sub>ω</sub>) , ε<sub>t</sub> ~ MVNormal (0,Σ<sub>t</sub>)</p>
<p>where the modeled temperature (μ<sub>s,t</sub>) followe a Gaussian distribution without a link function.</p>
<p>y<sub>s,t</sub> represents temperature at space (s) and time(t), μ is the mean density at time and space and and σ<sup>2</sup> been the variance.</p>
<p>β<sub>t</sub> are the fixed effects for factor(Year), they represent the average temporal variation</p>
<p>ω<sub>s</sub> is the spatial random effect, drawn from a GRF with covarianvce matrix Σ<sub>ω</sub> using Maretn correlation function.</p>
<p>ε<sub>s,t</sub> represents the spatiotemporal random effect, drawn from a GRF with covarianvce matrix Σ<sub>ε</sub>. Spatiotemporal random fields are considered independent and identically distributed each single year (spatiotemporal = “IID”) and Maretn correlation function to account for spatial autocorrelation.</p>
<section id="fit-the-model-2" class="level5">
<h5 class="anchored" data-anchor-id="fit-the-model-2">Fit the model</h5>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>fit_temp <span class="ot">&lt;-</span> <span class="fu">sdmTMB</span>(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  Tempsbe <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Year,</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data.temp,</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mesh =</span> mesh,</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">gaussian</span>(<span class="at">link =</span> <span class="st">"identity"</span>),</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatial =</span> <span class="st">"on"</span>,</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatiotemporal=</span><span class="st">'IID'</span>,</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">time=</span><span class="st">'time'</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="results-of-the-fit-2" class="level5">
<h5 class="anchored" data-anchor-id="results-of-the-fit-2">Results of the fit</h5>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>fit_temp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Spatiotemporal model fit by ML ['sdmTMB']
Formula: Tempsbe ~ 0 + Year
Mesh: mesh (isotropic covariance)
Time column: time
Data: data.temp
Family: gaussian(link = 'identity')
 
         coef.est coef.se
Year2000    13.45    0.39
Year2001    14.86    0.37
Year2002    14.41    0.39
Year2003    18.36    0.38
Year2004    13.67    0.37
Year2005    14.38    0.41
Year2006    14.48    0.41
Year2007    14.63    0.40
Year2008    14.69    0.39
Year2009    13.37    0.38
Year2010    13.41    0.37
Year2011    15.91    0.37
Year2012    13.44    0.37
Year2013    13.48    0.38
Year2014    14.49    0.37
Year2015    14.54    0.37
Year2016    14.36    0.37
Year2017    13.81    0.37
Year2018    14.37    0.37
Year2019    14.19    0.37
Year2021    13.61    0.37
Year2022    15.35    0.38
Year2023    15.08    0.37
Year2024    15.15    0.38

Dispersion parameter: 0.42
Matérn range: 145.67
Spatial SD: 0.33
Spatiotemporal IID SD: 0.86
ML criterion at convergence: 9758.662

See ?tidy.sdmTMB to extract these values as a data frame.</code></pre>
</div>
</div>
</section>
<section id="confidence-intervals-of-fixed-effects-2" class="level5">
<h5 class="anchored" data-anchor-id="confidence-intervals-of-fixed-effects-2">Confidence intervals of fixed effects</h5>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(fit_temp, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24 × 5
   term     estimate std.error conf.low conf.high
   &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Year2000     13.5     0.386     12.7      14.2
 2 Year2001     14.9     0.369     14.1      15.6
 3 Year2002     14.4     0.387     13.7      15.2
 4 Year2003     18.4     0.376     17.6      19.1
 5 Year2004     13.7     0.374     12.9      14.4
 6 Year2005     14.4     0.410     13.6      15.2
 7 Year2006     14.5     0.412     13.7      15.3
 8 Year2007     14.6     0.396     13.9      15.4
 9 Year2008     14.7     0.387     13.9      15.4
10 Year2009     13.4     0.378     12.6      14.1
# ℹ 14 more rows</code></pre>
</div>
</div>
<section id="confidence-intervals-of-random-effects-and-variance-parameters-1" class="level6">
<h6 class="anchored" data-anchor-id="confidence-intervals-of-random-effects-and-variance-parameters-1">Confidence intervals of random effects and variance parameters</h6>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(fit_temp, <span class="at">effects =</span> <span class="st">"ran_pars"</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 5
  term    estimate std.error conf.low conf.high
  &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 range    146.      7.21     132.      161.   
2 phi        0.420   0.00266    0.415     0.426
3 sigma_O    0.332   0.0453     0.254     0.434
4 sigma_E    0.858   0.0280     0.805     0.914</code></pre>
</div>
</div>
</section>
<section id="diagnostics-2" class="level6">
<h6 class="anchored" data-anchor-id="diagnostics-2">Diagnostics</h6>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sanity</span>(fit_temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Non-linear minimizer suggests successful convergence</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Hessian matrix is positive definite</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No extreme or very small eigenvalues detected</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No gradients with respect to fixed effects are &gt;= 0.001</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No fixed-effect standard errors are NA</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No standard errors look unreasonably large</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No sigma parameters are &lt; 0.01</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No sigma parameters are &gt; 100</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range parameter doesn't look unreasonably large</code></pre>
</div>
</div>
</section>
</section>
<section id="prediction-2" class="level5">
<h5 class="anchored" data-anchor-id="prediction-2">Prediction</h5>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>p_temp <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_temp, <span class="at">newdata =</span> grid_yrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>plot_temp <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_temp, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> est)) <span class="sc">+</span> </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Year)) <span class="sc">+</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Prediction (fixed effects + random effects) based on m_temp"</span>,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The estimated temperatures "</span> (mu[st]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> (beta[t] <span class="sc">+</span> omega[s]<span class="sc">+</span> epsilon[st])))</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>plot_temp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This prediction output will be the prediction grid for m<sub>3</sub>.</p>
</section>
</section>
</section>
<section id="fit-the-model-m3" class="level3">
<h3 class="anchored" data-anchor-id="fit-the-model-m3">Fit the model m<sub>3</sub></h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>fit_m3 <span class="ot">&lt;-</span> <span class="fu">sdmTMB</span>(</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  Sp10m3 <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Year <span class="sc">+</span> <span class="fu">s</span>(Tempsbe),</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data.temp,</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mesh =</span> mesh,</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">tweedie</span>(<span class="at">link=</span><span class="st">"log"</span>),</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatial =</span> <span class="st">"on"</span>,</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatiotemporal=</span><span class="st">'IID'</span>,</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">time=</span><span class="st">'time'</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="results-of-the-fit-3" class="level3">
<h3 class="anchored" data-anchor-id="results-of-the-fit-3">Results of the fit</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>fit_m3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Spatiotemporal model fit by ML ['sdmTMB']
Formula: Sp10m3 ~ 0 + Year + s(Tempsbe)
Mesh: mesh (isotropic covariance)
Time column: time
Data: data.temp
Family: tweedie(link = 'log')
 
         coef.est coef.se
Year2000     1.98    0.99
Year2001    -0.27    0.97
Year2002     0.54    1.00
Year2003    -1.89    1.00
Year2004     1.14    0.96
Year2005     1.11    1.04
Year2006     0.98    1.04
Year2007     0.24    1.01
Year2008    -0.71    1.00
Year2009    -0.59    0.98
Year2010    -0.50    0.98
Year2011     0.27    0.95
Year2012     0.15    0.96
Year2013    -0.23    0.98
Year2014    -0.42    0.98
Year2015    -1.24    0.98
Year2016    -0.72    0.99
Year2017    -0.30    0.97
Year2018    -0.80    0.98
Year2019    -1.73    1.00
Year2021    -2.59    1.02
Year2022    -1.47    1.01
Year2023    -1.72    1.00
Year2024    -1.38    0.99
sTempsbe     0.02    0.20

Smooth terms:
             Std. Dev.
sds(Tempsbe)      1.77

Dispersion parameter: 5.72
Tweedie p: 1.58
Matérn range: 81.87
Spatial SD: 2.95
Spatiotemporal IID SD: 2.61
ML criterion at convergence: 43992.079

See ?tidy.sdmTMB to extract these values as a data frame.</code></pre>
</div>
</div>
<section id="confidence-intervals-of-fixed-effects-3" class="level4">
<h4 class="anchored" data-anchor-id="confidence-intervals-of-fixed-effects-3">Confidence intervals of fixed effects</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>fix_effects<span class="ot">&lt;-</span> <span class="fu">tidy</span>(fit_m3, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>fix_effects</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24 × 5
   term     estimate std.error conf.low conf.high
   &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Year2000    1.98      0.992   0.0393    3.93  
 2 Year2001   -0.267     0.969  -2.17      1.63  
 3 Year2002    0.542     0.997  -1.41      2.50  
 4 Year2003   -1.89      1.00   -3.85      0.0831
 5 Year2004    1.14      0.959  -0.736     3.02  
 6 Year2005    1.11      1.04   -0.932     3.15  
 7 Year2006    0.979     1.04   -1.06      3.02  
 8 Year2007    0.240     1.01   -1.74      2.22  
 9 Year2008   -0.708     0.999  -2.67      1.25  
10 Year2009   -0.594     0.981  -2.52      1.33  
# ℹ 14 more rows</code></pre>
</div>
</div>
</section>
<section id="confidence-intervals-of-random-effects-and-variance-parameters-2" class="level4">
<h4 class="anchored" data-anchor-id="confidence-intervals-of-random-effects-and-variance-parameters-2">Confidence intervals of random effects and variance parameters</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>random_effects<span class="ot">&lt;-</span> <span class="fu">tidy</span>(fit_m3, <span class="at">effects =</span> <span class="st">"ran_pars"</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>random_effects</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 5
  term      estimate std.error conf.low conf.high
  &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 range        81.9    5.69       71.4      93.8 
2 phi           5.72   0.0671      5.59      5.85
3 sigma_O       2.95   0.310       2.40      3.62
4 sigma_E       2.61   0.0768      2.47      2.77
5 tweedie_p     1.58   0.00338     1.57      1.58</code></pre>
</div>
</div>
<p>Other than the effect of the spatial random (sigma_O) and the spatiotemporal random field (sigma_E) field you have:</p>
<ul>
<li><p>Matérn range: the distance at witch you have no correlation - similar to the variogram range</p></li>
<li><p>phi (φ) &amp; tweedie_p (p): the dispersion parameter and the power of the Tweedie distribution, respectively.</p></li>
</ul>
<section id="plot-the-all-the-effects-2" class="level5">
<h5 class="anchored" data-anchor-id="plot-the-all-the-effects-2">Plot the all the effects</h5>
<p><em>The effect of Temperature is not in the fixed_effects because we used a smoother. How can I visualize this effect??</em></p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> fix_effects, <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> term, <span class="at">col =</span> term)) <span class="sc">+</span> </span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data =</span> fix_effects, <span class="fu">aes</span>(<span class="at">y =</span> term, <span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high, <span class="at">color =</span> term), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span>  </span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> random_effects <span class="sc">%&gt;%</span> <span class="fu">filter</span>(term <span class="sc">==</span> <span class="fu">c</span>(<span class="st">"sigma_O"</span>,<span class="st">"sigma_E"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> term)) <span class="sc">+</span>  </span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data =</span> random_effects <span class="sc">%&gt;%</span> <span class="fu">filter</span>(term <span class="sc">==</span> <span class="fu">c</span>(<span class="st">"sigma_O"</span>,<span class="st">"sigma_E"</span>)), <span class="fu">aes</span>(<span class="at">y =</span> term, <span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span>  </span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>( <span class="at">title =</span> <span class="fu">expression</span>(<span class="st">"Mean and 95% confidence intervals of the fixed &amp; random effects,"</span> <span class="sc">~</span> m[<span class="dv">3</span>]),       </span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="fu">expression</span>(mu[s<span class="sc">~</span>t] <span class="sc">~</span> <span class="st">"="</span> <span class="sc">~</span> <span class="fu">exp</span>(X[st]<span class="sc">*</span> beta <span class="sc">+</span> beta[t]<span class="sc">+</span> omega[s] <span class="sc">+</span>epsilon[st]))) <span class="sc">+</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="diagnostics-3" class="level3">
<h3 class="anchored" data-anchor-id="diagnostics-3">Diagnostics</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sanity</span>(fit_m3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Non-linear minimizer suggests successful convergence</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Hessian matrix is positive definite</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No extreme or very small eigenvalues detected</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No gradients with respect to fixed effects are &gt;= 0.001</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No fixed-effect standard errors are NA</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No standard errors look unreasonably large</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No sigma parameters are &lt; 0.01</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No sigma parameters are &gt; 100</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range parameter doesn't look unreasonably large</code></pre>
</div>
</div>
</section>
<section id="prediction-3" class="level3">
<h3 class="anchored" data-anchor-id="prediction-3">Prediction</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>p_temp <span class="ot">=</span> p_temp <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Tempsbe=</span>est) </span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>p_m3 <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_m3, <span class="at">newdata =</span> p_temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="full-fixed-and-random-effects-model-m3-prediction" class="level4">
<h4 class="anchored" data-anchor-id="full-fixed-and-random-effects-model-m3-prediction">Full (fixed and random effects) model m<sub>3</sub> prediction</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>plot_m3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m3, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(est))) <span class="sc">+</span> </span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Year)) <span class="sc">+</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Prediction (fixed effects +  random effects) based on full m3"</span>,</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The estimated density of eggs "</span> <span class="sc">*</span> <span class="fu">log</span>(mu[st]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(X[t,s]<span class="sc">*</span>beta <span class="sc">+</span>beta[t] <span class="sc">+</span> omega[s]<span class="sc">+</span> epsilon[st])))</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>plot_m3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fixed-effects-in-the-prediction-of-model-m3" class="level4">
<h4 class="anchored" data-anchor-id="fixed-effects-in-the-prediction-of-model-m3">Fixed effects in the prediction of model m<sub>3</sub></h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>plot_m3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m3, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(est_non_rf))) <span class="sc">+</span> </span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Year)) <span class="sc">+</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (fixed effects only) based on full m3"</span>,</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The effect of time and temperature in the estimated variable "</span> <span class="sc">*</span> (X<span class="sc">*</span>beta<span class="sc">+</span> beta[t]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(X[t,s]<span class="sc">*</span>beta <span class="sc">+</span>beta[t] <span class="sc">+</span> omega[s]<span class="sc">+</span> epsilon[st])))</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>plot_m3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The pastern change is space - just because the effect of temperature is small and the scale is not good it is not reprisented well in the map.</p>
</section>
<section id="random-effects-in-the-prediction-of-model-m3---here-spatial-spatiotemporal-random-effects" class="level4">
<h4 class="anchored" data-anchor-id="random-effects-in-the-prediction-of-model-m3---here-spatial-spatiotemporal-random-effects">Random effects in the prediction of model m<sub>3</sub> - here spatial &amp; spatiotemporal random effects</h4>
<section id="plot-the-spatial-random-effect-1" class="level5">
<h5 class="anchored" data-anchor-id="plot-the-spatial-random-effect-1">Plot the spatial random effect</h5>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>plot_m3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m3, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(omega_s))) <span class="sc">+</span> </span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (spatial random effect) based on full m3"</span>,</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The effect of space in the estimated variable "</span> <span class="sc">*</span> (omega[s]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(X[t,s]<span class="sc">*</span>beta<span class="sc">+</span>beta[t] <span class="sc">+</span> omega[s] <span class="sc">+</span> epsilon[st])))</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>plot_m3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="plot-the-spatotemporal-random-effect-1" class="level5">
<h5 class="anchored" data-anchor-id="plot-the-spatotemporal-random-effect-1">Plot the spatotemporal random effect</h5>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>plot_m3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m3, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(epsilon_st))) <span class="sc">+</span> </span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Year)) <span class="sc">+</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (spatiotemporal random effect) based on full m3"</span>,</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The effect of space through time in the estimated variable "</span> <span class="sc">*</span> (epsilon[st]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(X[t,s]<span class="sc">*</span>beta<span class="sc">+</span>beta[t] <span class="sc">+</span>omega[s] <span class="sc">+</span> epsilon[st])))</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>plot_m3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="visualize-the-effect-of-the-smoothed-covariate-temperature." class="level4">
<h4 class="anchored" data-anchor-id="visualize-the-effect-of-the-smoothed-covariate-temperature.">Visualize the effect of the smoothed covariate Temperature.</h4>
<p>How I do not get that ???</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Tempsbe =</span> <span class="fu">seq</span>(<span class="fu">min</span>(data.temp<span class="sc">$</span>Tempsbe), <span class="fu">max</span>(data.temp<span class="sc">$</span>Tempsbe), <span class="at">length.out =</span> <span class="dv">100</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Year =</span> <span class="fu">as.factor</span>(<span class="dv">2024</span>),<span class="at">time=</span><span class="dv">24</span> <span class="co"># a chosen year</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_m3, <span class="at">newdata =</span> nd, <span class="at">se_fit =</span> <span class="cn">TRUE</span>, <span class="at">re_form =</span> <span class="cn">NA</span>)</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(p, <span class="fu">aes</span>(Tempsbe, <span class="fu">exp</span>(est),</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">ymin =</span> <span class="fu">exp</span>(est <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> est_se),</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ymax =</span> <span class="fu">exp</span>(est <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> est_se)</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>)) <span class="sc">+</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>() <span class="sc">+</span></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">expand =</span> F) <span class="sc">+</span></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Temp (°C)"</span>, <span class="at">y =</span> <span class="st">"Density (Nb/10m3)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="prepare-more-covariates-for-more-models-." class="level1">
<h1>Prepare more covariates for more models ….</h1>
<section id="model-prof-prof-model-spatio-temporel-de-covariables" class="level2">
<h2 class="anchored" data-anchor-id="model-prof-prof-model-spatio-temporel-de-covariables">MODEL prof (Prof) : Model spatio-temporel de Covariables</h2>
<section id="prepare-covariable" class="level3">
<h3 class="anchored" data-anchor-id="prepare-covariable">Prepare covariable</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>data.prof<span class="ot">=</span>data.eggs[data.eggs<span class="sc">$</span>Sonde<span class="sc">&gt;=</span><span class="dv">0</span> <span class="sc">&amp;</span> data.eggs<span class="sc">$</span>Sonde<span class="sc">&lt;</span><span class="dv">5000</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(data.eggs<span class="sc">$</span>Sonde),]</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>((data.prof<span class="sc">$</span>Sonde))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="create-the-mesh-2" class="level3">
<h3 class="anchored" data-anchor-id="create-the-mesh-2">Create the mesh</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>mesh <span class="ot">&lt;-</span> <span class="fu">make_mesh</span>(data.prof, <span class="at">xy_cols =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), <span class="at">cutoff =</span> <span class="dv">30</span>)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mesh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fit-the-model-3" class="level3">
<h3 class="anchored" data-anchor-id="fit-the-model-3">Fit the model</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>fit_prof <span class="ot">&lt;-</span> <span class="fu">sdmTMB</span>(</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  Sonde <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Year,</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data.prof,</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mesh =</span> mesh,</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">gaussian</span>(<span class="at">link =</span> <span class="st">"log"</span>),</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatial =</span> <span class="st">"on"</span>,</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatiotemporal=</span><span class="st">'IID'</span>,</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">time=</span><span class="st">'time'</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="results-of-the-fit-4" class="level3">
<h3 class="anchored" data-anchor-id="results-of-the-fit-4">Results of the fit</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>fit_temp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Spatiotemporal model fit by ML ['sdmTMB']
Formula: Tempsbe ~ 0 + Year
Mesh: mesh (isotropic covariance)
Time column: time
Data: data.temp
Family: gaussian(link = 'identity')
 
         coef.est coef.se
Year2000    13.45    0.39
Year2001    14.86    0.37
Year2002    14.41    0.39
Year2003    18.36    0.38
Year2004    13.67    0.37
Year2005    14.38    0.41
Year2006    14.48    0.41
Year2007    14.63    0.40
Year2008    14.69    0.39
Year2009    13.37    0.38
Year2010    13.41    0.37
Year2011    15.91    0.37
Year2012    13.44    0.37
Year2013    13.48    0.38
Year2014    14.49    0.37
Year2015    14.54    0.37
Year2016    14.36    0.37
Year2017    13.81    0.37
Year2018    14.37    0.37
Year2019    14.19    0.37
Year2021    13.61    0.37
Year2022    15.35    0.38
Year2023    15.08    0.37
Year2024    15.15    0.38

Dispersion parameter: 0.42
Matérn range: 145.67
Spatial SD: 0.33
Spatiotemporal IID SD: 0.86
ML criterion at convergence: 9758.662

See ?tidy.sdmTMB to extract these values as a data frame.</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(fit_temp, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24 × 5
   term     estimate std.error conf.low conf.high
   &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Year2000     13.5     0.386     12.7      14.2
 2 Year2001     14.9     0.369     14.1      15.6
 3 Year2002     14.4     0.387     13.7      15.2
 4 Year2003     18.4     0.376     17.6      19.1
 5 Year2004     13.7     0.374     12.9      14.4
 6 Year2005     14.4     0.410     13.6      15.2
 7 Year2006     14.5     0.412     13.7      15.3
 8 Year2007     14.6     0.396     13.9      15.4
 9 Year2008     14.7     0.387     13.9      15.4
10 Year2009     13.4     0.378     12.6      14.1
# ℹ 14 more rows</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(fit_temp, <span class="at">effects =</span> <span class="st">"ran_pars"</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 5
  term    estimate std.error conf.low conf.high
  &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 range    146.      7.21     132.      161.   
2 phi        0.420   0.00266    0.415     0.426
3 sigma_O    0.332   0.0453     0.254     0.434
4 sigma_E    0.858   0.0280     0.805     0.914</code></pre>
</div>
</div>
</section>
<section id="diagnostics-4" class="level3">
<h3 class="anchored" data-anchor-id="diagnostics-4">Diagnostics</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sanity</span>(fit_temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Non-linear minimizer suggests successful convergence</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Hessian matrix is positive definite</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No extreme or very small eigenvalues detected</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No gradients with respect to fixed effects are &gt;= 0.001</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No fixed-effect standard errors are NA</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No standard errors look unreasonably large</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No sigma parameters are &lt; 0.01</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No sigma parameters are &gt; 100</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range parameter doesn't look unreasonably large</code></pre>
</div>
</div>
</section>
<section id="prediction-4" class="level3">
<h3 class="anchored" data-anchor-id="prediction-4">Prediction</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>p_prof <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_prof, <span class="at">newdata =</span> grid_yrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>plot_prof <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_prof, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(est))) <span class="sc">+</span> </span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Year)) <span class="sc">+</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>plot_prof</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sdmTMB_sardine_BoB_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- -->

</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb127" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "sdmTMB Sardine eggs Bay of biscay "</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 4</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-float: true</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true         </span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "Hide/Show "</span></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools:</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a><span class="co">      toggle: true         </span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load libraries and data</span></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,include=F}</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a><span class="in">rm(list=ls())</span></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a><span class="in"># Load packages</span></span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr)</span></span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a><span class="in">library(mapdata)</span></span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a><span class="in">library(rnaturalearth)</span></span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a><span class="in">library(rnaturalearthdata)</span></span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)</span></span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a><span class="in">library(sp)</span></span>
<span id="cb127-28"><a href="#cb127-28" aria-hidden="true" tabindex="-1"></a><span class="in">library(sdmTMB)</span></span>
<span id="cb127-29"><a href="#cb127-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-30"><a href="#cb127-30" aria-hidden="true" tabindex="-1"></a><span class="in"># Map</span></span>
<span id="cb127-31"><a href="#cb127-31" aria-hidden="true" tabindex="-1"></a><span class="in">world &lt;- ne_countries(scale = "medium", returnclass = "sf")</span></span>
<span id="cb127-32"><a href="#cb127-32" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-33"><a href="#cb127-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-34"><a href="#cb127-34" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-35"><a href="#cb127-35" aria-hidden="true" tabindex="-1"></a><span class="in">variable='Sp10m3'; species='Sardine'; ccolor='blue';maxvalue=200</span></span>
<span id="cb127-36"><a href="#cb127-36" aria-hidden="true" tabindex="-1"></a><span class="in">listyears=c(2000:2019,2021:2024)</span></span>
<span id="cb127-37"><a href="#cb127-37" aria-hidden="true" tabindex="-1"></a><span class="in">file.data='DataEggs/Cufes_spring_ifremer.txt'</span></span>
<span id="cb127-38"><a href="#cb127-38" aria-hidden="true" tabindex="-1"></a><span class="in">data.eggs=read.table(file=file.data,sep="\t",header=T)</span></span>
<span id="cb127-39"><a href="#cb127-39" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-40"><a href="#cb127-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-41"><a href="#cb127-41" aria-hidden="true" tabindex="-1"></a><span class="fu">#### A quick map of your row data</span></span>
<span id="cb127-42"><a href="#cb127-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-43"><a href="#cb127-43" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-44"><a href="#cb127-44" aria-hidden="true" tabindex="-1"></a><span class="in">data.eggs_sf &lt;- st_as_sf(data.eggs, coords = c("Long", "Lat"), crs = "WGS84")</span></span>
<span id="cb127-45"><a href="#cb127-45" aria-hidden="true" tabindex="-1"></a><span class="in">plot_eggs &lt;- ggplot(data = data.eggs_sf) + </span></span>
<span id="cb127-46"><a href="#cb127-46" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(aes(color = Sp10m3), alpha = 0.8, size = 0.8) +</span></span>
<span id="cb127-47"><a href="#cb127-47" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~ Year) +</span></span>
<span id="cb127-48"><a href="#cb127-48" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_viridis_c(trans = "log", na.value = "grey80",   name = expression("Log(Eggs/10m³)\n grays are zero")) +</span></span>
<span id="cb127-49"><a href="#cb127-49" aria-hidden="true" tabindex="-1"></a><span class="in">ggtitle("Total Sardine eggs")</span></span>
<span id="cb127-50"><a href="#cb127-50" aria-hidden="true" tabindex="-1"></a><span class="in">plot_eggs</span></span>
<span id="cb127-51"><a href="#cb127-51" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-52"><a href="#cb127-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-53"><a href="#cb127-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-54"><a href="#cb127-54" aria-hidden="true" tabindex="-1"></a>Those are the row data of eggs from PELGAS survey for years 2000-2024 (1 year -2020- gap). Eggs are collected using CUFES at 5m depth, every 3nmi (5.556Km) at transects with inter-transect distance of 12nmi (22.22Km).</span>
<span id="cb127-55"><a href="#cb127-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-56"><a href="#cb127-56" aria-hidden="true" tabindex="-1"></a>Sp10m3 &amp; Ee10m3: total eggs **density** (no eggs/ 10m ^3^ ) for sardine and anchovy respectively.</span>
<span id="cb127-57"><a href="#cb127-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-58"><a href="#cb127-58" aria-hidden="true" tabindex="-1"></a>Sp1,2,3 &amp; Ee1,2,3: the **number** of eggs or sardine and anchovy respectively for specific stages.</span>
<span id="cb127-59"><a href="#cb127-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-60"><a href="#cb127-60" aria-hidden="true" tabindex="-1"></a>Group1: no embryo, egg stages (1-3)</span>
<span id="cb127-61"><a href="#cb127-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-62"><a href="#cb127-62" aria-hidden="true" tabindex="-1"></a>Group2: early embryo, egg stages (4-6)</span>
<span id="cb127-63"><a href="#cb127-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-64"><a href="#cb127-64" aria-hidden="true" tabindex="-1"></a>Group3: late embryo, egg stages (7-11).</span>
<span id="cb127-65"><a href="#cb127-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-66"><a href="#cb127-66" aria-hidden="true" tabindex="-1"></a>Sonde(depth), Ventvrai, Dirventvrm, Tempsbe Salinite, chlorophyl,</span>
<span id="cb127-67"><a href="#cb127-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-68"><a href="#cb127-68" aria-hidden="true" tabindex="-1"></a>*We have to think:*</span>
<span id="cb127-69"><a href="#cb127-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-70"><a href="#cb127-70" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*The vertical distribution of eggs*</span>
<span id="cb127-71"><a href="#cb127-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-72"><a href="#cb127-72" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Eggs cohorts (Total eggs, group1, aging and Po) [@petitgas2009]* at least remove the effect of temperature by standardizing with stage duration time (Renger et al 1985) </span>
<span id="cb127-73"><a href="#cb127-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-74"><a href="#cb127-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-75"><a href="#cb127-75" aria-hidden="true" tabindex="-1"></a><span class="fu">###### We removed data at the north of 48°N</span></span>
<span id="cb127-76"><a href="#cb127-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-77"><a href="#cb127-77" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-78"><a href="#cb127-78" aria-hidden="true" tabindex="-1"></a><span class="in">data.eggs&lt;- data.eggs %&gt;% filter(Lat &lt; 48 &amp; is.na(Sp10m3)==F) %&gt;%</span></span>
<span id="cb127-79"><a href="#cb127-79" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(Year=as.factor(Year), time=as.integer(Year))</span></span>
<span id="cb127-80"><a href="#cb127-80" aria-hidden="true" tabindex="-1"></a><span class="in">data.eggs &lt;- add_utm_columns(data.eggs, c("Long", "Lat"), ll_crs = 4326, units = "km")   #Project coordinates to Km</span></span>
<span id="cb127-81"><a href="#cb127-81" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-82"><a href="#cb127-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-83"><a href="#cb127-83" aria-hidden="true" tabindex="-1"></a><span class="fu">#### A quick map of your final data</span></span>
<span id="cb127-84"><a href="#cb127-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-85"><a href="#cb127-85" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-86"><a href="#cb127-86" aria-hidden="true" tabindex="-1"></a><span class="in">data.eggs_sf &lt;- st_as_sf(data.eggs, coords = c("Long", "Lat"), crs = "WGS84")</span></span>
<span id="cb127-87"><a href="#cb127-87" aria-hidden="true" tabindex="-1"></a><span class="in">plot_eggs &lt;- ggplot(data = data.eggs_sf) + </span></span>
<span id="cb127-88"><a href="#cb127-88" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(aes(color = Sp10m3), alpha = 0.8, size = 0.8) +</span></span>
<span id="cb127-89"><a href="#cb127-89" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~ Year) +</span></span>
<span id="cb127-90"><a href="#cb127-90" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_viridis_c(trans = "log", na.value = "grey80",   name = expression("Log(Eggs/10m³)\n grays are zero")) +</span></span>
<span id="cb127-91"><a href="#cb127-91" aria-hidden="true" tabindex="-1"></a><span class="in">ggtitle("Total Sardine eggs")</span></span>
<span id="cb127-92"><a href="#cb127-92" aria-hidden="true" tabindex="-1"></a><span class="in">plot_eggs</span></span>
<span id="cb127-93"><a href="#cb127-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-94"><a href="#cb127-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-95"><a href="#cb127-95" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prepare grid for prediction</span></span>
<span id="cb127-96"><a href="#cb127-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-97"><a href="#cb127-97" aria-hidden="true" tabindex="-1"></a>We are going to need another grid in which we will predict the eggs abundance using the final model.\</span>
<span id="cb127-98"><a href="#cb127-98" aria-hidden="true" tabindex="-1"></a>The prediction grid has to be replicated for the years included in the study; it also needs to have all the covariates that were used in the model. To have these variables in the spatial resolution of the prediction grid instead of an classic interpolation here we use same approach as<span class="co">[</span><span class="ot">@lindmark2023</span><span class="co">]</span> .</span>
<span id="cb127-99"><a href="#cb127-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-100"><a href="#cb127-100" aria-hidden="true" tabindex="-1"></a>Based on than approach you built a simple spatio-temporal model for each covariate (ex. m_temperature: μ~s,t~= β~t~+ ω~s~ +ε~s,t~) of your final model and you use that model (m_temperature) to predict the variable (here temperature) in the resolution of the prediction grid. You repeat that process for all your covariates.</span>
<span id="cb127-101"><a href="#cb127-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-102"><a href="#cb127-102" aria-hidden="true" tabindex="-1"></a>So, finaly you will you have the final prediction grid, which has information of all the fixed covariates included in your final model in the spatial resolution of the prediction grid.</span>
<span id="cb127-103"><a href="#cb127-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-104"><a href="#cb127-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-105"><a href="#cb127-105" aria-hidden="true" tabindex="-1"></a><span class="in">#Insert the grid</span></span>
<span id="cb127-106"><a href="#cb127-106" aria-hidden="true" tabindex="-1"></a><span class="in">projection_grid &lt;- readRDS("./DataEggs/user_region.rds")</span></span>
<span id="cb127-107"><a href="#cb127-107" aria-hidden="true" tabindex="-1"></a><span class="in">projection_grid_UTM &lt;- add_utm_columns(projection_grid, c("Lon", "Lat"), ll_crs = 4326, units = "km")</span></span>
<span id="cb127-108"><a href="#cb127-108" aria-hidden="true" tabindex="-1"></a><span class="in">plot(projection_grid_UTM$X,projection_grid_UTM$Y)</span></span>
<span id="cb127-109"><a href="#cb127-109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-110"><a href="#cb127-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-111"><a href="#cb127-111" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-112"><a href="#cb127-112" aria-hidden="true" tabindex="-1"></a><span class="in">#Replicate the grid across year</span></span>
<span id="cb127-113"><a href="#cb127-113" aria-hidden="true" tabindex="-1"></a><span class="in">grid_yrs &lt;- replicate_df(projection_grid_UTM, c("Year"), as.factor(unique(data.eggs$Year))) %&gt;%</span></span>
<span id="cb127-114"><a href="#cb127-114" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(time=as.integer(Year))</span></span>
<span id="cb127-115"><a href="#cb127-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-116"><a href="#cb127-116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-117"><a href="#cb127-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-118"><a href="#cb127-118" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create the mesh</span></span>
<span id="cb127-119"><a href="#cb127-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-120"><a href="#cb127-120" aria-hidden="true" tabindex="-1"></a>In these kinds of models, the spatial (ω~s~) and the spatiotemporal (ε~s,t~) variations (and potentially any spatial varying coefficient) are modeled as Gaussian Random Fields (GRF), where the random effects describing the spatial patterns are assumed to be drawn from a multivariate normal distribution MVNormal (0,Σ). Estimating this covariance matrix (Σ) is computational demanding, so the SPDE approach is used to approximate the Gaussian random fields.</span>
<span id="cb127-121"><a href="#cb127-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-122"><a href="#cb127-122" aria-hidden="true" tabindex="-1"></a>For the SPDE approximation approach you need another grid called the **mesh** which is a triangulated mesh with Knots. These Knots are used to approximate the spatial variability in your data and because the number of Knots <span class="sc">\&lt;\&lt;</span> number of data points the computation of the covariance is easier. The Matern correlation is used as a covariance function to account for spatial autocorrelation.</span>
<span id="cb127-123"><a href="#cb127-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-124"><a href="#cb127-124" aria-hidden="true" tabindex="-1"></a>*Maybe more discussion in how you contract the mesh (ex. who many Knots you need)*</span>
<span id="cb127-125"><a href="#cb127-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-126"><a href="#cb127-126" aria-hidden="true" tabindex="-1"></a>So, so far we have three grids with different spatial resolution :</span>
<span id="cb127-127"><a href="#cb127-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-128"><a href="#cb127-128" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The data grid (your sampling points, those data are used to estimate fixed parameres)</span>
<span id="cb127-129"><a href="#cb127-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-130"><a href="#cb127-130" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The mesh (for the Gaussian Random Fields approximation)</span>
<span id="cb127-131"><a href="#cb127-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-132"><a href="#cb127-132" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The prediction grid ( for predictions using your final model).</span>
<span id="cb127-133"><a href="#cb127-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-134"><a href="#cb127-134" aria-hidden="true" tabindex="-1"></a>    So the mesh is:</span>
<span id="cb127-135"><a href="#cb127-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-136"><a href="#cb127-136" aria-hidden="true" tabindex="-1"></a><span class="in">```{r warning=FALSE}</span></span>
<span id="cb127-137"><a href="#cb127-137" aria-hidden="true" tabindex="-1"></a><span class="in">mesh &lt;- make_mesh(data.eggs, xy_cols = c("X", "Y"), cutoff = 30)  # cutoff: minimum distance between knots before a new mesh vertex is added- units as in your dataset</span></span>
<span id="cb127-138"><a href="#cb127-138" aria-hidden="true" tabindex="-1"></a><span class="in">plot(mesh)                                                     </span></span>
<span id="cb127-139"><a href="#cb127-139" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-140"><a href="#cb127-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-141"><a href="#cb127-141" aria-hidden="true" tabindex="-1"></a><span class="fu">## MODEL 1 (m~1~) : Spatial model (non spatio-temporal term)</span></span>
<span id="cb127-142"><a href="#cb127-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-143"><a href="#cb127-143" aria-hidden="true" tabindex="-1"></a>The first model (m~1~) follows that formula:</span>
<span id="cb127-144"><a href="#cb127-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-145"><a href="#cb127-145" aria-hidden="true" tabindex="-1"></a>μ~s,t~= exp(β~t~+ ω~s~),</span>
<span id="cb127-146"><a href="#cb127-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-147"><a href="#cb127-147" aria-hidden="true" tabindex="-1"></a>μ~s,t~= log(y~s,t~ ),</span>
<span id="cb127-148"><a href="#cb127-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-149"><a href="#cb127-149" aria-hidden="true" tabindex="-1"></a>y~s,t~ \~ Tweedie (μ~s,t~ ,p, φ) , ω\~ MVNormal (0,Σ~ω~)</span>
<span id="cb127-150"><a href="#cb127-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-151"><a href="#cb127-151" aria-hidden="true" tabindex="-1"></a>where the modeled egg density (μ~s,t~) follows the Tweedie distribution with a log link function, as egg density is positive, continuous and contains zeros.</span>
<span id="cb127-152"><a href="#cb127-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-153"><a href="#cb127-153" aria-hidden="true" tabindex="-1"></a>y~s,t~ represents eggs density (no of eggs/10m^2^) at space (s) and time(t), μ is the mean density at time and space and p, φ represent power and dispersion parameters of the Tweedie distribution, respectively.</span>
<span id="cb127-154"><a href="#cb127-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-155"><a href="#cb127-155" aria-hidden="true" tabindex="-1"></a>β~t~ are the fixed effects for factor(Year), they represent the average temporal variation</span>
<span id="cb127-156"><a href="#cb127-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-157"><a href="#cb127-157" aria-hidden="true" tabindex="-1"></a>ω~s~ is the spatial random effect, drawn from a GRF with covarianvce matrix Σ~ω~ using Maretn correlation function. It represents the average spatial pattern (nich effect) and it also accounts for spatial variation that is not accounted for by our fixed effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting biomass density but are not accounted for in the model.</span>
<span id="cb127-158"><a href="#cb127-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-159"><a href="#cb127-159" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fit the model</span></span>
<span id="cb127-160"><a href="#cb127-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-161"><a href="#cb127-161" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-162"><a href="#cb127-162" aria-hidden="true" tabindex="-1"></a><span class="in">fit_m1 &lt;- sdmTMB(</span></span>
<span id="cb127-163"><a href="#cb127-163" aria-hidden="true" tabindex="-1"></a><span class="in">  Sp10m3 ~ 0 + Year,</span></span>
<span id="cb127-164"><a href="#cb127-164" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data.eggs,</span></span>
<span id="cb127-165"><a href="#cb127-165" aria-hidden="true" tabindex="-1"></a><span class="in">  mesh = mesh,</span></span>
<span id="cb127-166"><a href="#cb127-166" aria-hidden="true" tabindex="-1"></a><span class="in">  family = tweedie(link = "log"),</span></span>
<span id="cb127-167"><a href="#cb127-167" aria-hidden="true" tabindex="-1"></a><span class="in">  spatial = "on"</span></span>
<span id="cb127-168"><a href="#cb127-168" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb127-169"><a href="#cb127-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-170"><a href="#cb127-170" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-171"><a href="#cb127-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-172"><a href="#cb127-172" aria-hidden="true" tabindex="-1"></a><span class="fu">### Results of the fit</span></span>
<span id="cb127-173"><a href="#cb127-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-174"><a href="#cb127-174" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-175"><a href="#cb127-175" aria-hidden="true" tabindex="-1"></a><span class="in">fit_m1  </span></span>
<span id="cb127-176"><a href="#cb127-176" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-177"><a href="#cb127-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-178"><a href="#cb127-178" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Confidence intervals of fixed effects</span></span>
<span id="cb127-179"><a href="#cb127-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-180"><a href="#cb127-180" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-181"><a href="#cb127-181" aria-hidden="true" tabindex="-1"></a><span class="in">fix_effects&lt;- tidy(fit_m1, conf.int = TRUE)</span></span>
<span id="cb127-182"><a href="#cb127-182" aria-hidden="true" tabindex="-1"></a><span class="in">fix_effects</span></span>
<span id="cb127-183"><a href="#cb127-183" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-184"><a href="#cb127-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-185"><a href="#cb127-185" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Confidence intervals of random effect and variance parameters</span></span>
<span id="cb127-186"><a href="#cb127-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-187"><a href="#cb127-187" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-188"><a href="#cb127-188" aria-hidden="true" tabindex="-1"></a><span class="in">random_effects&lt;- tidy(fit_m1, effects = "ran_pars", conf.int = TRUE)</span></span>
<span id="cb127-189"><a href="#cb127-189" aria-hidden="true" tabindex="-1"></a><span class="in">random_effects</span></span>
<span id="cb127-190"><a href="#cb127-190" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-191"><a href="#cb127-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-192"><a href="#cb127-192" aria-hidden="true" tabindex="-1"></a>Other than the effect of the spatial random field you have: :</span>
<span id="cb127-193"><a href="#cb127-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-194"><a href="#cb127-194" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Matérn range: the distance at witch you have no correlation - similar to the variogram range</span>
<span id="cb127-195"><a href="#cb127-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-196"><a href="#cb127-196" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>phi (φ) &amp; tweedie_p (p): the dispersion parameter and the power of the Tweedie distribution, respectively.</span>
<span id="cb127-197"><a href="#cb127-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-198"><a href="#cb127-198" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Plot the all the effects</span></span>
<span id="cb127-199"><a href="#cb127-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-200"><a href="#cb127-200" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-201"><a href="#cb127-201" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb127-202"><a href="#cb127-202" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = fix_effects, aes(x = estimate, y = term, col = term)) + </span></span>
<span id="cb127-203"><a href="#cb127-203" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(data = fix_effects, aes(y = term, xmin = conf.low, xmax = conf.high, color = term), width = 0.2) +  </span></span>
<span id="cb127-204"><a href="#cb127-204" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = random_effects %&gt;% filter(term == "sigma_O"), aes(x = estimate, y = term)) +  </span></span>
<span id="cb127-205"><a href="#cb127-205" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(data = random_effects %&gt;% filter(term == "sigma_O"), aes(y = term, xmin = conf.low, xmax = conf.high), width = 0.2) +  </span></span>
<span id="cb127-206"><a href="#cb127-206" aria-hidden="true" tabindex="-1"></a><span class="in">  labs( title = expression("Mean and 95% confidence intervals of the fixed &amp; random effects," ~ m[1]),       </span></span>
<span id="cb127-207"><a href="#cb127-207" aria-hidden="true" tabindex="-1"></a><span class="in">        subtitle = expression(mu[s~t] ~ "=" ~ exp(beta[t] + omega[s]))) +</span></span>
<span id="cb127-208"><a href="#cb127-208" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw() +</span></span>
<span id="cb127-209"><a href="#cb127-209" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "none")</span></span>
<span id="cb127-210"><a href="#cb127-210" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-211"><a href="#cb127-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-212"><a href="#cb127-212" aria-hidden="true" tabindex="-1"></a>You can see that the effect of spatial term is the most "important" one. Space is the more influential parameter in egg distribution in this model.</span>
<span id="cb127-213"><a href="#cb127-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-214"><a href="#cb127-214" aria-hidden="true" tabindex="-1"></a><span class="fu">### Diagnostics</span></span>
<span id="cb127-215"><a href="#cb127-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-216"><a href="#cb127-216" aria-hidden="true" tabindex="-1"></a>What do you check?</span>
<span id="cb127-217"><a href="#cb127-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-218"><a href="#cb127-218" aria-hidden="true" tabindex="-1"></a>Residuals?</span>
<span id="cb127-219"><a href="#cb127-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-220"><a href="#cb127-220" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-221"><a href="#cb127-221" aria-hidden="true" tabindex="-1"></a><span class="in">sanity(fit_m1)</span></span>
<span id="cb127-222"><a href="#cb127-222" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-223"><a href="#cb127-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-224"><a href="#cb127-224" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prediction</span></span>
<span id="cb127-225"><a href="#cb127-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-226"><a href="#cb127-226" aria-hidden="true" tabindex="-1"></a>You now perform a prediction in you prediction grid using the fitted model m~1~. When you visualize your prediction in a map you can visualize your final prediction your model (eg. the estimated number of eggs) or you can visualize separately each part of the decomposition (the effect of the fixed covariates and the effect of the random fields (ω~s~, ε~s,t~) and see what is going on.</span>
<span id="cb127-227"><a href="#cb127-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-228"><a href="#cb127-228" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-229"><a href="#cb127-229" aria-hidden="true" tabindex="-1"></a><span class="in">#Predict in the prediction grid that has been created above</span></span>
<span id="cb127-230"><a href="#cb127-230" aria-hidden="true" tabindex="-1"></a><span class="in">p_m1 &lt;- predict(fit_m1, newdata = grid_yrs)</span></span>
<span id="cb127-231"><a href="#cb127-231" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-232"><a href="#cb127-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-233"><a href="#cb127-233" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Full (fixed and random effects) model m~1~ prediction</span></span>
<span id="cb127-234"><a href="#cb127-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-235"><a href="#cb127-235" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-236"><a href="#cb127-236" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m1 &lt;- ggplot(data=p_m1, aes(X, Y, fill = exp(est))) + </span></span>
<span id="cb127-237"><a href="#cb127-237" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() + facet_wrap(vars(Year)) +</span></span>
<span id="cb127-238"><a href="#cb127-238" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb127-239"><a href="#cb127-239" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (fixed effects +  random effects) based on full m1",</span></span>
<span id="cb127-240"><a href="#cb127-240" aria-hidden="true" tabindex="-1"></a><span class="in">subtitle = expression("The estimated density of eggs " * log(mu[st]) * ": " * mu[st] == exp(beta[t] + omega[s])))</span></span>
<span id="cb127-241"><a href="#cb127-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-242"><a href="#cb127-242" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m1</span></span>
<span id="cb127-243"><a href="#cb127-243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-244"><a href="#cb127-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-245"><a href="#cb127-245" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fixed effect in the of prediction model m~1~</span></span>
<span id="cb127-246"><a href="#cb127-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-247"><a href="#cb127-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-248"><a href="#cb127-248" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m1 &lt;- ggplot(data=p_m1, aes(X, Y, fill = exp(est_non_rf))) + </span></span>
<span id="cb127-249"><a href="#cb127-249" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() + facet_wrap(vars(Year)) +</span></span>
<span id="cb127-250"><a href="#cb127-250" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb127-251"><a href="#cb127-251" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (fixed effects only) based on full m1",</span></span>
<span id="cb127-252"><a href="#cb127-252" aria-hidden="true" tabindex="-1"></a><span class="in">          subtitle = expression("The effect of time in the estimated variable " * (beta[t]) * ": " * mu[st] == exp(beta[t] + omega[s])))</span></span>
<span id="cb127-253"><a href="#cb127-253" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m1</span></span>
<span id="cb127-254"><a href="#cb127-254" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-255"><a href="#cb127-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-256"><a href="#cb127-256" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Random effect in the prediction of model m~1~</span></span>
<span id="cb127-257"><a href="#cb127-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-258"><a href="#cb127-258" aria-hidden="true" tabindex="-1"></a>Here spatial random effect only</span>
<span id="cb127-259"><a href="#cb127-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-260"><a href="#cb127-260" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-261"><a href="#cb127-261" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m1 &lt;- ggplot(data=p_m1, aes(X, Y, fill = exp(omega_s))) + </span></span>
<span id="cb127-262"><a href="#cb127-262" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() +</span></span>
<span id="cb127-263"><a href="#cb127-263" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb127-264"><a href="#cb127-264" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (random effects only) based on full m1",</span></span>
<span id="cb127-265"><a href="#cb127-265" aria-hidden="true" tabindex="-1"></a><span class="in">          subtitle = expression("The effect of space in the estimated variable " * (omega[s]) * ": " * mu[st] == exp(beta[t] + omega[s])))</span></span>
<span id="cb127-266"><a href="#cb127-266" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m1</span></span>
<span id="cb127-267"><a href="#cb127-267" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-268"><a href="#cb127-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-269"><a href="#cb127-269" aria-hidden="true" tabindex="-1"></a>For the ω~s~ we have only one map because the spatial effect is stable across time. This is the mean spatial effect estimated from your data and it also represents the mean spatial distribution. If you want to see if or how the spatial effect changes in time then you need a spatiotemporal random effect (see m~2~).</span>
<span id="cb127-270"><a href="#cb127-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-271"><a href="#cb127-271" aria-hidden="true" tabindex="-1"></a>This spatial random effect represents variance in space (but consistence through time) coming from the data that are not accounted by the fixed effects. In this model compared to m~1~ the spatial random effect is less influential because a part of the variability is now explained by the spatiotemporal effect term.</span>
<span id="cb127-272"><a href="#cb127-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-273"><a href="#cb127-273" aria-hidden="true" tabindex="-1"></a><span class="fu">## MODEL 2 (m~2~) : Spatiotemporal model</span></span>
<span id="cb127-274"><a href="#cb127-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-275"><a href="#cb127-275" aria-hidden="true" tabindex="-1"></a>The 2^nd^ model (m~2~) follows that formula:</span>
<span id="cb127-276"><a href="#cb127-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-277"><a href="#cb127-277" aria-hidden="true" tabindex="-1"></a>μ~s,t~= exp(β~t~+ ω~s~ + ε~s,t~),</span>
<span id="cb127-278"><a href="#cb127-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-279"><a href="#cb127-279" aria-hidden="true" tabindex="-1"></a>μ~s,t~= log(y~s,t~ ),</span>
<span id="cb127-280"><a href="#cb127-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-281"><a href="#cb127-281" aria-hidden="true" tabindex="-1"></a>y~s,t~ \~ Tweedie (μ~s,t~ ,p, φ) , ω\~ MVNormal (0,Σ~ω~) , ε~t~ \~ MVNormal (0,Σ~t~)</span>
<span id="cb127-282"><a href="#cb127-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-283"><a href="#cb127-283" aria-hidden="true" tabindex="-1"></a>where the modeled egg density (μ~s,t~) follows the Tweedie distribution with a log link function, as egg density is positive, continuous and contains zeros.</span>
<span id="cb127-284"><a href="#cb127-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-285"><a href="#cb127-285" aria-hidden="true" tabindex="-1"></a>y~s,t~ represents eggs density (no of eggs/10m^2^) at space (s) and time(t), μ is the mean density at time and space and p, φ represent power and dispersion parameters of the Tweedie distribution, respectively.</span>
<span id="cb127-286"><a href="#cb127-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-287"><a href="#cb127-287" aria-hidden="true" tabindex="-1"></a>β~t~ are the fixed effects for factor(Year), they represent the average temporal variation</span>
<span id="cb127-288"><a href="#cb127-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-289"><a href="#cb127-289" aria-hidden="true" tabindex="-1"></a>ω~s~ is the spatial random effect, drawn from a GRF with covarianvce matrix Σ~ω~ using Maretn correlation function. It represents the average spatial pattern (nich effect) and it also accounts for spatial variation that is not accounted for by our fixed effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting biomass density but are not accounted for in the model.</span>
<span id="cb127-290"><a href="#cb127-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-291"><a href="#cb127-291" aria-hidden="true" tabindex="-1"></a>ε~s,t~ represents the spatiotemporal random effect, drawn from a GRF with covarianvce matrix Σ~ε~. They represents how the average spatial pattern change through year so they also for spatial variation that is not accounted for by our fixed effects and the spatial random effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting our study variable but are not accounted for in the model.</span>
<span id="cb127-292"><a href="#cb127-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-293"><a href="#cb127-293" aria-hidden="true" tabindex="-1"></a>In this model Spatiotemporal random fields are considered independent and identically distributed each single year (spatiotemporal = "IID") and Maretn correlation function to accounts for spatial autocorrelation.</span>
<span id="cb127-294"><a href="#cb127-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-295"><a href="#cb127-295" aria-hidden="true" tabindex="-1"></a>*Are there other options for spatiotemporal fields:*</span>
<span id="cb127-296"><a href="#cb127-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-297"><a href="#cb127-297" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*"AR1": first-order autoregressive (each random filed is correlated to the one of the previous year )*</span>
<span id="cb127-298"><a href="#cb127-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-299"><a href="#cb127-299" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*"RW": random walk (each random filed starts fro where it was last year plus a completely independent deviation)*</span>
<span id="cb127-300"><a href="#cb127-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-301"><a href="#cb127-301" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fit the model</span></span>
<span id="cb127-302"><a href="#cb127-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-303"><a href="#cb127-303" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-304"><a href="#cb127-304" aria-hidden="true" tabindex="-1"></a><span class="in">fit_m2 &lt;- sdmTMB(</span></span>
<span id="cb127-305"><a href="#cb127-305" aria-hidden="true" tabindex="-1"></a><span class="in">  Sp10m3 ~ 0 + Year,</span></span>
<span id="cb127-306"><a href="#cb127-306" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data.eggs,</span></span>
<span id="cb127-307"><a href="#cb127-307" aria-hidden="true" tabindex="-1"></a><span class="in">  mesh = mesh,</span></span>
<span id="cb127-308"><a href="#cb127-308" aria-hidden="true" tabindex="-1"></a><span class="in">  family = tweedie(link = "log"),</span></span>
<span id="cb127-309"><a href="#cb127-309" aria-hidden="true" tabindex="-1"></a><span class="in">  spatial = "on",</span></span>
<span id="cb127-310"><a href="#cb127-310" aria-hidden="true" tabindex="-1"></a><span class="in">  spatiotemporal = "IID",   </span></span>
<span id="cb127-311"><a href="#cb127-311" aria-hidden="true" tabindex="-1"></a><span class="in">  time = "time")</span></span>
<span id="cb127-312"><a href="#cb127-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-313"><a href="#cb127-313" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-314"><a href="#cb127-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-315"><a href="#cb127-315" aria-hidden="true" tabindex="-1"></a><span class="fu">### Results of the fit</span></span>
<span id="cb127-316"><a href="#cb127-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-317"><a href="#cb127-317" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-318"><a href="#cb127-318" aria-hidden="true" tabindex="-1"></a><span class="in">fit_m2</span></span>
<span id="cb127-319"><a href="#cb127-319" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-320"><a href="#cb127-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-321"><a href="#cb127-321" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Confidence intervals of fixed effects</span></span>
<span id="cb127-322"><a href="#cb127-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-323"><a href="#cb127-323" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-324"><a href="#cb127-324" aria-hidden="true" tabindex="-1"></a><span class="in">fix_effects&lt;- tidy(fit_m2, conf.int = TRUE)</span></span>
<span id="cb127-325"><a href="#cb127-325" aria-hidden="true" tabindex="-1"></a><span class="in">fix_effects</span></span>
<span id="cb127-326"><a href="#cb127-326" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-327"><a href="#cb127-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-328"><a href="#cb127-328" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Confidence intervals of random effects and variance parameters</span></span>
<span id="cb127-329"><a href="#cb127-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-330"><a href="#cb127-330" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-331"><a href="#cb127-331" aria-hidden="true" tabindex="-1"></a><span class="in">random_effects&lt;- tidy(fit_m2, effects = "ran_pars", conf.int = TRUE)</span></span>
<span id="cb127-332"><a href="#cb127-332" aria-hidden="true" tabindex="-1"></a><span class="in">random_effects</span></span>
<span id="cb127-333"><a href="#cb127-333" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-334"><a href="#cb127-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-335"><a href="#cb127-335" aria-hidden="true" tabindex="-1"></a>Other than the effect of the spatial random (sigma_O) and the spatiotemporal random field (sigma_E) field you have: :</span>
<span id="cb127-336"><a href="#cb127-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-337"><a href="#cb127-337" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Matérn range: the distance at witch you have no correlation - similar to the variogram range</span>
<span id="cb127-338"><a href="#cb127-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-339"><a href="#cb127-339" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>phi (φ) &amp; tweedie_p (p): the dispersion parameter and the power of the Tweedie distribution, respectively.</span>
<span id="cb127-340"><a href="#cb127-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-341"><a href="#cb127-341" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Plot the all the effects</span></span>
<span id="cb127-342"><a href="#cb127-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-343"><a href="#cb127-343" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-344"><a href="#cb127-344" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb127-345"><a href="#cb127-345" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = fix_effects, aes(x = estimate, y = term, col = term)) + </span></span>
<span id="cb127-346"><a href="#cb127-346" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(data = fix_effects, aes(y = term, xmin = conf.low, xmax = conf.high, color = term), width = 0.2) +  </span></span>
<span id="cb127-347"><a href="#cb127-347" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = random_effects %&gt;% filter(term == c("sigma_O","sigma_E")), aes(x = estimate, y = term)) +  </span></span>
<span id="cb127-348"><a href="#cb127-348" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(data = random_effects %&gt;% filter(term == c("sigma_O","sigma_E")), aes(y = term, xmin = conf.low, xmax = conf.high), width = 0.2) +  </span></span>
<span id="cb127-349"><a href="#cb127-349" aria-hidden="true" tabindex="-1"></a><span class="in">  labs( title = expression("Mean and 95% confidence intervals of the fixed &amp; random effects," ~ m[2]),       </span></span>
<span id="cb127-350"><a href="#cb127-350" aria-hidden="true" tabindex="-1"></a><span class="in">        subtitle = expression(mu[s~t] ~ "=" ~ exp(beta[t] + omega[s] +epsilon[st]))) +</span></span>
<span id="cb127-351"><a href="#cb127-351" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw() +</span></span>
<span id="cb127-352"><a href="#cb127-352" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "none")</span></span>
<span id="cb127-353"><a href="#cb127-353" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-354"><a href="#cb127-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-355"><a href="#cb127-355" aria-hidden="true" tabindex="-1"></a>You can see that the effect of spatial term is steal the most "important" one. But a lot of is effect is now explained by the spatiotemporal effect.</span>
<span id="cb127-356"><a href="#cb127-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-357"><a href="#cb127-357" aria-hidden="true" tabindex="-1"></a><span class="fu">### Diagnostics</span></span>
<span id="cb127-358"><a href="#cb127-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-359"><a href="#cb127-359" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-360"><a href="#cb127-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-361"><a href="#cb127-361" aria-hidden="true" tabindex="-1"></a><span class="in">sanity(fit_m2)</span></span>
<span id="cb127-362"><a href="#cb127-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-363"><a href="#cb127-363" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-364"><a href="#cb127-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-365"><a href="#cb127-365" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prediction</span></span>
<span id="cb127-366"><a href="#cb127-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-367"><a href="#cb127-367" aria-hidden="true" tabindex="-1"></a>You can steel predict in the same grid as m~1~ as no more covariates have been added to the model.</span>
<span id="cb127-368"><a href="#cb127-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-369"><a href="#cb127-369" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-370"><a href="#cb127-370" aria-hidden="true" tabindex="-1"></a><span class="in">p_m2 &lt;- predict(fit_m2, newdata = grid_yrs)</span></span>
<span id="cb127-371"><a href="#cb127-371" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-372"><a href="#cb127-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-373"><a href="#cb127-373" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Full (fixed and random effects) model m~2~ prediction</span></span>
<span id="cb127-374"><a href="#cb127-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-375"><a href="#cb127-375" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-376"><a href="#cb127-376" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2 &lt;- ggplot(data=p_m2, aes(X, Y, fill = exp(est))) + </span></span>
<span id="cb127-377"><a href="#cb127-377" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() + facet_wrap(vars(Year)) +</span></span>
<span id="cb127-378"><a href="#cb127-378" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb127-379"><a href="#cb127-379" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (fixed effects +  random effects) based on full m2",</span></span>
<span id="cb127-380"><a href="#cb127-380" aria-hidden="true" tabindex="-1"></a><span class="in">subtitle = expression("The estimated density of eggs " * log(mu[st]) * ": " * mu[st] == exp(beta[t] + omega[s]+ epsilon[st])))</span></span>
<span id="cb127-381"><a href="#cb127-381" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2</span></span>
<span id="cb127-382"><a href="#cb127-382" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-383"><a href="#cb127-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-384"><a href="#cb127-384" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fixed effect in the prediction of model m~2~</span></span>
<span id="cb127-385"><a href="#cb127-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-386"><a href="#cb127-386" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-387"><a href="#cb127-387" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2 &lt;- ggplot(data=p_m2, aes(X, Y, fill = exp(est_non_rf))) + </span></span>
<span id="cb127-388"><a href="#cb127-388" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() + facet_wrap(vars(Year)) +</span></span>
<span id="cb127-389"><a href="#cb127-389" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb127-390"><a href="#cb127-390" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (fixed effects only) based on full m2",</span></span>
<span id="cb127-391"><a href="#cb127-391" aria-hidden="true" tabindex="-1"></a><span class="in">          subtitle = expression("The effect of time in the estimated variable " * (beta[t]) * ": " * mu[st] == exp(beta[t] + omega[s]+ epsilon[st])))</span></span>
<span id="cb127-392"><a href="#cb127-392" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2</span></span>
<span id="cb127-393"><a href="#cb127-393" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-394"><a href="#cb127-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-395"><a href="#cb127-395" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Random effects in the prediction of model m~2~</span></span>
<span id="cb127-396"><a href="#cb127-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-397"><a href="#cb127-397" aria-hidden="true" tabindex="-1"></a>Here spatial &amp; spatiotemporal random effects</span>
<span id="cb127-398"><a href="#cb127-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-399"><a href="#cb127-399" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Plot the spatial random effect</span></span>
<span id="cb127-400"><a href="#cb127-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-401"><a href="#cb127-401" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-402"><a href="#cb127-402" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2 &lt;- ggplot(data=p_m2, aes(X, Y, fill = exp(omega_s))) + </span></span>
<span id="cb127-403"><a href="#cb127-403" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() +</span></span>
<span id="cb127-404"><a href="#cb127-404" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb127-405"><a href="#cb127-405" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (spatial random effect) based on full m2",</span></span>
<span id="cb127-406"><a href="#cb127-406" aria-hidden="true" tabindex="-1"></a><span class="in">          subtitle = expression("The effect of space in the estimated variable " * (omega[s]) * ": " * mu[st] == exp(beta[t] + omega[s] + epsilon[st])))</span></span>
<span id="cb127-407"><a href="#cb127-407" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2</span></span>
<span id="cb127-408"><a href="#cb127-408" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-409"><a href="#cb127-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-410"><a href="#cb127-410" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Plot the spatotemporal random effect</span></span>
<span id="cb127-411"><a href="#cb127-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-412"><a href="#cb127-412" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-413"><a href="#cb127-413" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2 &lt;- ggplot(data=p_m2, aes(X, Y, fill = exp(epsilon_st))) + </span></span>
<span id="cb127-414"><a href="#cb127-414" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() +</span></span>
<span id="cb127-415"><a href="#cb127-415" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(Year)) +</span></span>
<span id="cb127-416"><a href="#cb127-416" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb127-417"><a href="#cb127-417" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (spatiotemporal random effect) based on full m2",</span></span>
<span id="cb127-418"><a href="#cb127-418" aria-hidden="true" tabindex="-1"></a><span class="in">          subtitle = expression("The effect of space through time in the estimated variable " * (epsilon[st]) * ": " * mu[st] == exp(beta[t] + omega[s] + epsilon[st])))</span></span>
<span id="cb127-419"><a href="#cb127-419" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2</span></span>
<span id="cb127-420"><a href="#cb127-420" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-421"><a href="#cb127-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-422"><a href="#cb127-422" aria-hidden="true" tabindex="-1"></a>The spatiptempral random effect represent deviation from the fixed effect predictions and the spatial random effect deviations. These represent changes in the spatial paternal through time that are forced by parameters not accounted for in the model.</span>
<span id="cb127-423"><a href="#cb127-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-424"><a href="#cb127-424" aria-hidden="true" tabindex="-1"></a><span class="fu">## MODEL 3 (m~3~) : Spatiotemporal model with covariates.</span></span>
<span id="cb127-425"><a href="#cb127-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-426"><a href="#cb127-426" aria-hidden="true" tabindex="-1"></a>Now letts add a variable.</span>
<span id="cb127-427"><a href="#cb127-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-428"><a href="#cb127-428" aria-hidden="true" tabindex="-1"></a>The 3^nd^ model (m~3~) will be a spatiotemporal model with Temperature as a covariate :</span>
<span id="cb127-429"><a href="#cb127-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-430"><a href="#cb127-430" aria-hidden="true" tabindex="-1"></a>μ~s,t~= exp(X~s,t~β+β~t~+ ω~s~ + ε~s,t~),</span>
<span id="cb127-431"><a href="#cb127-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-432"><a href="#cb127-432" aria-hidden="true" tabindex="-1"></a>μ~s,t~= log(y~s,t~ ),</span>
<span id="cb127-433"><a href="#cb127-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-434"><a href="#cb127-434" aria-hidden="true" tabindex="-1"></a>y~s,t~ \~ Tweedie (μ~s,t~ ,p, φ) , ω\~ MVNormal (0,Σ~ω~) , ε~t~ \~ MVNormal (0,Σ~t~)</span>
<span id="cb127-435"><a href="#cb127-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-436"><a href="#cb127-436" aria-hidden="true" tabindex="-1"></a>where the modeled egg density (μ~s,t~) follows the Tweedie distribution with a log link function, as egg density is positive, continuous and contains zeros.</span>
<span id="cb127-437"><a href="#cb127-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-438"><a href="#cb127-438" aria-hidden="true" tabindex="-1"></a>y~s,t~ represent eggs density (no of eggs/10m^2^) at space (s) and time(t), μ is the mean density at time and space and p, φ represent power and dispersion parameters of the Tweedie distribution, respectively.</span>
<span id="cb127-439"><a href="#cb127-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-440"><a href="#cb127-440" aria-hidden="true" tabindex="-1"></a>X~s,t,~ is the design matrix with covariates temperature and year as factor. Temperature is modeled with a smooth function.</span>
<span id="cb127-441"><a href="#cb127-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-442"><a href="#cb127-442" aria-hidden="true" tabindex="-1"></a>β is a vector with the fixed effect coefficients (here only temperature)</span>
<span id="cb127-443"><a href="#cb127-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-444"><a href="#cb127-444" aria-hidden="true" tabindex="-1"></a>β~t~ are the fixed effects for factor(Year), they represent the average temporal variation</span>
<span id="cb127-445"><a href="#cb127-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-446"><a href="#cb127-446" aria-hidden="true" tabindex="-1"></a>ω~s~ is the spatial random effect, drawn from a GRF with covarianvce matrix Σ~ω~ using Maretn correlation function. It represents the average spatial pattern (nich effect) and it also accounts for spatial variation that is not accounted for by our fixed effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting biomass density but are not accounted for in the model.</span>
<span id="cb127-447"><a href="#cb127-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-448"><a href="#cb127-448" aria-hidden="true" tabindex="-1"></a>ε~s,t~ represents the spatiotemporal random effect, drawn from a GRF with covarianvce matrix Σ~ε~. They represents how the average spatial pattern change through year so they also for spatial variation that is not accounted for by our fixed effects and the spatial random effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting our study variable but are not accounted for in the model.</span>
<span id="cb127-449"><a href="#cb127-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-450"><a href="#cb127-450" aria-hidden="true" tabindex="-1"></a>In this model Spatiotemporal random fields are considered independent and identically distributed each single year (spatiotemporal = "IID") and Maretn correlation function to accounts for spatial autocorrelation.</span>
<span id="cb127-451"><a href="#cb127-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-452"><a href="#cb127-452" aria-hidden="true" tabindex="-1"></a>To fit the new model we need to</span>
<span id="cb127-453"><a href="#cb127-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-454"><a href="#cb127-454" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Check the data are ok (mainly covariates)</span>
<span id="cb127-455"><a href="#cb127-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-456"><a href="#cb127-456" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Create new mesh based on the new data sets (some data points are removed)</span>
<span id="cb127-457"><a href="#cb127-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-458"><a href="#cb127-458" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Create a new prediction grid containing all the covariates (the <span class="co">[</span><span class="ot">@lindmark2023</span><span class="co">]</span> approach is used, see intro)</span>
<span id="cb127-459"><a href="#cb127-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-460"><a href="#cb127-460" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prepare the data</span></span>
<span id="cb127-461"><a href="#cb127-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-462"><a href="#cb127-462" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-463"><a href="#cb127-463" aria-hidden="true" tabindex="-1"></a><span class="in">summary(data.eggs$Tempsbe)</span></span>
<span id="cb127-464"><a href="#cb127-464" aria-hidden="true" tabindex="-1"></a><span class="in">hist(data.eggs$Tempsbe)</span></span>
<span id="cb127-465"><a href="#cb127-465" aria-hidden="true" tabindex="-1"></a><span class="in">data.temp=data.eggs[data.eggs$Tempsbe&gt;=0 &amp; data.eggs$Tempsbe&lt;30 &amp; !is.na(data.eggs$Tempsbe),]</span></span>
<span id="cb127-466"><a href="#cb127-466" aria-hidden="true" tabindex="-1"></a><span class="in">hist(data.temp$Tempsbe)</span></span>
<span id="cb127-467"><a href="#cb127-467" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-468"><a href="#cb127-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-469"><a href="#cb127-469" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create the mesh</span></span>
<span id="cb127-470"><a href="#cb127-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-471"><a href="#cb127-471" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-472"><a href="#cb127-472" aria-hidden="true" tabindex="-1"></a><span class="in">mesh &lt;- make_mesh(data.temp, xy_cols = c("X", "Y"), cutoff = 30)</span></span>
<span id="cb127-473"><a href="#cb127-473" aria-hidden="true" tabindex="-1"></a><span class="in">plot(mesh)</span></span>
<span id="cb127-474"><a href="#cb127-474" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-475"><a href="#cb127-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-476"><a href="#cb127-476" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create the prediction grid</span></span>
<span id="cb127-477"><a href="#cb127-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-478"><a href="#cb127-478" aria-hidden="true" tabindex="-1"></a>We first fit a spatiotemporal model (m~temp~) for temperature and then we predict temperature in the prediction grid that we already have. The results of this prediction will be the new prediction grid for the m~3~.</span>
<span id="cb127-479"><a href="#cb127-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-480"><a href="#cb127-480" aria-hidden="true" tabindex="-1"></a><span class="fu">#### **MODEL Temp (m\~temp) : Spatio-temoral model for temperature**</span></span>
<span id="cb127-481"><a href="#cb127-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-482"><a href="#cb127-482" aria-hidden="true" tabindex="-1"></a>The temperature model (m~temp~) follows that formula:</span>
<span id="cb127-483"><a href="#cb127-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-484"><a href="#cb127-484" aria-hidden="true" tabindex="-1"></a>μ~s,t~= exp(β~t~+ ω~s~ + ε~s,t~),</span>
<span id="cb127-485"><a href="#cb127-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-486"><a href="#cb127-486" aria-hidden="true" tabindex="-1"></a>μ~s,t~= y~s,t~ ,</span>
<span id="cb127-487"><a href="#cb127-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-488"><a href="#cb127-488" aria-hidden="true" tabindex="-1"></a>y~s,t~ \~ Normal (μ~s,t~ σ^2^) , ω\~ MVNormal (0,Σ~ω~) , ε~t~ \~ MVNormal (0,Σ~t~)</span>
<span id="cb127-489"><a href="#cb127-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-490"><a href="#cb127-490" aria-hidden="true" tabindex="-1"></a>where the modeled temperature (μ~s,t~) followe a Gaussian distribution without a link function.</span>
<span id="cb127-491"><a href="#cb127-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-492"><a href="#cb127-492" aria-hidden="true" tabindex="-1"></a>y~s,t~ represents temperature at space (s) and time(t), μ is the mean density at time and space and and σ^2^ been the variance.</span>
<span id="cb127-493"><a href="#cb127-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-494"><a href="#cb127-494" aria-hidden="true" tabindex="-1"></a>β~t~ are the fixed effects for factor(Year), they represent the average temporal variation</span>
<span id="cb127-495"><a href="#cb127-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-496"><a href="#cb127-496" aria-hidden="true" tabindex="-1"></a>ω~s~ is the spatial random effect, drawn from a GRF with covarianvce matrix Σ~ω~ using Maretn correlation function.</span>
<span id="cb127-497"><a href="#cb127-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-498"><a href="#cb127-498" aria-hidden="true" tabindex="-1"></a>ε~s,t~ represents the spatiotemporal random effect, drawn from a GRF with covarianvce matrix Σ~ε~. Spatiotemporal random fields are considered independent and identically distributed each single year (spatiotemporal = "IID") and Maretn correlation function to account for spatial autocorrelation.</span>
<span id="cb127-499"><a href="#cb127-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-500"><a href="#cb127-500" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Fit the model</span></span>
<span id="cb127-501"><a href="#cb127-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-502"><a href="#cb127-502" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-503"><a href="#cb127-503" aria-hidden="true" tabindex="-1"></a><span class="in">fit_temp &lt;- sdmTMB(</span></span>
<span id="cb127-504"><a href="#cb127-504" aria-hidden="true" tabindex="-1"></a><span class="in">  Tempsbe ~ 0 + Year,</span></span>
<span id="cb127-505"><a href="#cb127-505" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data.temp,</span></span>
<span id="cb127-506"><a href="#cb127-506" aria-hidden="true" tabindex="-1"></a><span class="in">  mesh = mesh,</span></span>
<span id="cb127-507"><a href="#cb127-507" aria-hidden="true" tabindex="-1"></a><span class="in">  family = gaussian(link = "identity"),</span></span>
<span id="cb127-508"><a href="#cb127-508" aria-hidden="true" tabindex="-1"></a><span class="in">  spatial = "on",</span></span>
<span id="cb127-509"><a href="#cb127-509" aria-hidden="true" tabindex="-1"></a><span class="in">  spatiotemporal='IID',</span></span>
<span id="cb127-510"><a href="#cb127-510" aria-hidden="true" tabindex="-1"></a><span class="in">  time='time'</span></span>
<span id="cb127-511"><a href="#cb127-511" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb127-512"><a href="#cb127-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-513"><a href="#cb127-513" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-514"><a href="#cb127-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-515"><a href="#cb127-515" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Results of the fit</span></span>
<span id="cb127-516"><a href="#cb127-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-517"><a href="#cb127-517" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-518"><a href="#cb127-518" aria-hidden="true" tabindex="-1"></a><span class="in">fit_temp</span></span>
<span id="cb127-519"><a href="#cb127-519" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-520"><a href="#cb127-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-521"><a href="#cb127-521" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Confidence intervals of fixed effects</span></span>
<span id="cb127-522"><a href="#cb127-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-523"><a href="#cb127-523" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-524"><a href="#cb127-524" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(fit_temp, conf.int = TRUE)</span></span>
<span id="cb127-525"><a href="#cb127-525" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-526"><a href="#cb127-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-527"><a href="#cb127-527" aria-hidden="true" tabindex="-1"></a><span class="fu">###### Confidence intervals of random effects and variance parameters</span></span>
<span id="cb127-528"><a href="#cb127-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-529"><a href="#cb127-529" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-530"><a href="#cb127-530" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(fit_temp, effects = "ran_pars", conf.int = TRUE)</span></span>
<span id="cb127-531"><a href="#cb127-531" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-532"><a href="#cb127-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-533"><a href="#cb127-533" aria-hidden="true" tabindex="-1"></a><span class="fu">###### Diagnostics</span></span>
<span id="cb127-534"><a href="#cb127-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-535"><a href="#cb127-535" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-536"><a href="#cb127-536" aria-hidden="true" tabindex="-1"></a><span class="in">sanity(fit_temp)</span></span>
<span id="cb127-537"><a href="#cb127-537" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-538"><a href="#cb127-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-539"><a href="#cb127-539" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Prediction</span></span>
<span id="cb127-540"><a href="#cb127-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-541"><a href="#cb127-541" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-542"><a href="#cb127-542" aria-hidden="true" tabindex="-1"></a><span class="in">p_temp &lt;- predict(fit_temp, newdata = grid_yrs)</span></span>
<span id="cb127-543"><a href="#cb127-543" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-544"><a href="#cb127-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-545"><a href="#cb127-545" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-546"><a href="#cb127-546" aria-hidden="true" tabindex="-1"></a><span class="in">plot_temp &lt;- ggplot(data=p_temp, aes(X, Y, fill = est)) + </span></span>
<span id="cb127-547"><a href="#cb127-547" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() + facet_wrap(vars(Year)) +</span></span>
<span id="cb127-548"><a href="#cb127-548" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "identity") +</span></span>
<span id="cb127-549"><a href="#cb127-549" aria-hidden="true" tabindex="-1"></a><span class="in">    ggtitle("Prediction (fixed effects + random effects) based on m_temp",</span></span>
<span id="cb127-550"><a href="#cb127-550" aria-hidden="true" tabindex="-1"></a><span class="in">subtitle = expression("The estimated temperatures " (mu[st]) * ": " * mu[st] == (beta[t] + omega[s]+ epsilon[st])))</span></span>
<span id="cb127-551"><a href="#cb127-551" aria-hidden="true" tabindex="-1"></a><span class="in">plot_temp</span></span>
<span id="cb127-552"><a href="#cb127-552" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-553"><a href="#cb127-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-554"><a href="#cb127-554" aria-hidden="true" tabindex="-1"></a>This prediction output will be the prediction grid for m~3~.</span>
<span id="cb127-555"><a href="#cb127-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-556"><a href="#cb127-556" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fit the model m~3~</span></span>
<span id="cb127-557"><a href="#cb127-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-558"><a href="#cb127-558" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-559"><a href="#cb127-559" aria-hidden="true" tabindex="-1"></a><span class="in">fit_m3 &lt;- sdmTMB(</span></span>
<span id="cb127-560"><a href="#cb127-560" aria-hidden="true" tabindex="-1"></a><span class="in">  Sp10m3 ~ 0 + Year + s(Tempsbe),</span></span>
<span id="cb127-561"><a href="#cb127-561" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data.temp,</span></span>
<span id="cb127-562"><a href="#cb127-562" aria-hidden="true" tabindex="-1"></a><span class="in">  mesh = mesh,</span></span>
<span id="cb127-563"><a href="#cb127-563" aria-hidden="true" tabindex="-1"></a><span class="in">  family = tweedie(link="log"),</span></span>
<span id="cb127-564"><a href="#cb127-564" aria-hidden="true" tabindex="-1"></a><span class="in">  spatial = "on",</span></span>
<span id="cb127-565"><a href="#cb127-565" aria-hidden="true" tabindex="-1"></a><span class="in">  spatiotemporal='IID',</span></span>
<span id="cb127-566"><a href="#cb127-566" aria-hidden="true" tabindex="-1"></a><span class="in">  time='time'</span></span>
<span id="cb127-567"><a href="#cb127-567" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb127-568"><a href="#cb127-568" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-569"><a href="#cb127-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-570"><a href="#cb127-570" aria-hidden="true" tabindex="-1"></a><span class="fu">### Results of the fit</span></span>
<span id="cb127-571"><a href="#cb127-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-572"><a href="#cb127-572" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-573"><a href="#cb127-573" aria-hidden="true" tabindex="-1"></a><span class="in">fit_m3</span></span>
<span id="cb127-574"><a href="#cb127-574" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-575"><a href="#cb127-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-576"><a href="#cb127-576" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Confidence intervals of fixed effects</span></span>
<span id="cb127-577"><a href="#cb127-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-578"><a href="#cb127-578" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-579"><a href="#cb127-579" aria-hidden="true" tabindex="-1"></a><span class="in">fix_effects&lt;- tidy(fit_m3, conf.int = TRUE)</span></span>
<span id="cb127-580"><a href="#cb127-580" aria-hidden="true" tabindex="-1"></a><span class="in">fix_effects</span></span>
<span id="cb127-581"><a href="#cb127-581" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-582"><a href="#cb127-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-583"><a href="#cb127-583" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Confidence intervals of random effects and variance parameters</span></span>
<span id="cb127-584"><a href="#cb127-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-585"><a href="#cb127-585" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-586"><a href="#cb127-586" aria-hidden="true" tabindex="-1"></a><span class="in">random_effects&lt;- tidy(fit_m3, effects = "ran_pars", conf.int = TRUE)</span></span>
<span id="cb127-587"><a href="#cb127-587" aria-hidden="true" tabindex="-1"></a><span class="in">random_effects</span></span>
<span id="cb127-588"><a href="#cb127-588" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-589"><a href="#cb127-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-590"><a href="#cb127-590" aria-hidden="true" tabindex="-1"></a>Other than the effect of the spatial random (sigma_O) and the spatiotemporal random field (sigma_E) field you have:</span>
<span id="cb127-591"><a href="#cb127-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-592"><a href="#cb127-592" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Matérn range: the distance at witch you have no correlation - similar to the variogram range</span>
<span id="cb127-593"><a href="#cb127-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-594"><a href="#cb127-594" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>phi (φ) &amp; tweedie_p (p): the dispersion parameter and the power of the Tweedie distribution, respectively.</span>
<span id="cb127-595"><a href="#cb127-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-596"><a href="#cb127-596" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Plot the all the effects</span></span>
<span id="cb127-597"><a href="#cb127-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-598"><a href="#cb127-598" aria-hidden="true" tabindex="-1"></a>*The effect of Temperature is not in the fixed_effects because we used a smoother. How can I visualize this effect??*</span>
<span id="cb127-599"><a href="#cb127-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-600"><a href="#cb127-600" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-601"><a href="#cb127-601" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb127-602"><a href="#cb127-602" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = fix_effects, aes(x = estimate, y = term, col = term)) + </span></span>
<span id="cb127-603"><a href="#cb127-603" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(data = fix_effects, aes(y = term, xmin = conf.low, xmax = conf.high, color = term), width = 0.2) +  </span></span>
<span id="cb127-604"><a href="#cb127-604" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = random_effects %&gt;% filter(term == c("sigma_O","sigma_E")), aes(x = estimate, y = term)) +  </span></span>
<span id="cb127-605"><a href="#cb127-605" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(data = random_effects %&gt;% filter(term == c("sigma_O","sigma_E")), aes(y = term, xmin = conf.low, xmax = conf.high), width = 0.2) +  </span></span>
<span id="cb127-606"><a href="#cb127-606" aria-hidden="true" tabindex="-1"></a><span class="in">  labs( title = expression("Mean and 95% confidence intervals of the fixed &amp; random effects," ~ m[3]),       </span></span>
<span id="cb127-607"><a href="#cb127-607" aria-hidden="true" tabindex="-1"></a><span class="in">        subtitle = expression(mu[s~t] ~ "=" ~ exp(X[st]* beta + beta[t]+ omega[s] +epsilon[st]))) +</span></span>
<span id="cb127-608"><a href="#cb127-608" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw() +</span></span>
<span id="cb127-609"><a href="#cb127-609" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "none")</span></span>
<span id="cb127-610"><a href="#cb127-610" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-611"><a href="#cb127-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-612"><a href="#cb127-612" aria-hidden="true" tabindex="-1"></a><span class="fu">### Diagnostics</span></span>
<span id="cb127-613"><a href="#cb127-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-614"><a href="#cb127-614" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-615"><a href="#cb127-615" aria-hidden="true" tabindex="-1"></a><span class="in">sanity(fit_m3)</span></span>
<span id="cb127-616"><a href="#cb127-616" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-617"><a href="#cb127-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-618"><a href="#cb127-618" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prediction</span></span>
<span id="cb127-619"><a href="#cb127-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-620"><a href="#cb127-620" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-621"><a href="#cb127-621" aria-hidden="true" tabindex="-1"></a><span class="in">p_temp = p_temp %&gt;% rename(Tempsbe=est) </span></span>
<span id="cb127-622"><a href="#cb127-622" aria-hidden="true" tabindex="-1"></a><span class="in">p_m3 &lt;- predict(fit_m3, newdata = p_temp)</span></span>
<span id="cb127-623"><a href="#cb127-623" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-624"><a href="#cb127-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-625"><a href="#cb127-625" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Full (fixed and random effects) model m~3~ prediction</span></span>
<span id="cb127-626"><a href="#cb127-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-627"><a href="#cb127-627" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-628"><a href="#cb127-628" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m3 &lt;- ggplot(data=p_m3, aes(X, Y, fill = exp(est))) + </span></span>
<span id="cb127-629"><a href="#cb127-629" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() + facet_wrap(vars(Year)) +</span></span>
<span id="cb127-630"><a href="#cb127-630" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+</span></span>
<span id="cb127-631"><a href="#cb127-631" aria-hidden="true" tabindex="-1"></a><span class="in">    ggtitle("Prediction (fixed effects +  random effects) based on full m3",</span></span>
<span id="cb127-632"><a href="#cb127-632" aria-hidden="true" tabindex="-1"></a><span class="in">subtitle = expression("The estimated density of eggs " * log(mu[st]) * ": " * mu[st] == exp(X[t,s]*beta +beta[t] + omega[s]+ epsilon[st])))</span></span>
<span id="cb127-633"><a href="#cb127-633" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m3</span></span>
<span id="cb127-634"><a href="#cb127-634" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-635"><a href="#cb127-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-636"><a href="#cb127-636" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fixed effects in the prediction of model m~3~</span></span>
<span id="cb127-637"><a href="#cb127-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-638"><a href="#cb127-638" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-639"><a href="#cb127-639" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m3 &lt;- ggplot(data=p_m3, aes(X, Y, fill = exp(est_non_rf))) + </span></span>
<span id="cb127-640"><a href="#cb127-640" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() + facet_wrap(vars(Year)) +</span></span>
<span id="cb127-641"><a href="#cb127-641" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb127-642"><a href="#cb127-642" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (fixed effects only) based on full m3",</span></span>
<span id="cb127-643"><a href="#cb127-643" aria-hidden="true" tabindex="-1"></a><span class="in">          subtitle = expression("The effect of time and temperature in the estimated variable " * (X*beta+ beta[t]) * ": " * mu[st] == exp(X[t,s]*beta +beta[t] + omega[s]+ epsilon[st])))</span></span>
<span id="cb127-644"><a href="#cb127-644" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m3</span></span>
<span id="cb127-645"><a href="#cb127-645" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-646"><a href="#cb127-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-647"><a href="#cb127-647" aria-hidden="true" tabindex="-1"></a>The pastern change is space - just because the effect of temperature is small and the scale is not good it is not reprisented well in the map.</span>
<span id="cb127-648"><a href="#cb127-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-649"><a href="#cb127-649" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Random effects in the prediction of model m~3~ - here spatial &amp; spatiotemporal random effects</span></span>
<span id="cb127-650"><a href="#cb127-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-651"><a href="#cb127-651" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Plot the spatial random effect</span></span>
<span id="cb127-652"><a href="#cb127-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-653"><a href="#cb127-653" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-654"><a href="#cb127-654" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m3 &lt;- ggplot(data=p_m3, aes(X, Y, fill = exp(omega_s))) + </span></span>
<span id="cb127-655"><a href="#cb127-655" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() +</span></span>
<span id="cb127-656"><a href="#cb127-656" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb127-657"><a href="#cb127-657" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (spatial random effect) based on full m3",</span></span>
<span id="cb127-658"><a href="#cb127-658" aria-hidden="true" tabindex="-1"></a><span class="in">          subtitle = expression("The effect of space in the estimated variable " * (omega[s]) * ": " * mu[st] == exp(X[t,s]*beta+beta[t] + omega[s] + epsilon[st])))</span></span>
<span id="cb127-659"><a href="#cb127-659" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m3</span></span>
<span id="cb127-660"><a href="#cb127-660" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-661"><a href="#cb127-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-662"><a href="#cb127-662" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Plot the spatotemporal random effect</span></span>
<span id="cb127-663"><a href="#cb127-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-664"><a href="#cb127-664" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-665"><a href="#cb127-665" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m3 &lt;- ggplot(data=p_m3, aes(X, Y, fill = exp(epsilon_st))) + </span></span>
<span id="cb127-666"><a href="#cb127-666" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() +</span></span>
<span id="cb127-667"><a href="#cb127-667" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(Year)) +</span></span>
<span id="cb127-668"><a href="#cb127-668" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb127-669"><a href="#cb127-669" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (spatiotemporal random effect) based on full m3",</span></span>
<span id="cb127-670"><a href="#cb127-670" aria-hidden="true" tabindex="-1"></a><span class="in">          subtitle = expression("The effect of space through time in the estimated variable " * (epsilon[st]) * ": " * mu[st] == exp(X[t,s]*beta+beta[t] +omega[s] + epsilon[st])))</span></span>
<span id="cb127-671"><a href="#cb127-671" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m3</span></span>
<span id="cb127-672"><a href="#cb127-672" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-673"><a href="#cb127-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-674"><a href="#cb127-674" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Visualize the effect of the smoothed covariate Temperature.</span></span>
<span id="cb127-675"><a href="#cb127-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-676"><a href="#cb127-676" aria-hidden="true" tabindex="-1"></a>How I do not get that ???</span>
<span id="cb127-677"><a href="#cb127-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-678"><a href="#cb127-678" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-679"><a href="#cb127-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-680"><a href="#cb127-680" aria-hidden="true" tabindex="-1"></a><span class="in">nd &lt;- data.frame(</span></span>
<span id="cb127-681"><a href="#cb127-681" aria-hidden="true" tabindex="-1"></a><span class="in">  Tempsbe = seq(min(data.temp$Tempsbe), max(data.temp$Tempsbe), length.out = 100</span></span>
<span id="cb127-682"><a href="#cb127-682" aria-hidden="true" tabindex="-1"></a><span class="in">  ),</span></span>
<span id="cb127-683"><a href="#cb127-683" aria-hidden="true" tabindex="-1"></a><span class="in">  Year = as.factor(2024),time=24 # a chosen year</span></span>
<span id="cb127-684"><a href="#cb127-684" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb127-685"><a href="#cb127-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-686"><a href="#cb127-686" aria-hidden="true" tabindex="-1"></a><span class="in">p &lt;- predict(fit_m3, newdata = nd, se_fit = TRUE, re_form = NA)</span></span>
<span id="cb127-687"><a href="#cb127-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-688"><a href="#cb127-688" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(p, aes(Tempsbe, exp(est),</span></span>
<span id="cb127-689"><a href="#cb127-689" aria-hidden="true" tabindex="-1"></a><span class="in">  ymin = exp(est - 1.96 * est_se),</span></span>
<span id="cb127-690"><a href="#cb127-690" aria-hidden="true" tabindex="-1"></a><span class="in">  ymax = exp(est + 1.96 * est_se)</span></span>
<span id="cb127-691"><a href="#cb127-691" aria-hidden="true" tabindex="-1"></a><span class="in">)) +</span></span>
<span id="cb127-692"><a href="#cb127-692" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line() +</span></span>
<span id="cb127-693"><a href="#cb127-693" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(alpha = 0.4) +</span></span>
<span id="cb127-694"><a href="#cb127-694" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous() +</span></span>
<span id="cb127-695"><a href="#cb127-695" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(expand = F) +</span></span>
<span id="cb127-696"><a href="#cb127-696" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Temp (°C)", y = "Density (Nb/10m3)")</span></span>
<span id="cb127-697"><a href="#cb127-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-698"><a href="#cb127-698" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-699"><a href="#cb127-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-700"><a href="#cb127-700" aria-hidden="true" tabindex="-1"></a><span class="fu"># Prepare more covariates for more models ....</span></span>
<span id="cb127-701"><a href="#cb127-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-702"><a href="#cb127-702" aria-hidden="true" tabindex="-1"></a><span class="fu">## MODEL prof (Prof) : Model spatio-temporel de Covariables</span></span>
<span id="cb127-703"><a href="#cb127-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-704"><a href="#cb127-704" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prepare covariable</span></span>
<span id="cb127-705"><a href="#cb127-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-706"><a href="#cb127-706" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-707"><a href="#cb127-707" aria-hidden="true" tabindex="-1"></a><span class="in">data.prof=data.eggs[data.eggs$Sonde&gt;=0 &amp; data.eggs$Sonde&lt;5000 &amp; !is.na(data.eggs$Sonde),]</span></span>
<span id="cb127-708"><a href="#cb127-708" aria-hidden="true" tabindex="-1"></a><span class="in">hist((data.prof$Sonde))</span></span>
<span id="cb127-709"><a href="#cb127-709" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-710"><a href="#cb127-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-711"><a href="#cb127-711" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create the mesh</span></span>
<span id="cb127-712"><a href="#cb127-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-713"><a href="#cb127-713" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-714"><a href="#cb127-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-715"><a href="#cb127-715" aria-hidden="true" tabindex="-1"></a><span class="in">mesh &lt;- make_mesh(data.prof, xy_cols = c("X", "Y"), cutoff = 30)</span></span>
<span id="cb127-716"><a href="#cb127-716" aria-hidden="true" tabindex="-1"></a><span class="in">plot(mesh)</span></span>
<span id="cb127-717"><a href="#cb127-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-718"><a href="#cb127-718" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-719"><a href="#cb127-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-720"><a href="#cb127-720" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fit the model</span></span>
<span id="cb127-721"><a href="#cb127-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-722"><a href="#cb127-722" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-723"><a href="#cb127-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-724"><a href="#cb127-724" aria-hidden="true" tabindex="-1"></a><span class="in">fit_prof &lt;- sdmTMB(</span></span>
<span id="cb127-725"><a href="#cb127-725" aria-hidden="true" tabindex="-1"></a><span class="in">  Sonde ~ 0 + Year,</span></span>
<span id="cb127-726"><a href="#cb127-726" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data.prof,</span></span>
<span id="cb127-727"><a href="#cb127-727" aria-hidden="true" tabindex="-1"></a><span class="in">  mesh = mesh,</span></span>
<span id="cb127-728"><a href="#cb127-728" aria-hidden="true" tabindex="-1"></a><span class="in">  family = gaussian(link = "log"),</span></span>
<span id="cb127-729"><a href="#cb127-729" aria-hidden="true" tabindex="-1"></a><span class="in">  spatial = "on",</span></span>
<span id="cb127-730"><a href="#cb127-730" aria-hidden="true" tabindex="-1"></a><span class="in">  spatiotemporal='IID',</span></span>
<span id="cb127-731"><a href="#cb127-731" aria-hidden="true" tabindex="-1"></a><span class="in">  time='time'</span></span>
<span id="cb127-732"><a href="#cb127-732" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb127-733"><a href="#cb127-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-734"><a href="#cb127-734" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-735"><a href="#cb127-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-736"><a href="#cb127-736" aria-hidden="true" tabindex="-1"></a><span class="fu">### Results of the fit</span></span>
<span id="cb127-737"><a href="#cb127-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-738"><a href="#cb127-738" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-739"><a href="#cb127-739" aria-hidden="true" tabindex="-1"></a><span class="in">fit_temp</span></span>
<span id="cb127-740"><a href="#cb127-740" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-741"><a href="#cb127-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-742"><a href="#cb127-742" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-743"><a href="#cb127-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-744"><a href="#cb127-744" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(fit_temp, conf.int = TRUE)</span></span>
<span id="cb127-745"><a href="#cb127-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-746"><a href="#cb127-746" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-747"><a href="#cb127-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-748"><a href="#cb127-748" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-749"><a href="#cb127-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-750"><a href="#cb127-750" aria-hidden="true" tabindex="-1"></a><span class="in">tidy(fit_temp, effects = "ran_pars", conf.int = TRUE)</span></span>
<span id="cb127-751"><a href="#cb127-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-752"><a href="#cb127-752" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-753"><a href="#cb127-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-754"><a href="#cb127-754" aria-hidden="true" tabindex="-1"></a><span class="fu">### Diagnostics</span></span>
<span id="cb127-755"><a href="#cb127-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-756"><a href="#cb127-756" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-757"><a href="#cb127-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-758"><a href="#cb127-758" aria-hidden="true" tabindex="-1"></a><span class="in">sanity(fit_temp)</span></span>
<span id="cb127-759"><a href="#cb127-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-760"><a href="#cb127-760" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-761"><a href="#cb127-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-762"><a href="#cb127-762" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prediction</span></span>
<span id="cb127-763"><a href="#cb127-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-764"><a href="#cb127-764" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-765"><a href="#cb127-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-766"><a href="#cb127-766" aria-hidden="true" tabindex="-1"></a><span class="in">p_prof &lt;- predict(fit_prof, newdata = grid_yrs)</span></span>
<span id="cb127-767"><a href="#cb127-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-768"><a href="#cb127-768" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb127-769"><a href="#cb127-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-770"><a href="#cb127-770" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb127-771"><a href="#cb127-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-772"><a href="#cb127-772" aria-hidden="true" tabindex="-1"></a><span class="in">plot_prof &lt;- ggplot(data=p_prof, aes(X, Y, fill = exp(est))) + </span></span>
<span id="cb127-773"><a href="#cb127-773" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() + facet_wrap(vars(Year)) +</span></span>
<span id="cb127-774"><a href="#cb127-774" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")</span></span>
<span id="cb127-775"><a href="#cb127-775" aria-hidden="true" tabindex="-1"></a><span class="in">plot_prof</span></span>
<span id="cb127-776"><a href="#cb127-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-777"><a href="#cb127-777" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>