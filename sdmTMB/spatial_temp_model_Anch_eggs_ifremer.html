<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>sdmTMB Anchovy eggs Bay of biscay</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="spatial_temp_model_Anch_eggs_ifremer_files/libs/clipboard/clipboard.min.js"></script>
<script src="spatial_temp_model_Anch_eggs_ifremer_files/libs/quarto-html/quarto.js"></script>
<script src="spatial_temp_model_Anch_eggs_ifremer_files/libs/quarto-html/popper.min.js"></script>
<script src="spatial_temp_model_Anch_eggs_ifremer_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="spatial_temp_model_Anch_eggs_ifremer_files/libs/quarto-html/anchor.min.js"></script>
<link href="spatial_temp_model_Anch_eggs_ifremer_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="spatial_temp_model_Anch_eggs_ifremer_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="spatial_temp_model_Anch_eggs_ifremer_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="spatial_temp_model_Anch_eggs_ifremer_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="spatial_temp_model_Anch_eggs_ifremer_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#load-libraries-and-data" id="toc-load-libraries-and-data" class="nav-link active" data-scroll-target="#load-libraries-and-data">Load libraries and data</a>
  <ul>
  <li><a href="#we-removed-data-at-the-north-of-48n" id="toc-we-removed-data-at-the-north-of-48n" class="nav-link" data-scroll-target="#we-removed-data-at-the-north-of-48n">We removed data at the north of 48°N</a></li>
  </ul></li>
  <li><a href="#a-quick-map-of-your-final-data" id="toc-a-quick-map-of-your-final-data" class="nav-link" data-scroll-target="#a-quick-map-of-your-final-data">A quick map of your final data</a></li>
  <li><a href="#prepare-grid-for-prediction" id="toc-prepare-grid-for-prediction" class="nav-link" data-scroll-target="#prepare-grid-for-prediction">Prepare grid for prediction</a></li>
  <li><a href="#create-the-mesh" id="toc-create-the-mesh" class="nav-link" data-scroll-target="#create-the-mesh">Create the mesh</a></li>
  <li><a href="#model-1-m1-spatial-model-non-spatio-temporal-term" id="toc-model-1-m1-spatial-model-non-spatio-temporal-term" class="nav-link" data-scroll-target="#model-1-m1-spatial-model-non-spatio-temporal-term">MODEL 1 (m<sub>1</sub>) : Spatial model (non spatio-temporal term)</a>
  <ul>
  <li><a href="#fit-the-model" id="toc-fit-the-model" class="nav-link" data-scroll-target="#fit-the-model">Fit the model</a></li>
  <li><a href="#results-of-the-fit" id="toc-results-of-the-fit" class="nav-link" data-scroll-target="#results-of-the-fit">Results of the fit</a>
  <ul class="collapse">
  <li><a href="#confidence-intervals-of-fixed-effects" id="toc-confidence-intervals-of-fixed-effects" class="nav-link" data-scroll-target="#confidence-intervals-of-fixed-effects">Confidence intervals of fixed effects</a></li>
  <li><a href="#confidence-intervals-of-random-effect-and-variance-parameters" id="toc-confidence-intervals-of-random-effect-and-variance-parameters" class="nav-link" data-scroll-target="#confidence-intervals-of-random-effect-and-variance-parameters">Confidence intervals of random effect and variance parameters</a></li>
  </ul></li>
  <li><a href="#diagnostics" id="toc-diagnostics" class="nav-link" data-scroll-target="#diagnostics">Diagnostics</a></li>
  <li><a href="#prediction" id="toc-prediction" class="nav-link" data-scroll-target="#prediction">Prediction</a>
  <ul class="collapse">
  <li><a href="#full-fixed-and-random-effects-model-m1-prediction" id="toc-full-fixed-and-random-effects-model-m1-prediction" class="nav-link" data-scroll-target="#full-fixed-and-random-effects-model-m1-prediction">Full (fixed and random effects) model m<sub>1</sub> prediction</a></li>
  <li><a href="#fixed-effect-in-the-of-prediction-model-m1" id="toc-fixed-effect-in-the-of-prediction-model-m1" class="nav-link" data-scroll-target="#fixed-effect-in-the-of-prediction-model-m1">Fixed effect in the of prediction model m<sub>1</sub></a></li>
  <li><a href="#random-effect-in-the-prediction-of-model-m1" id="toc-random-effect-in-the-prediction-of-model-m1" class="nav-link" data-scroll-target="#random-effect-in-the-prediction-of-model-m1">Random effect in the prediction of model m<sub>1</sub></a></li>
  </ul></li>
  </ul></li>
  <li><a href="#model-2-m2-spatiotemporal-model" id="toc-model-2-m2-spatiotemporal-model" class="nav-link" data-scroll-target="#model-2-m2-spatiotemporal-model">MODEL 2 (m<sub>2</sub>) : Spatiotemporal model</a>
  <ul>
  <li><a href="#fit-the-model-1" id="toc-fit-the-model-1" class="nav-link" data-scroll-target="#fit-the-model-1">Fit the model</a></li>
  <li><a href="#results-of-the-fit-1" id="toc-results-of-the-fit-1" class="nav-link" data-scroll-target="#results-of-the-fit-1">Results of the fit</a>
  <ul class="collapse">
  <li><a href="#confidence-intervals-of-fixed-effects-1" id="toc-confidence-intervals-of-fixed-effects-1" class="nav-link" data-scroll-target="#confidence-intervals-of-fixed-effects-1">Confidence intervals of fixed effects</a></li>
  <li><a href="#confidence-intervals-of-random-effects-and-variance-parameters" id="toc-confidence-intervals-of-random-effects-and-variance-parameters" class="nav-link" data-scroll-target="#confidence-intervals-of-random-effects-and-variance-parameters">Confidence intervals of random effects and variance parameters</a></li>
  </ul></li>
  <li><a href="#diagnostics-1" id="toc-diagnostics-1" class="nav-link" data-scroll-target="#diagnostics-1">Diagnostics</a></li>
  <li><a href="#prediction-1" id="toc-prediction-1" class="nav-link" data-scroll-target="#prediction-1">Prediction</a>
  <ul class="collapse">
  <li><a href="#full-fixed-and-random-effects-model-m2-prediction" id="toc-full-fixed-and-random-effects-model-m2-prediction" class="nav-link" data-scroll-target="#full-fixed-and-random-effects-model-m2-prediction">Full (fixed and random effects) model m<sub>2</sub> prediction</a></li>
  <li><a href="#fixed-effect-in-the-prediction-of-model-m2" id="toc-fixed-effect-in-the-prediction-of-model-m2" class="nav-link" data-scroll-target="#fixed-effect-in-the-prediction-of-model-m2">Fixed effect in the prediction of model m<sub>2</sub></a></li>
  <li><a href="#random-effects-in-the-prediction-of-model-m2" id="toc-random-effects-in-the-prediction-of-model-m2" class="nav-link" data-scroll-target="#random-effects-in-the-prediction-of-model-m2">Random effects in the prediction of model m<sub>2</sub></a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">sdmTMB Anchovy eggs Bay of biscay</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="load-libraries-and-data" class="level3">
<h3 class="anchored" data-anchor-id="load-libraries-and-data">Load libraries and data</h3>
<section id="anhcovy-eggs-n-eggs10m3-at-5m-depth-3nmi-x-12nmi" class="level6">
<h6 class="anchored" data-anchor-id="anhcovy-eggs-n-eggs10m3-at-5m-depth-3nmi-x-12nmi">Anhcovy eggs (n eggs/10m<sub>3</sub>) at 5m depth, 3nmi x 12nmi</h6>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>espece<span class="ot">=</span><span class="st">'Ee10m3'</span>; cespece<span class="ot">=</span><span class="st">'Anchovy'</span>; ccolor<span class="ot">=</span><span class="st">'blue'</span>;maxvalue<span class="ot">=</span><span class="dv">200</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>listyears<span class="ot">=</span><span class="fu">c</span>(<span class="dv">2000</span><span class="sc">:</span><span class="dv">2019</span>,<span class="dv">2021</span><span class="sc">:</span><span class="dv">2024</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>file.data<span class="ot">=</span><span class="st">'DataEggs/Cufes_spring_ifremer.txt'</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>data.eggs<span class="ot">=</span><span class="fu">read.table</span>(<span class="at">file=</span>file.data,<span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,<span class="at">header=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="a-quick-map-of-your-row-data" class="level5">
<h5 class="anchored" data-anchor-id="a-quick-map-of-your-row-data">A quick map of your row data</h5>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data.eggs_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(data.eggs, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Long"</span>, <span class="st">"Lat"</span>), <span class="at">crs =</span> <span class="st">"WGS84"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>plot_eggs <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> data.eggs_sf) <span class="sc">+</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">color =</span> Ee10m3), <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Year) <span class="sc">+</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>, <span class="at">na.value =</span> <span class="st">"grey80"</span>,  <span class="at">name =</span> <span class="fu">expression</span>(<span class="st">"Log(Eggs/10m³)</span><span class="sc">\n</span><span class="st"> grays are zero"</span>)) <span class="sc">+</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtitle</span>(<span class="st">"Total Anchovy eggs"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>plot_eggs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="spatial_temp_model_Anch_eggs_ifremer_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="we-removed-data-at-the-north-of-48n" class="level4">
<h4 class="anchored" data-anchor-id="we-removed-data-at-the-north-of-48n">We removed data at the north of 48°N</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data.eggs<span class="ot">&lt;-</span> data.eggs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Lat <span class="sc">&lt;</span> <span class="dv">48</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(Sp10m3)<span class="sc">==</span>F) <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Year=</span><span class="fu">as.factor</span>(Year), <span class="at">time=</span><span class="fu">as.integer</span>(Year))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>data.eggs <span class="ot">&lt;-</span> <span class="fu">add_utm_columns</span>(data.eggs, <span class="fu">c</span>(<span class="st">"Long"</span>, <span class="st">"Lat"</span>), <span class="at">ll_crs =</span> <span class="dv">4326</span>, <span class="at">units =</span> <span class="st">"km"</span>)   <span class="co">#Project coordinates to Km</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Proceeding with UTM zone 30N; CRS = 32630.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Visit https://epsg.io/32630 to verify.</code></pre>
</div>
</div>
</section>
</section>
<section id="a-quick-map-of-your-final-data" class="level3">
<h3 class="anchored" data-anchor-id="a-quick-map-of-your-final-data">A quick map of your final data</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>data.eggs_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(data.eggs, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Long"</span>, <span class="st">"Lat"</span>), <span class="at">crs =</span> <span class="st">"WGS84"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>plot_eggs <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> data.eggs_sf) <span class="sc">+</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">color =</span> Ee10m3), <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Year) <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>, <span class="at">na.value =</span> <span class="st">"grey80"</span>,   <span class="at">name =</span> <span class="fu">expression</span>(<span class="st">"Log(Eggs/10m³)</span><span class="sc">\n</span><span class="st"> grays are zero"</span>)) <span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtitle</span>(<span class="st">"Total Anchovy eggs"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>plot_eggs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="spatial_temp_model_Anch_eggs_ifremer_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="prepare-grid-for-prediction" class="level3">
<h3 class="anchored" data-anchor-id="prepare-grid-for-prediction">Prepare grid for prediction</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>projection_grid <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"./DataEggs/user_region.rds"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>projection_grid_UTM <span class="ot">&lt;-</span> <span class="fu">add_utm_columns</span>(projection_grid, <span class="fu">c</span>(<span class="st">"Lon"</span>, <span class="st">"Lat"</span>), <span class="at">ll_crs =</span> <span class="dv">4326</span>, <span class="at">units =</span> <span class="st">"km"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Detected UTM zone 30N; CRS = 32630.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Visit https://epsg.io/32630 to verify.</code></pre>
</div>
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(projection_grid_UTM<span class="sc">$</span>X,projection_grid_UTM<span class="sc">$</span>Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="spatial_temp_model_Anch_eggs_ifremer_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>grid_yrs <span class="ot">&lt;-</span> <span class="fu">replicate_df</span>(projection_grid_UTM, <span class="fu">c</span>(<span class="st">"Year"</span>), <span class="fu">as.factor</span>(<span class="fu">unique</span>(data.eggs<span class="sc">$</span>Year))) <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time=</span><span class="fu">as.integer</span>(Year))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="create-the-mesh" class="level3">
<h3 class="anchored" data-anchor-id="create-the-mesh">Create the mesh</h3>
<p>In these kinds of models, the spatial (ω<sub>s</sub>) and the spatiotemporal (ε<sub>s,t</sub>) variations (and potentially any spatial varying coefficient) are modeled as Gaussian Random Fields (GRF), where the random effects describing the spatial patterns are assumed to be drawn from a multivariate normal distribution MVNormal (0,Σ). Estimating this covariance matrix (Σ) is computational demanding, so the SPDE approach is used to approximate the Gaussian random fields.</p>
<p>For the SPDE approximation approach you need another grid called the <strong>mesh</strong> which is a triangulated mesh with Knots. These Knots are used to approximate the spatial variability in your data and because the number of Knots &lt;&lt; number of data points the computation of the covariance is easier. The Matern correlation is used as a covariance function to account for spatial autocorrelation.</p>
<p><em>Maybe more discussion in how you contract the mesh (ex. who many Knots you need)</em></p>
<p>So, so far we have three grids with different spatial resolution :</p>
<ul>
<li><p>The data grid (your sampling points, those data are used to estimate fixed parameres)</p></li>
<li><p>The mesh (for the Gaussian Random Fields approximation)</p></li>
<li><p>The prediction grid ( for predictions using your final model).</p>
<p>So the mesh is:</p></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>mesh <span class="ot">&lt;-</span> <span class="fu">make_mesh</span>(data.eggs, <span class="at">xy_cols =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), <span class="at">cutoff =</span> <span class="dv">30</span>)  <span class="co"># cutoff: minimum distance between knots before a new mesh vertex is added- units as in your dataset</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mesh)                                                     </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="spatial_temp_model_Anch_eggs_ifremer_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-1-m1-spatial-model-non-spatio-temporal-term" class="level2">
<h2 class="anchored" data-anchor-id="model-1-m1-spatial-model-non-spatio-temporal-term">MODEL 1 (m<sub>1</sub>) : Spatial model (non spatio-temporal term)</h2>
<p>The first model (m<sub>1</sub>) follows that formula:</p>
<p>μ<sub>s,t</sub>= exp(β<sub>t</sub>+ ω<sub>s</sub>),</p>
<p>μ<sub>s,t</sub>= log(y<sub>s,t</sub> ),</p>
<p>y<sub>s,t</sub> ~ Tweedie (μ<sub>s,t</sub> ,p, φ) , ω~ MVNormal (0,Σ<sub>ω</sub>)</p>
<p>where the modeled egg density (μ<sub>s,t</sub>) follows the Tweedie distribution with a log link function, as egg density is positive, continuous and contains zeros.</p>
<p>y<sub>s,t</sub> represents eggs density (no of eggs/10m<sup>2</sup>) at space (s) and time(t), μ is the mean density at time and space and p, φ represent power and dispersion parameters of the Tweedie distribution, respectively.</p>
<p>β<sub>t</sub> are the fixed effects for factor(Year), they represent the average temporal variation</p>
<p>ω<sub>s</sub> is the spatial random effect, drawn from a GRF with covarianvce matrix Σ<sub>ω</sub> using Maretn correlation function. It represents the average spatial pattern (nich effect) and it also accounts for spatial variation that is not accounted for by our fixed effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting biomass density but are not accounted for in the model.</p>
<section id="fit-the-model" class="level3">
<h3 class="anchored" data-anchor-id="fit-the-model">Fit the model</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fit_m1 <span class="ot">&lt;-</span> <span class="fu">sdmTMB</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  Ee10m3 <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Year,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data.eggs,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mesh =</span> mesh,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">tweedie</span>(<span class="at">link =</span> <span class="st">"log"</span>),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatial =</span> <span class="st">"on"</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="results-of-the-fit" class="level3">
<h3 class="anchored" data-anchor-id="results-of-the-fit">Results of the fit</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>fit_m1  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Spatial model fit by ML ['sdmTMB']
Formula: Ee10m3 ~ 0 + Year
Mesh: mesh (isotropic covariance)
Data: data.eggs
Family: tweedie(link = 'log')
 
         coef.est coef.se
Year2000    -0.64    0.88
Year2001     2.17    0.87
Year2002     0.67    0.88
Year2003     0.67    0.88
Year2004    -0.03    0.88
Year2005    -0.09    0.88
Year2006    -0.26    0.88
Year2007     2.17    0.88
Year2008     0.30    0.88
Year2009     0.10    0.88
Year2010     1.45    0.88
Year2011     3.58    0.87
Year2012     1.91    0.88
Year2013     2.10    0.88
Year2014     2.24    0.88
Year2015     2.89    0.87
Year2016     2.71    0.88
Year2017     2.29    0.88
Year2018     2.98    0.87
Year2019     2.87    0.87
Year2021     2.99    0.87
Year2022     4.64    0.87
Year2023     3.11    0.87
Year2024     4.38    0.87

Dispersion parameter: 10.92
Tweedie p: 1.68
Matérn range: 132.80
Spatial SD: 2.37
ML criterion at convergence: 52199.829

See ?tidy.sdmTMB to extract these values as a data frame.</code></pre>
</div>
</div>
<section id="confidence-intervals-of-fixed-effects" class="level4">
<h4 class="anchored" data-anchor-id="confidence-intervals-of-fixed-effects">Confidence intervals of fixed effects</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fix_effects<span class="ot">&lt;-</span> <span class="fu">tidy</span>(fit_m1, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>fix_effects</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24 × 5
   term     estimate std.error conf.low conf.high
   &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Year2000  -0.637      0.882   -2.37       1.09
 2 Year2001   2.17       0.875    0.458      3.89
 3 Year2002   0.675      0.878   -1.05       2.40
 4 Year2003   0.665      0.878   -1.05       2.39
 5 Year2004  -0.0279     0.880   -1.75       1.70
 6 Year2005  -0.0851     0.881   -1.81       1.64
 7 Year2006  -0.257      0.881   -1.98       1.47
 8 Year2007   2.17       0.876    0.450      3.89
 9 Year2008   0.297      0.879   -1.42       2.02
10 Year2009   0.102      0.879   -1.62       1.83
# ℹ 14 more rows</code></pre>
</div>
</div>
</section>
<section id="confidence-intervals-of-random-effect-and-variance-parameters" class="level4">
<h4 class="anchored" data-anchor-id="confidence-intervals-of-random-effect-and-variance-parameters">Confidence intervals of random effect and variance parameters</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>random_effects<span class="ot">&lt;-</span> <span class="fu">tidy</span>(fit_m1, <span class="at">effects =</span> <span class="st">"ran_pars"</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>random_effects</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 5
  term      estimate std.error conf.low conf.high
  &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 range       133.    39.6        74.0     238.  
2 phi          10.9    0.122      10.7      11.2 
3 sigma_O       2.37   0.462       1.62      3.48
4 tweedie_p     1.68   0.00303     1.67      1.68</code></pre>
</div>
</div>
<p>Other than the effect of the spatial random field you have: :</p>
<ul>
<li><p>Matérn range: the distance at witch you have no correlation - similar to the variogram range</p></li>
<li><p>phi (φ) &amp; tweedie_p (p): the dispersion parameter and the power of the Tweedie distribution, respectively.</p></li>
</ul>
<section id="plot-the-all-the-effects" class="level5">
<h5 class="anchored" data-anchor-id="plot-the-all-the-effects">Plot the all the effects</h5>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> fix_effects, <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> term, <span class="at">col =</span> term)) <span class="sc">+</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data =</span> fix_effects, <span class="fu">aes</span>(<span class="at">y =</span> term, <span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high, <span class="at">color =</span> term), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span>  </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> random_effects <span class="sc">%&gt;%</span> <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"sigma_O"</span>), <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> term)) <span class="sc">+</span>  </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data =</span> random_effects <span class="sc">%&gt;%</span> <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"sigma_O"</span>), <span class="fu">aes</span>(<span class="at">y =</span> term, <span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span>  </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>( <span class="at">title =</span> <span class="fu">expression</span>(<span class="st">"Mean and 95% confidence intervals of the fixed &amp; random effects,"</span> <span class="sc">~</span> m[<span class="dv">1</span>]),       </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="fu">expression</span>(mu[s<span class="sc">~</span>t] <span class="sc">~</span> <span class="st">"="</span> <span class="sc">~</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s]))) <span class="sc">+</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="spatial_temp_model_Anch_eggs_ifremer_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can see that the effect of spatial term is the most “important” one. Space is the more influential parameter in egg distribution in this model.</p>
</section>
</section>
</section>
<section id="diagnostics" class="level3">
<h3 class="anchored" data-anchor-id="diagnostics">Diagnostics</h3>
<p>What do you check?</p>
<p>Residuals?</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sanity</span>(fit_m1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Non-linear minimizer suggests successful convergence</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Hessian matrix is positive definite</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No extreme or very small eigenvalues detected</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No gradients with respect to fixed effects are &gt;= 0.001</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No fixed-effect standard errors are NA</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No standard errors look unreasonably large</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No sigma parameters are &lt; 0.01</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No sigma parameters are &gt; 100</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range parameter doesn't look unreasonably large</code></pre>
</div>
</div>
</section>
<section id="prediction" class="level3">
<h3 class="anchored" data-anchor-id="prediction">Prediction</h3>
<p>You now perform a prediction in you prediction grid using the fitted model m<sub>1</sub>. When you visualize your prediction in a map you can visualize your final prediction your model (eg. the estimated number of eggs) or you can visualize separately each part of the decomposition (the effect of the fixed covariates and the effect of the random fields (ω<sub>s</sub>, ε<sub>s,t</sub>) and see what is going on.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Predict in the prediction grid that has been created above</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>p_m1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_m1, <span class="at">newdata =</span> grid_yrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="full-fixed-and-random-effects-model-m1-prediction" class="level4">
<h4 class="anchored" data-anchor-id="full-fixed-and-random-effects-model-m1-prediction">Full (fixed and random effects) model m<sub>1</sub> prediction</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>plot_m1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m1, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(est))) <span class="sc">+</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Year)) <span class="sc">+</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (fixed effects +  random effects) based on full m1"</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The estimated density of eggs "</span> <span class="sc">*</span> <span class="fu">log</span>(mu[st]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s])))</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>plot_m1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="spatial_temp_model_Anch_eggs_ifremer_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fixed-effect-in-the-of-prediction-model-m1" class="level4">
<h4 class="anchored" data-anchor-id="fixed-effect-in-the-of-prediction-model-m1">Fixed effect in the of prediction model m<sub>1</sub></h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>plot_m1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m1, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(est_non_rf))) <span class="sc">+</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Year)) <span class="sc">+</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (fixed effects only) based on full m1"</span>,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The effect of time in the estimated variable "</span> <span class="sc">*</span> (beta[t]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s])))</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>plot_m1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="spatial_temp_model_Anch_eggs_ifremer_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="random-effect-in-the-prediction-of-model-m1" class="level4">
<h4 class="anchored" data-anchor-id="random-effect-in-the-prediction-of-model-m1">Random effect in the prediction of model m<sub>1</sub></h4>
<p>Here spatial random effect only</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>plot_m1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m1, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(omega_s))) <span class="sc">+</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (random effects only) based on full m1"</span>,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The effect of space in the estimated variable "</span> <span class="sc">*</span> (omega[s]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s])))</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>plot_m1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="spatial_temp_model_Anch_eggs_ifremer_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>For the ω<sub>s</sub> we have only one map because the spatial effect is stable across time. This is the mean spatial effect estimated from your data and it also represents the mean spatial distribution. If you want to see if or how the spatial effect changes in time then you need a spatiotemporal random effect (see m<sub>2</sub>).</p>
<p>This spatial random effect represents variance in space (but consistence through time) coming from the data that are not accounted by the fixed effects. In this model compared to m<sub>1</sub> the spatial random effect is less influential because a part of the variability is now explained by the spatiotemporal effect term.</p>
</section>
</section>
</section>
<section id="model-2-m2-spatiotemporal-model" class="level2">
<h2 class="anchored" data-anchor-id="model-2-m2-spatiotemporal-model">MODEL 2 (m<sub>2</sub>) : Spatiotemporal model</h2>
<p>The 2<sup>nd</sup> model (m<sub>2</sub>) follows that formula:</p>
<p>μ<sub>s,t</sub>= exp(β<sub>t</sub>+ ω<sub>s</sub> + ε<sub>s,t</sub>),</p>
<p>μ<sub>s,t</sub>= log(y<sub>s,t</sub> ),</p>
<p>y<sub>s,t</sub> ~ Tweedie (μ<sub>s,t</sub> ,p, φ) , ω~ MVNormal (0,Σ<sub>ω</sub>) , ε<sub>t</sub> ~ MVNormal (0,Σ<sub>t</sub>)</p>
<p>where the modeled egg density (μ<sub>s,t</sub>) follows the Tweedie distribution with a log link function, as egg density is positive, continuous and contains zeros.</p>
<p>y<sub>s,t</sub> represents eggs density (no of eggs/10m<sup>2</sup>) at space (s) and time(t), μ is the mean density at time and space and p, φ represent power and dispersion parameters of the Tweedie distribution, respectively.</p>
<p>β<sub>t</sub> are the fixed effects for factor(Year), they represent the average temporal variation</p>
<p>ω<sub>s</sub> is the spatial random effect, drawn from a GRF with covarianvce matrix Σ<sub>ω</sub> using Maretn correlation function. It represents the average spatial pattern (nich effect) and it also accounts for spatial variation that is not accounted for by our fixed effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting biomass density but are not accounted for in the model.</p>
<p>ε<sub>s,t</sub> represents the spatiotemporal random effect, drawn from a GRF with covarianvce matrix Σ<sub>ε</sub>. They represents how the average spatial pattern change through year so they also for spatial variation that is not accounted for by our fixed effects and the spatial random effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting our study variable but are not accounted for in the model.</p>
<p>In this model Spatiotemporal random fields are considered independent and identically distributed each single year (spatiotemporal = “IID”) and Maretn correlation function to accounts for spatial autocorrelation.</p>
<p><em>Are there other options for spatiotemporal fields:</em></p>
<ul>
<li><p><em>“AR1”: first-order autoregressive (each random filed is correlated to the one of the previous year )</em></p></li>
<li><p><em>“RW”: random walk (each random filed starts fro where it was last year plus a completely independent deviation)</em></p></li>
</ul>
<section id="fit-the-model-1" class="level3">
<h3 class="anchored" data-anchor-id="fit-the-model-1">Fit the model</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>fit_m2 <span class="ot">&lt;-</span> <span class="fu">sdmTMB</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  Ee10m3 <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Year,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data.eggs,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mesh =</span> mesh,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">tweedie</span>(<span class="at">link =</span> <span class="st">"log"</span>),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatial =</span> <span class="st">"on"</span>,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatiotemporal =</span> <span class="st">"IID"</span>,   </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="st">"time"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="results-of-the-fit-1" class="level3">
<h3 class="anchored" data-anchor-id="results-of-the-fit-1">Results of the fit</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>fit_m2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Spatiotemporal model fit by ML ['sdmTMB']
Formula: Ee10m3 ~ 0 + Year
Mesh: mesh (isotropic covariance)
Time column: time
Data: data.eggs
Family: tweedie(link = 'log')
 
         coef.est coef.se
Year2000    -5.80    2.01
Year2001    -2.50    1.89
Year2002    -2.34    1.91
Year2003    -0.96    1.85
Year2004    -5.60    2.01
Year2005    -4.16    2.04
Year2006    -4.82    2.03
Year2007    -2.22    1.96
Year2008    -4.80    2.00
Year2009    -5.94    2.00
Year2010    -4.88    1.95
Year2011     2.14    1.78
Year2012    -1.62    1.86
Year2013    -3.87    1.95
Year2014    -3.07    1.91
Year2015    -0.07    1.84
Year2016    -1.06    1.88
Year2017    -0.90    1.86
Year2018    -0.25    1.85
Year2019     0.52    1.84
Year2021     2.06    1.81
Year2022     1.83    1.82
Year2023     0.19    1.84
Year2024     1.34    1.82

Dispersion parameter: 5.60
Tweedie p: 1.60
Matérn range: 159.98
Spatial SD: 2.65
Spatiotemporal IID SD: 3.25
ML criterion at convergence: 46629.497

See ?tidy.sdmTMB to extract these values as a data frame.</code></pre>
</div>
</div>
<section id="confidence-intervals-of-fixed-effects-1" class="level4">
<h4 class="anchored" data-anchor-id="confidence-intervals-of-fixed-effects-1">Confidence intervals of fixed effects</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>fix_effects<span class="ot">&lt;-</span> <span class="fu">tidy</span>(fit_m2, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>fix_effects</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24 × 5
   term     estimate std.error conf.low conf.high
   &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Year2000   -5.80       2.01    -9.74    -1.87 
 2 Year2001   -2.50       1.89    -6.21     1.21 
 3 Year2002   -2.34       1.91    -6.07     1.40 
 4 Year2003   -0.962      1.85    -4.59     2.66 
 5 Year2004   -5.60       2.01    -9.54    -1.67 
 6 Year2005   -4.16       2.04    -8.16    -0.156
 7 Year2006   -4.82       2.03    -8.80    -0.843
 8 Year2007   -2.22       1.96    -6.06     1.62 
 9 Year2008   -4.80       2.00    -8.72    -0.886
10 Year2009   -5.94       2.00    -9.86    -2.01 
# ℹ 14 more rows</code></pre>
</div>
</div>
</section>
<section id="confidence-intervals-of-random-effects-and-variance-parameters" class="level4">
<h4 class="anchored" data-anchor-id="confidence-intervals-of-random-effects-and-variance-parameters">Confidence intervals of random effects and variance parameters</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>random_effects<span class="ot">&lt;-</span> <span class="fu">tidy</span>(fit_m2, <span class="at">effects =</span> <span class="st">"ran_pars"</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>random_effects</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 5
  term      estimate std.error conf.low conf.high
  &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 range       160.    11.0       140.      183.  
2 phi           5.60   0.0746      5.45      5.75
3 sigma_O       2.65   0.301       2.12      3.31
4 sigma_E       3.25   0.158       2.95      3.57
5 tweedie_p     1.60   0.00335     1.59      1.60</code></pre>
</div>
</div>
<p>Other than the effect of the spatial random (sigma_O) and the spatiotemporal random field (sigma_E) field you have: :</p>
<ul>
<li><p>Matérn range: the distance at witch you have no correlation - similar to the variogram range</p></li>
<li><p>phi (φ) &amp; tweedie_p (p): the dispersion parameter and the power of the Tweedie distribution, respectively.</p></li>
</ul>
<section id="plot-the-all-the-effects-1" class="level5">
<h5 class="anchored" data-anchor-id="plot-the-all-the-effects-1">Plot the all the effects</h5>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> fix_effects, <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> term, <span class="at">col =</span> term)) <span class="sc">+</span> </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data =</span> fix_effects, <span class="fu">aes</span>(<span class="at">y =</span> term, <span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high, <span class="at">color =</span> term), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span>  </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> random_effects <span class="sc">%&gt;%</span> <span class="fu">filter</span>(term <span class="sc">==</span> <span class="fu">c</span>(<span class="st">"sigma_O"</span>,<span class="st">"sigma_E"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> term)) <span class="sc">+</span>  </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data =</span> random_effects <span class="sc">%&gt;%</span> <span class="fu">filter</span>(term <span class="sc">==</span> <span class="fu">c</span>(<span class="st">"sigma_O"</span>,<span class="st">"sigma_E"</span>)), <span class="fu">aes</span>(<span class="at">y =</span> term, <span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span>  </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>( <span class="at">title =</span> <span class="fu">expression</span>(<span class="st">"Mean and 95% confidence intervals of the fixed &amp; random effects,"</span> <span class="sc">~</span> m[<span class="dv">2</span>]),       </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="fu">expression</span>(mu[s<span class="sc">~</span>t] <span class="sc">~</span> <span class="st">"="</span> <span class="sc">~</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s] <span class="sc">+</span>epsilon[st]))) <span class="sc">+</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="spatial_temp_model_Anch_eggs_ifremer_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can see that the effect of spatial term is steal the most “important” one. But a lot of is effect is now explained by the spatiotemporal effect.</p>
</section>
</section>
</section>
<section id="diagnostics-1" class="level3">
<h3 class="anchored" data-anchor-id="diagnostics-1">Diagnostics</h3>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sanity</span>(fit_m2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Non-linear minimizer suggests successful convergence</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Hessian matrix is positive definite</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No extreme or very small eigenvalues detected</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No gradients with respect to fixed effects are &gt;= 0.001</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No fixed-effect standard errors are NA</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No standard errors look unreasonably large</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No sigma parameters are &lt; 0.01</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ No sigma parameters are &gt; 100</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range parameter doesn't look unreasonably large</code></pre>
</div>
</div>
</section>
<section id="prediction-1" class="level3">
<h3 class="anchored" data-anchor-id="prediction-1">Prediction</h3>
<p>You can steel predict in the same grid as m<sub>1</sub> as no more covariates have been added to the model.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>p_m2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_m2, <span class="at">newdata =</span> grid_yrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="full-fixed-and-random-effects-model-m2-prediction" class="level4">
<h4 class="anchored" data-anchor-id="full-fixed-and-random-effects-model-m2-prediction">Full (fixed and random effects) model m<sub>2</sub> prediction</h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>plot_m2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m2, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(est))) <span class="sc">+</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Year)) <span class="sc">+</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (fixed effects +  random effects) based on full m2"</span>,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The estimated density of eggs "</span> <span class="sc">*</span> <span class="fu">log</span>(mu[st]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s]<span class="sc">+</span> epsilon[st])))</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>plot_m2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="spatial_temp_model_Anch_eggs_ifremer_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fixed-effect-in-the-prediction-of-model-m2" class="level4">
<h4 class="anchored" data-anchor-id="fixed-effect-in-the-prediction-of-model-m2">Fixed effect in the prediction of model m<sub>2</sub></h4>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>plot_m2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m2, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(est_non_rf))) <span class="sc">+</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Year)) <span class="sc">+</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (fixed effects only) based on full m2"</span>,</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The effect of time in the estimated variable "</span> <span class="sc">*</span> (beta[t]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s]<span class="sc">+</span> epsilon[st])))</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>plot_m2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="spatial_temp_model_Anch_eggs_ifremer_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="random-effects-in-the-prediction-of-model-m2" class="level4">
<h4 class="anchored" data-anchor-id="random-effects-in-the-prediction-of-model-m2">Random effects in the prediction of model m<sub>2</sub></h4>
<p>Here spatial &amp; spatiotemporal random effects</p>
<section id="plot-the-spatial-random-effect" class="level5">
<h5 class="anchored" data-anchor-id="plot-the-spatial-random-effect">Plot the spatial random effect</h5>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>plot_m2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m2, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(omega_s))) <span class="sc">+</span> </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (spatial random effect) based on full m2"</span>,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The effect of space in the estimated variable "</span> <span class="sc">*</span> (omega[s]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s] <span class="sc">+</span> epsilon[st])))</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>plot_m2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="spatial_temp_model_Anch_eggs_ifremer_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="plot-the-spatotemporal-random-effect" class="level5">
<h5 class="anchored" data-anchor-id="plot-the-spatotemporal-random-effect">Plot the spatotemporal random effect</h5>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>plot_m2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>p_m2, <span class="fu">aes</span>(X, Y, <span class="at">fill =</span> <span class="fu">exp</span>(epsilon_st))) <span class="sc">+</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Year)) <span class="sc">+</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">trans =</span> <span class="st">"log"</span>)<span class="sc">+</span> </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Prediction (spatiotemporal random effect) based on full m2"</span>,</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">expression</span>(<span class="st">"The effect of space through time in the estimated variable "</span> <span class="sc">*</span> (epsilon[st]) <span class="sc">*</span> <span class="st">": "</span> <span class="sc">*</span> mu[st] <span class="sc">==</span> <span class="fu">exp</span>(beta[t] <span class="sc">+</span> omega[s] <span class="sc">+</span> epsilon[st])))</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>plot_m2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="spatial_temp_model_Anch_eggs_ifremer_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The spatiptempral random effect represent deviation from the fixed effect predictions and the spatial random effect deviations. These represent changes in the spatial paternal through time that are forced by parameters not accounted for in the model.</p>
<!-- -->

</section>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb58" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "sdmTMB Anchovy eggs Bay of biscay "</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 4</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-float: true</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true         </span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "Hide/Show "</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools:</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a><span class="co">      toggle: true         </span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load libraries and data</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a><span class="fu">###### Anhcovy eggs (n eggs/10m~3~) at 5m depth, 3nmi x 12nmi</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,include=F,echo=F}</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a><span class="in">rm(list=ls())</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a><span class="in"># Load packages</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyr)</span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr)</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a><span class="in">library(mapdata)</span></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a><span class="in">library(rnaturalearth)</span></span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a><span class="in">library(rnaturalearthdata)</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)</span></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a><span class="in">library(sp)</span></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a><span class="in">library(sdmTMB)</span></span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a><span class="in"># Map</span></span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a><span class="in">world &lt;- ne_countries(scale = "medium", returnclass = "sf")</span></span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a><span class="in">espece='Ee10m3'; cespece='Anchovy'; ccolor='blue';maxvalue=200</span></span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a><span class="in">listyears=c(2000:2019,2021:2024)</span></span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a><span class="in">file.data='DataEggs/Cufes_spring_ifremer.txt'</span></span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a><span class="in">data.eggs=read.table(file=file.data,sep="\t",header=T)</span></span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a><span class="fu">#####  A quick map of your row data</span></span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a><span class="in">data.eggs_sf &lt;- st_as_sf(data.eggs, coords = c("Long", "Lat"), crs = "WGS84")</span></span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a><span class="in">plot_eggs &lt;- ggplot(data = data.eggs_sf) + </span></span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(aes(color = Ee10m3), alpha = 0.8, size = 1) +</span></span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~ Year) +</span></span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_viridis_c(trans = "log", na.value = "grey80",  name = expression("Log(Eggs/10m³)\n grays are zero")) +</span></span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a><span class="in">ggtitle("Total Anchovy eggs")</span></span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true" tabindex="-1"></a><span class="in">plot_eggs</span></span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-52"><a href="#cb58-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-53"><a href="#cb58-53" aria-hidden="true" tabindex="-1"></a><span class="fu">#### We removed data at the north of 48°N</span></span>
<span id="cb58-54"><a href="#cb58-54" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-55"><a href="#cb58-55" aria-hidden="true" tabindex="-1"></a><span class="in">data.eggs&lt;- data.eggs %&gt;% filter(Lat &lt; 48 &amp; is.na(Sp10m3)==F) %&gt;%</span></span>
<span id="cb58-56"><a href="#cb58-56" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(Year=as.factor(Year), time=as.integer(Year))</span></span>
<span id="cb58-57"><a href="#cb58-57" aria-hidden="true" tabindex="-1"></a><span class="in">data.eggs &lt;- add_utm_columns(data.eggs, c("Long", "Lat"), ll_crs = 4326, units = "km")   #Project coordinates to Km</span></span>
<span id="cb58-58"><a href="#cb58-58" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-59"><a href="#cb58-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-60"><a href="#cb58-60" aria-hidden="true" tabindex="-1"></a><span class="fu">### A quick map of your final data</span></span>
<span id="cb58-61"><a href="#cb58-61" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-62"><a href="#cb58-62" aria-hidden="true" tabindex="-1"></a><span class="in">data.eggs_sf &lt;- st_as_sf(data.eggs, coords = c("Long", "Lat"), crs = "WGS84")</span></span>
<span id="cb58-63"><a href="#cb58-63" aria-hidden="true" tabindex="-1"></a><span class="in">plot_eggs &lt;- ggplot(data = data.eggs_sf) + </span></span>
<span id="cb58-64"><a href="#cb58-64" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(aes(color = Ee10m3), alpha = 0.8, size = 0.8) +</span></span>
<span id="cb58-65"><a href="#cb58-65" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~ Year) +</span></span>
<span id="cb58-66"><a href="#cb58-66" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_viridis_c(trans = "log", na.value = "grey80",   name = expression("Log(Eggs/10m³)\n grays are zero")) +</span></span>
<span id="cb58-67"><a href="#cb58-67" aria-hidden="true" tabindex="-1"></a><span class="in">ggtitle("Total Anchovy eggs")</span></span>
<span id="cb58-68"><a href="#cb58-68" aria-hidden="true" tabindex="-1"></a><span class="in">plot_eggs</span></span>
<span id="cb58-69"><a href="#cb58-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-70"><a href="#cb58-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-71"><a href="#cb58-71" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prepare grid for prediction</span></span>
<span id="cb58-72"><a href="#cb58-72" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-73"><a href="#cb58-73" aria-hidden="true" tabindex="-1"></a><span class="in">projection_grid &lt;- readRDS("./DataEggs/user_region.rds")</span></span>
<span id="cb58-74"><a href="#cb58-74" aria-hidden="true" tabindex="-1"></a><span class="in">projection_grid_UTM &lt;- add_utm_columns(projection_grid, c("Lon", "Lat"), ll_crs = 4326, units = "km")</span></span>
<span id="cb58-75"><a href="#cb58-75" aria-hidden="true" tabindex="-1"></a><span class="in">plot(projection_grid_UTM$X,projection_grid_UTM$Y)</span></span>
<span id="cb58-76"><a href="#cb58-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-77"><a href="#cb58-77" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-78"><a href="#cb58-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-79"><a href="#cb58-79" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-80"><a href="#cb58-80" aria-hidden="true" tabindex="-1"></a><span class="in">grid_yrs &lt;- replicate_df(projection_grid_UTM, c("Year"), as.factor(unique(data.eggs$Year))) %&gt;%</span></span>
<span id="cb58-81"><a href="#cb58-81" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(time=as.integer(Year))</span></span>
<span id="cb58-82"><a href="#cb58-82" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-83"><a href="#cb58-83" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create the mesh</span></span>
<span id="cb58-84"><a href="#cb58-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-85"><a href="#cb58-85" aria-hidden="true" tabindex="-1"></a>In these kinds of models, the spatial (ω~s~) and the spatiotemporal (ε~s,t~) variations (and potentially any spatial varying coefficient) are modeled as Gaussian Random Fields (GRF), where the random effects describing the spatial patterns are assumed to be drawn from a multivariate normal distribution MVNormal (0,Σ). Estimating this covariance matrix (Σ) is computational demanding, so the SPDE approach is used to approximate the Gaussian random fields.</span>
<span id="cb58-86"><a href="#cb58-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-87"><a href="#cb58-87" aria-hidden="true" tabindex="-1"></a>For the SPDE approximation approach you need another grid called the **mesh** which is a triangulated mesh with Knots. These Knots are used to approximate the spatial variability in your data and because the number of Knots <span class="sc">\&lt;\&lt;</span> number of data points the computation of the covariance is easier. The Matern correlation is used as a covariance function to account for spatial autocorrelation.</span>
<span id="cb58-88"><a href="#cb58-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-89"><a href="#cb58-89" aria-hidden="true" tabindex="-1"></a>*Maybe more discussion in how you contract the mesh (ex. who many Knots you need)*</span>
<span id="cb58-90"><a href="#cb58-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-91"><a href="#cb58-91" aria-hidden="true" tabindex="-1"></a>So, so far we have three grids with different spatial resolution :</span>
<span id="cb58-92"><a href="#cb58-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-93"><a href="#cb58-93" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The data grid (your sampling points, those data are used to estimate fixed parameres)</span>
<span id="cb58-94"><a href="#cb58-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-95"><a href="#cb58-95" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The mesh (for the Gaussian Random Fields approximation)</span>
<span id="cb58-96"><a href="#cb58-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-97"><a href="#cb58-97" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The prediction grid ( for predictions using your final model).</span>
<span id="cb58-98"><a href="#cb58-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-99"><a href="#cb58-99" aria-hidden="true" tabindex="-1"></a>    So the mesh is:</span>
<span id="cb58-100"><a href="#cb58-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-101"><a href="#cb58-101" aria-hidden="true" tabindex="-1"></a><span class="in">```{r warning=FALSE}</span></span>
<span id="cb58-102"><a href="#cb58-102" aria-hidden="true" tabindex="-1"></a><span class="in">mesh &lt;- make_mesh(data.eggs, xy_cols = c("X", "Y"), cutoff = 30)  # cutoff: minimum distance between knots before a new mesh vertex is added- units as in your dataset</span></span>
<span id="cb58-103"><a href="#cb58-103" aria-hidden="true" tabindex="-1"></a><span class="in">plot(mesh)                                                     </span></span>
<span id="cb58-104"><a href="#cb58-104" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-105"><a href="#cb58-105" aria-hidden="true" tabindex="-1"></a><span class="fu">## MODEL 1 (m~1~) : Spatial model (non spatio-temporal term)</span></span>
<span id="cb58-106"><a href="#cb58-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-107"><a href="#cb58-107" aria-hidden="true" tabindex="-1"></a>The first model (m~1~) follows that formula:</span>
<span id="cb58-108"><a href="#cb58-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-109"><a href="#cb58-109" aria-hidden="true" tabindex="-1"></a>μ~s,t~= exp(β~t~+ ω~s~),</span>
<span id="cb58-110"><a href="#cb58-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-111"><a href="#cb58-111" aria-hidden="true" tabindex="-1"></a>μ~s,t~= log(y~s,t~ ),</span>
<span id="cb58-112"><a href="#cb58-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-113"><a href="#cb58-113" aria-hidden="true" tabindex="-1"></a>y~s,t~ \~ Tweedie (μ~s,t~ ,p, φ) , ω\~ MVNormal (0,Σ~ω~)</span>
<span id="cb58-114"><a href="#cb58-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-115"><a href="#cb58-115" aria-hidden="true" tabindex="-1"></a>where the modeled egg density (μ~s,t~) follows the Tweedie distribution with a log link function, as egg density is positive, continuous and contains zeros.</span>
<span id="cb58-116"><a href="#cb58-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-117"><a href="#cb58-117" aria-hidden="true" tabindex="-1"></a>y~s,t~ represents eggs density (no of eggs/10m^2^) at space (s) and time(t), μ is the mean density at time and space and p, φ represent power and dispersion parameters of the Tweedie distribution, respectively.</span>
<span id="cb58-118"><a href="#cb58-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-119"><a href="#cb58-119" aria-hidden="true" tabindex="-1"></a>β~t~ are the fixed effects for factor(Year), they represent the average temporal variation</span>
<span id="cb58-120"><a href="#cb58-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-121"><a href="#cb58-121" aria-hidden="true" tabindex="-1"></a>ω~s~ is the spatial random effect, drawn from a GRF with covarianvce matrix Σ~ω~ using Maretn correlation function. It represents the average spatial pattern (nich effect) and it also accounts for spatial variation that is not accounted for by our fixed effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting biomass density but are not accounted for in the model.</span>
<span id="cb58-122"><a href="#cb58-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-123"><a href="#cb58-123" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fit the model</span></span>
<span id="cb58-124"><a href="#cb58-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-125"><a href="#cb58-125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-126"><a href="#cb58-126" aria-hidden="true" tabindex="-1"></a><span class="in">fit_m1 &lt;- sdmTMB(</span></span>
<span id="cb58-127"><a href="#cb58-127" aria-hidden="true" tabindex="-1"></a><span class="in">  Ee10m3 ~ 0 + Year,</span></span>
<span id="cb58-128"><a href="#cb58-128" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data.eggs,</span></span>
<span id="cb58-129"><a href="#cb58-129" aria-hidden="true" tabindex="-1"></a><span class="in">  mesh = mesh,</span></span>
<span id="cb58-130"><a href="#cb58-130" aria-hidden="true" tabindex="-1"></a><span class="in">  family = tweedie(link = "log"),</span></span>
<span id="cb58-131"><a href="#cb58-131" aria-hidden="true" tabindex="-1"></a><span class="in">  spatial = "on"</span></span>
<span id="cb58-132"><a href="#cb58-132" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb58-133"><a href="#cb58-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-134"><a href="#cb58-134" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-135"><a href="#cb58-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-136"><a href="#cb58-136" aria-hidden="true" tabindex="-1"></a><span class="fu">### Results of the fit</span></span>
<span id="cb58-137"><a href="#cb58-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-138"><a href="#cb58-138" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-139"><a href="#cb58-139" aria-hidden="true" tabindex="-1"></a><span class="in">fit_m1  </span></span>
<span id="cb58-140"><a href="#cb58-140" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-141"><a href="#cb58-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-142"><a href="#cb58-142" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Confidence intervals of fixed effects</span></span>
<span id="cb58-143"><a href="#cb58-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-144"><a href="#cb58-144" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-145"><a href="#cb58-145" aria-hidden="true" tabindex="-1"></a><span class="in">fix_effects&lt;- tidy(fit_m1, conf.int = TRUE)</span></span>
<span id="cb58-146"><a href="#cb58-146" aria-hidden="true" tabindex="-1"></a><span class="in">fix_effects</span></span>
<span id="cb58-147"><a href="#cb58-147" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-148"><a href="#cb58-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-149"><a href="#cb58-149" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Confidence intervals of random effect and variance parameters</span></span>
<span id="cb58-150"><a href="#cb58-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-151"><a href="#cb58-151" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-152"><a href="#cb58-152" aria-hidden="true" tabindex="-1"></a><span class="in">random_effects&lt;- tidy(fit_m1, effects = "ran_pars", conf.int = TRUE)</span></span>
<span id="cb58-153"><a href="#cb58-153" aria-hidden="true" tabindex="-1"></a><span class="in">random_effects</span></span>
<span id="cb58-154"><a href="#cb58-154" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-155"><a href="#cb58-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-156"><a href="#cb58-156" aria-hidden="true" tabindex="-1"></a>Other than the effect of the spatial random field you have: :</span>
<span id="cb58-157"><a href="#cb58-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-158"><a href="#cb58-158" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Matérn range: the distance at witch you have no correlation - similar to the variogram range</span>
<span id="cb58-159"><a href="#cb58-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-160"><a href="#cb58-160" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>phi (φ) &amp; tweedie_p (p): the dispersion parameter and the power of the Tweedie distribution, respectively.</span>
<span id="cb58-161"><a href="#cb58-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-162"><a href="#cb58-162" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Plot the all the effects</span></span>
<span id="cb58-163"><a href="#cb58-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-164"><a href="#cb58-164" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-165"><a href="#cb58-165" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb58-166"><a href="#cb58-166" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = fix_effects, aes(x = estimate, y = term, col = term)) + </span></span>
<span id="cb58-167"><a href="#cb58-167" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(data = fix_effects, aes(y = term, xmin = conf.low, xmax = conf.high, color = term), width = 0.2) +  </span></span>
<span id="cb58-168"><a href="#cb58-168" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = random_effects %&gt;% filter(term == "sigma_O"), aes(x = estimate, y = term)) +  </span></span>
<span id="cb58-169"><a href="#cb58-169" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(data = random_effects %&gt;% filter(term == "sigma_O"), aes(y = term, xmin = conf.low, xmax = conf.high), width = 0.2) +  </span></span>
<span id="cb58-170"><a href="#cb58-170" aria-hidden="true" tabindex="-1"></a><span class="in">  labs( title = expression("Mean and 95% confidence intervals of the fixed &amp; random effects," ~ m[1]),       </span></span>
<span id="cb58-171"><a href="#cb58-171" aria-hidden="true" tabindex="-1"></a><span class="in">        subtitle = expression(mu[s~t] ~ "=" ~ exp(beta[t] + omega[s]))) +</span></span>
<span id="cb58-172"><a href="#cb58-172" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw() +</span></span>
<span id="cb58-173"><a href="#cb58-173" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "none")</span></span>
<span id="cb58-174"><a href="#cb58-174" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-175"><a href="#cb58-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-176"><a href="#cb58-176" aria-hidden="true" tabindex="-1"></a>You can see that the effect of spatial term is the most "important" one. Space is the more influential parameter in egg distribution in this model.</span>
<span id="cb58-177"><a href="#cb58-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-178"><a href="#cb58-178" aria-hidden="true" tabindex="-1"></a><span class="fu">### Diagnostics</span></span>
<span id="cb58-179"><a href="#cb58-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-180"><a href="#cb58-180" aria-hidden="true" tabindex="-1"></a>What do you check?</span>
<span id="cb58-181"><a href="#cb58-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-182"><a href="#cb58-182" aria-hidden="true" tabindex="-1"></a>Residuals?</span>
<span id="cb58-183"><a href="#cb58-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-184"><a href="#cb58-184" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-185"><a href="#cb58-185" aria-hidden="true" tabindex="-1"></a><span class="in">sanity(fit_m1)</span></span>
<span id="cb58-186"><a href="#cb58-186" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-187"><a href="#cb58-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-188"><a href="#cb58-188" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prediction</span></span>
<span id="cb58-189"><a href="#cb58-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-190"><a href="#cb58-190" aria-hidden="true" tabindex="-1"></a>You now perform a prediction in you prediction grid using the fitted model m~1~. When you visualize your prediction in a map you can visualize your final prediction your model (eg. the estimated number of eggs) or you can visualize separately each part of the decomposition (the effect of the fixed covariates and the effect of the random fields (ω~s~, ε~s,t~) and see what is going on.</span>
<span id="cb58-191"><a href="#cb58-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-192"><a href="#cb58-192" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-193"><a href="#cb58-193" aria-hidden="true" tabindex="-1"></a><span class="in">#Predict in the prediction grid that has been created above</span></span>
<span id="cb58-194"><a href="#cb58-194" aria-hidden="true" tabindex="-1"></a><span class="in">p_m1 &lt;- predict(fit_m1, newdata = grid_yrs)</span></span>
<span id="cb58-195"><a href="#cb58-195" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-196"><a href="#cb58-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-197"><a href="#cb58-197" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Full (fixed and random effects) model m~1~ prediction</span></span>
<span id="cb58-198"><a href="#cb58-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-199"><a href="#cb58-199" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-200"><a href="#cb58-200" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m1 &lt;- ggplot(data=p_m1, aes(X, Y, fill = exp(est))) + </span></span>
<span id="cb58-201"><a href="#cb58-201" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() + facet_wrap(vars(Year)) +</span></span>
<span id="cb58-202"><a href="#cb58-202" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb58-203"><a href="#cb58-203" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (fixed effects +  random effects) based on full m1",</span></span>
<span id="cb58-204"><a href="#cb58-204" aria-hidden="true" tabindex="-1"></a><span class="in">subtitle = expression("The estimated density of eggs " * log(mu[st]) * ": " * mu[st] == exp(beta[t] + omega[s])))</span></span>
<span id="cb58-205"><a href="#cb58-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-206"><a href="#cb58-206" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m1</span></span>
<span id="cb58-207"><a href="#cb58-207" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-208"><a href="#cb58-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-209"><a href="#cb58-209" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fixed effect in the of prediction model m~1~</span></span>
<span id="cb58-210"><a href="#cb58-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-211"><a href="#cb58-211" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-212"><a href="#cb58-212" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m1 &lt;- ggplot(data=p_m1, aes(X, Y, fill = exp(est_non_rf))) + </span></span>
<span id="cb58-213"><a href="#cb58-213" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() + facet_wrap(vars(Year)) +</span></span>
<span id="cb58-214"><a href="#cb58-214" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb58-215"><a href="#cb58-215" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (fixed effects only) based on full m1",</span></span>
<span id="cb58-216"><a href="#cb58-216" aria-hidden="true" tabindex="-1"></a><span class="in">          subtitle = expression("The effect of time in the estimated variable " * (beta[t]) * ": " * mu[st] == exp(beta[t] + omega[s])))</span></span>
<span id="cb58-217"><a href="#cb58-217" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m1</span></span>
<span id="cb58-218"><a href="#cb58-218" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-219"><a href="#cb58-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-220"><a href="#cb58-220" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Random effect in the prediction of model m~1~</span></span>
<span id="cb58-221"><a href="#cb58-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-222"><a href="#cb58-222" aria-hidden="true" tabindex="-1"></a>Here spatial random effect only</span>
<span id="cb58-223"><a href="#cb58-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-224"><a href="#cb58-224" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-225"><a href="#cb58-225" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m1 &lt;- ggplot(data=p_m1, aes(X, Y, fill = exp(omega_s))) + </span></span>
<span id="cb58-226"><a href="#cb58-226" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() +</span></span>
<span id="cb58-227"><a href="#cb58-227" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb58-228"><a href="#cb58-228" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (random effects only) based on full m1",</span></span>
<span id="cb58-229"><a href="#cb58-229" aria-hidden="true" tabindex="-1"></a><span class="in">          subtitle = expression("The effect of space in the estimated variable " * (omega[s]) * ": " * mu[st] == exp(beta[t] + omega[s])))</span></span>
<span id="cb58-230"><a href="#cb58-230" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m1</span></span>
<span id="cb58-231"><a href="#cb58-231" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-232"><a href="#cb58-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-233"><a href="#cb58-233" aria-hidden="true" tabindex="-1"></a>For the ω~s~ we have only one map because the spatial effect is stable across time. This is the mean spatial effect estimated from your data and it also represents the mean spatial distribution. If you want to see if or how the spatial effect changes in time then you need a spatiotemporal random effect (see m~2~).</span>
<span id="cb58-234"><a href="#cb58-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-235"><a href="#cb58-235" aria-hidden="true" tabindex="-1"></a>This spatial random effect represents variance in space (but consistence through time) coming from the data that are not accounted by the fixed effects. In this model compared to m~1~ the spatial random effect is less influential because a part of the variability is now explained by the spatiotemporal effect term.</span>
<span id="cb58-236"><a href="#cb58-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-237"><a href="#cb58-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-238"><a href="#cb58-238" aria-hidden="true" tabindex="-1"></a><span class="fu">## MODEL 2 (m~2~) : Spatiotemporal model</span></span>
<span id="cb58-239"><a href="#cb58-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-240"><a href="#cb58-240" aria-hidden="true" tabindex="-1"></a>The 2^nd^ model (m~2~) follows that formula:</span>
<span id="cb58-241"><a href="#cb58-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-242"><a href="#cb58-242" aria-hidden="true" tabindex="-1"></a>μ~s,t~= exp(β~t~+ ω~s~ + ε~s,t~),</span>
<span id="cb58-243"><a href="#cb58-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-244"><a href="#cb58-244" aria-hidden="true" tabindex="-1"></a>μ~s,t~= log(y~s,t~ ),</span>
<span id="cb58-245"><a href="#cb58-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-246"><a href="#cb58-246" aria-hidden="true" tabindex="-1"></a>y~s,t~ \~ Tweedie (μ~s,t~ ,p, φ) , ω\~ MVNormal (0,Σ~ω~) , ε~t~ \~ MVNormal (0,Σ~t~)</span>
<span id="cb58-247"><a href="#cb58-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-248"><a href="#cb58-248" aria-hidden="true" tabindex="-1"></a>where the modeled egg density (μ~s,t~) follows the Tweedie distribution with a log link function, as egg density is positive, continuous and contains zeros.</span>
<span id="cb58-249"><a href="#cb58-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-250"><a href="#cb58-250" aria-hidden="true" tabindex="-1"></a>y~s,t~ represents eggs density (no of eggs/10m^2^) at space (s) and time(t), μ is the mean density at time and space and p, φ represent power and dispersion parameters of the Tweedie distribution, respectively.</span>
<span id="cb58-251"><a href="#cb58-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-252"><a href="#cb58-252" aria-hidden="true" tabindex="-1"></a>β~t~ are the fixed effects for factor(Year), they represent the average temporal variation</span>
<span id="cb58-253"><a href="#cb58-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-254"><a href="#cb58-254" aria-hidden="true" tabindex="-1"></a>ω~s~ is the spatial random effect, drawn from a GRF with covarianvce matrix Σ~ω~ using Maretn correlation function. It represents the average spatial pattern (nich effect) and it also accounts for spatial variation that is not accounted for by our fixed effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting biomass density but are not accounted for in the model.</span>
<span id="cb58-255"><a href="#cb58-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-256"><a href="#cb58-256" aria-hidden="true" tabindex="-1"></a>ε~s,t~ represents the spatiotemporal random effect, drawn from a GRF with covarianvce matrix Σ~ε~. They represents how the average spatial pattern change through year so they also for spatial variation that is not accounted for by our fixed effects and the spatial random effects. In other words, these deviations represent consistent biotic and abiotic factors that are affecting our study variable but are not accounted for in the model.</span>
<span id="cb58-257"><a href="#cb58-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-258"><a href="#cb58-258" aria-hidden="true" tabindex="-1"></a>In this model Spatiotemporal random fields are considered independent and identically distributed each single year (spatiotemporal = "IID") and Maretn correlation function to accounts for spatial autocorrelation.</span>
<span id="cb58-259"><a href="#cb58-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-260"><a href="#cb58-260" aria-hidden="true" tabindex="-1"></a>*Are there other options for spatiotemporal fields:*</span>
<span id="cb58-261"><a href="#cb58-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-262"><a href="#cb58-262" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*"AR1": first-order autoregressive (each random filed is correlated to the one of the previous year )*</span>
<span id="cb58-263"><a href="#cb58-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-264"><a href="#cb58-264" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*"RW": random walk (each random filed starts fro where it was last year plus a completely independent deviation)*</span>
<span id="cb58-265"><a href="#cb58-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-266"><a href="#cb58-266" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fit the model</span></span>
<span id="cb58-267"><a href="#cb58-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-268"><a href="#cb58-268" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-269"><a href="#cb58-269" aria-hidden="true" tabindex="-1"></a><span class="in">fit_m2 &lt;- sdmTMB(</span></span>
<span id="cb58-270"><a href="#cb58-270" aria-hidden="true" tabindex="-1"></a><span class="in">  Ee10m3 ~ 0 + Year,</span></span>
<span id="cb58-271"><a href="#cb58-271" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data.eggs,</span></span>
<span id="cb58-272"><a href="#cb58-272" aria-hidden="true" tabindex="-1"></a><span class="in">  mesh = mesh,</span></span>
<span id="cb58-273"><a href="#cb58-273" aria-hidden="true" tabindex="-1"></a><span class="in">  family = tweedie(link = "log"),</span></span>
<span id="cb58-274"><a href="#cb58-274" aria-hidden="true" tabindex="-1"></a><span class="in">  spatial = "on",</span></span>
<span id="cb58-275"><a href="#cb58-275" aria-hidden="true" tabindex="-1"></a><span class="in">  spatiotemporal = "IID",   </span></span>
<span id="cb58-276"><a href="#cb58-276" aria-hidden="true" tabindex="-1"></a><span class="in">  time = "time")</span></span>
<span id="cb58-277"><a href="#cb58-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-278"><a href="#cb58-278" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-279"><a href="#cb58-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-280"><a href="#cb58-280" aria-hidden="true" tabindex="-1"></a><span class="fu">### Results of the fit</span></span>
<span id="cb58-281"><a href="#cb58-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-282"><a href="#cb58-282" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-283"><a href="#cb58-283" aria-hidden="true" tabindex="-1"></a><span class="in">fit_m2</span></span>
<span id="cb58-284"><a href="#cb58-284" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-285"><a href="#cb58-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-286"><a href="#cb58-286" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Confidence intervals of fixed effects</span></span>
<span id="cb58-287"><a href="#cb58-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-288"><a href="#cb58-288" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-289"><a href="#cb58-289" aria-hidden="true" tabindex="-1"></a><span class="in">fix_effects&lt;- tidy(fit_m2, conf.int = TRUE)</span></span>
<span id="cb58-290"><a href="#cb58-290" aria-hidden="true" tabindex="-1"></a><span class="in">fix_effects</span></span>
<span id="cb58-291"><a href="#cb58-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-292"><a href="#cb58-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-293"><a href="#cb58-293" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Confidence intervals of random effects and variance parameters</span></span>
<span id="cb58-294"><a href="#cb58-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-295"><a href="#cb58-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-296"><a href="#cb58-296" aria-hidden="true" tabindex="-1"></a><span class="in">random_effects&lt;- tidy(fit_m2, effects = "ran_pars", conf.int = TRUE)</span></span>
<span id="cb58-297"><a href="#cb58-297" aria-hidden="true" tabindex="-1"></a><span class="in">random_effects</span></span>
<span id="cb58-298"><a href="#cb58-298" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-299"><a href="#cb58-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-300"><a href="#cb58-300" aria-hidden="true" tabindex="-1"></a>Other than the effect of the spatial random (sigma_O) and the spatiotemporal random field (sigma_E) field you have: :</span>
<span id="cb58-301"><a href="#cb58-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-302"><a href="#cb58-302" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Matérn range: the distance at witch you have no correlation - similar to the variogram range</span>
<span id="cb58-303"><a href="#cb58-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-304"><a href="#cb58-304" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>phi (φ) &amp; tweedie_p (p): the dispersion parameter and the power of the Tweedie distribution, respectively.</span>
<span id="cb58-305"><a href="#cb58-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-306"><a href="#cb58-306" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Plot the all the effects</span></span>
<span id="cb58-307"><a href="#cb58-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-308"><a href="#cb58-308" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-309"><a href="#cb58-309" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb58-310"><a href="#cb58-310" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = fix_effects, aes(x = estimate, y = term, col = term)) + </span></span>
<span id="cb58-311"><a href="#cb58-311" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(data = fix_effects, aes(y = term, xmin = conf.low, xmax = conf.high, color = term), width = 0.2) +  </span></span>
<span id="cb58-312"><a href="#cb58-312" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data = random_effects %&gt;% filter(term == c("sigma_O","sigma_E")), aes(x = estimate, y = term)) +  </span></span>
<span id="cb58-313"><a href="#cb58-313" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(data = random_effects %&gt;% filter(term == c("sigma_O","sigma_E")), aes(y = term, xmin = conf.low, xmax = conf.high), width = 0.2) +  </span></span>
<span id="cb58-314"><a href="#cb58-314" aria-hidden="true" tabindex="-1"></a><span class="in">  labs( title = expression("Mean and 95% confidence intervals of the fixed &amp; random effects," ~ m[2]),       </span></span>
<span id="cb58-315"><a href="#cb58-315" aria-hidden="true" tabindex="-1"></a><span class="in">        subtitle = expression(mu[s~t] ~ "=" ~ exp(beta[t] + omega[s] +epsilon[st]))) +</span></span>
<span id="cb58-316"><a href="#cb58-316" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw() +</span></span>
<span id="cb58-317"><a href="#cb58-317" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position = "none")</span></span>
<span id="cb58-318"><a href="#cb58-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-319"><a href="#cb58-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-320"><a href="#cb58-320" aria-hidden="true" tabindex="-1"></a>You can see that the effect of spatial term is steal the most "important" one. But a lot of is effect is now explained by the spatiotemporal effect.</span>
<span id="cb58-321"><a href="#cb58-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-322"><a href="#cb58-322" aria-hidden="true" tabindex="-1"></a><span class="fu">### Diagnostics</span></span>
<span id="cb58-323"><a href="#cb58-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-324"><a href="#cb58-324" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-325"><a href="#cb58-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-326"><a href="#cb58-326" aria-hidden="true" tabindex="-1"></a><span class="in">sanity(fit_m2)</span></span>
<span id="cb58-327"><a href="#cb58-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-328"><a href="#cb58-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-329"><a href="#cb58-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-330"><a href="#cb58-330" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prediction</span></span>
<span id="cb58-331"><a href="#cb58-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-332"><a href="#cb58-332" aria-hidden="true" tabindex="-1"></a>You can steel predict in the same grid as m~1~ as no more covariates have been added to the model.</span>
<span id="cb58-333"><a href="#cb58-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-334"><a href="#cb58-334" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-335"><a href="#cb58-335" aria-hidden="true" tabindex="-1"></a><span class="in">p_m2 &lt;- predict(fit_m2, newdata = grid_yrs)</span></span>
<span id="cb58-336"><a href="#cb58-336" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-337"><a href="#cb58-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-338"><a href="#cb58-338" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Full (fixed and random effects) model m~2~ prediction</span></span>
<span id="cb58-339"><a href="#cb58-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-340"><a href="#cb58-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-341"><a href="#cb58-341" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2 &lt;- ggplot(data=p_m2, aes(X, Y, fill = exp(est))) + </span></span>
<span id="cb58-342"><a href="#cb58-342" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() + facet_wrap(vars(Year)) +</span></span>
<span id="cb58-343"><a href="#cb58-343" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb58-344"><a href="#cb58-344" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (fixed effects +  random effects) based on full m2",</span></span>
<span id="cb58-345"><a href="#cb58-345" aria-hidden="true" tabindex="-1"></a><span class="in">subtitle = expression("The estimated density of eggs " * log(mu[st]) * ": " * mu[st] == exp(beta[t] + omega[s]+ epsilon[st])))</span></span>
<span id="cb58-346"><a href="#cb58-346" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2</span></span>
<span id="cb58-347"><a href="#cb58-347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-348"><a href="#cb58-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-349"><a href="#cb58-349" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fixed effect in the prediction of model m~2~</span></span>
<span id="cb58-350"><a href="#cb58-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-351"><a href="#cb58-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-352"><a href="#cb58-352" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2 &lt;- ggplot(data=p_m2, aes(X, Y, fill = exp(est_non_rf))) + </span></span>
<span id="cb58-353"><a href="#cb58-353" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() + facet_wrap(vars(Year)) +</span></span>
<span id="cb58-354"><a href="#cb58-354" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb58-355"><a href="#cb58-355" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (fixed effects only) based on full m2",</span></span>
<span id="cb58-356"><a href="#cb58-356" aria-hidden="true" tabindex="-1"></a><span class="in">          subtitle = expression("The effect of time in the estimated variable " * (beta[t]) * ": " * mu[st] == exp(beta[t] + omega[s]+ epsilon[st])))</span></span>
<span id="cb58-357"><a href="#cb58-357" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2</span></span>
<span id="cb58-358"><a href="#cb58-358" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-359"><a href="#cb58-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-360"><a href="#cb58-360" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Random effects in the prediction of model m~2~</span></span>
<span id="cb58-361"><a href="#cb58-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-362"><a href="#cb58-362" aria-hidden="true" tabindex="-1"></a>Here spatial &amp; spatiotemporal random effects</span>
<span id="cb58-363"><a href="#cb58-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-364"><a href="#cb58-364" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Plot the spatial random effect</span></span>
<span id="cb58-365"><a href="#cb58-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-366"><a href="#cb58-366" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-367"><a href="#cb58-367" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2 &lt;- ggplot(data=p_m2, aes(X, Y, fill = exp(omega_s))) + </span></span>
<span id="cb58-368"><a href="#cb58-368" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() +</span></span>
<span id="cb58-369"><a href="#cb58-369" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb58-370"><a href="#cb58-370" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (spatial random effect) based on full m2",</span></span>
<span id="cb58-371"><a href="#cb58-371" aria-hidden="true" tabindex="-1"></a><span class="in">          subtitle = expression("The effect of space in the estimated variable " * (omega[s]) * ": " * mu[st] == exp(beta[t] + omega[s] + epsilon[st])))</span></span>
<span id="cb58-372"><a href="#cb58-372" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2</span></span>
<span id="cb58-373"><a href="#cb58-373" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-374"><a href="#cb58-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-375"><a href="#cb58-375" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Plot the spatotemporal random effect</span></span>
<span id="cb58-376"><a href="#cb58-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-377"><a href="#cb58-377" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=F}</span></span>
<span id="cb58-378"><a href="#cb58-378" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2 &lt;- ggplot(data=p_m2, aes(X, Y, fill = exp(epsilon_st))) + </span></span>
<span id="cb58-379"><a href="#cb58-379" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_raster() +</span></span>
<span id="cb58-380"><a href="#cb58-380" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(vars(Year)) +</span></span>
<span id="cb58-381"><a href="#cb58-381" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(trans = "log")+ </span></span>
<span id="cb58-382"><a href="#cb58-382" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Prediction (spatiotemporal random effect) based on full m2",</span></span>
<span id="cb58-383"><a href="#cb58-383" aria-hidden="true" tabindex="-1"></a><span class="in">          subtitle = expression("The effect of space through time in the estimated variable " * (epsilon[st]) * ": " * mu[st] == exp(beta[t] + omega[s] + epsilon[st])))</span></span>
<span id="cb58-384"><a href="#cb58-384" aria-hidden="true" tabindex="-1"></a><span class="in">plot_m2</span></span>
<span id="cb58-385"><a href="#cb58-385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb58-386"><a href="#cb58-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-387"><a href="#cb58-387" aria-hidden="true" tabindex="-1"></a>The spatiptempral random effect represent deviation from the fixed effect predictions and the spatial random effect deviations. These represent changes in the spatial paternal through time that are forced by parameters not accounted for in the model.</span>
<span id="cb58-388"><a href="#cb58-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-389"><a href="#cb58-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-390"><a href="#cb58-390" aria-hidden="true" tabindex="-1"></a> </span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>